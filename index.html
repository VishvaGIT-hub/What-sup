<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    <title>What's Up - Chat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --white: #FFFFFF;
            --black: #000000;
            --primary-text: #262626;
            --secondary-text: #737373;
            --tertiary-text: #A3A3A3;
            --border-light: #E5E5E5;
            --background-light: #FAFAFA;
            --hover-gray: #F5F5F5;
            --gradient-pink: #F56040;
            --gradient-purple: #C13584;
            --gradient-deep-purple: #833AB4;
            --gradient-blue: #5851DB;
            --accent-gradient: linear-gradient(135deg, #F56040 0%, #C13584 50%, #833AB4 100%);
            --message-sent: #3797F0;
            --message-received: #EFEFEF;
            --online-green: #22C55E;
            --error-red: #EF4444;
            --link-blue: #0095F6;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --top-bar-height: 44px;
            --input-bar-height: 52px;
            --sidebar-width: 280px;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="dark"] {
            --white: #000000;
            --black: #FFFFFF;
            --primary-text: #F5F5F5;
            --secondary-text: #A3A3A3;
            --tertiary-text: #525252;
            --border-light: #262626;
            --background-light: #121212;
            --hover-gray: #1A1A1A;
            --message-sent: #3797F0;
            --message-received: #262626;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--white);
            color: var(--primary-text);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            user-select: none;
            transition: background 0.3s, color 0.3s;
        }
        .app {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        /* ==================== SCREEN SYSTEM ==================== */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--white);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s var(--ease-out), transform 0.3s var(--ease-out);
            will-change: transform, opacity;
        }
        .screen.active {
            display: flex;
            opacity: 1;
            transform: translateX(0);
            z-index: 1;
        }
        .screen.home-screen.active {
            z-index: 2;
        }
        .screen.search-screen.active,
        .screen.requests-screen.active {
            z-index: 10;
        }
        .screen.chat-screen.active {
            z-index: 15;
        }
        .screen.profile-screen.active,
        .screen.settings-screen.active {
            z-index: 20;
        }
        /* ==================== MODERN SIDEBAR ==================== */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s var(--ease-out), visibility 0.3s;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            max-width: 85vw;
            height: 100%;
            background: var(--white);
            z-index: 999;
            transform: translateX(-100%);
            transition: transform 0.35s var(--ease-out);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }
        .sidebar.active {
            transform: translateX(0);
            box-shadow: 20px 0 60px rgba(0, 0, 0, 0.15);
        }
        .sidebar-header {
            padding: calc(var(--safe-area-top) + 16px) 16px 16px;
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
        }
        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--background-light);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-profile:active {
            transform: scale(0.98);
            background: var(--hover-gray);
        }
        .sidebar-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--border-light);
            flex-shrink: 0;
            position: relative;
        }
        .sidebar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sidebar-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid var(--white);
            border-radius: 50%;
        }
        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }
        .sidebar-username {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sidebar-email {
            font-size: 12px;
            color: var(--secondary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 1px;
        }
        .sidebar-profile-arrow {
            font-size: 18px !important;
            color: var(--tertiary-text);
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .sidebar-content::-webkit-scrollbar {
            display: none;
        }
        .sidebar-section {
            margin-bottom: 4px;
        }
        .sidebar-section-title {
            padding: 12px 12px 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--tertiary-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            margin-bottom: 2px;
        }
        .sidebar-item:active {
            transform: scale(0.98);
            background: var(--hover-gray);
        }
        .sidebar-item:hover {
            background: var(--hover-gray);
        }
        .sidebar-item-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: var(--background-light);
        }
        .sidebar-item-icon .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }
        .sidebar-item-icon.accent {
            background: var(--accent-gradient);
        }
        .sidebar-item-icon.accent .material-icons-round {
            color: white;
        }
        .sidebar-item-icon.blue {
            background: var(--link-blue);
        }
        .sidebar-item-icon.blue .material-icons-round {
            color: white;
        }
        .sidebar-item-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-text);
        }
        .sidebar-item-badge {
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            background: var(--error-red);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-item.danger .sidebar-item-icon {
            background: rgba(239, 68, 68, 0.1);
        }
        .sidebar-item.danger .sidebar-item-icon .material-icons-round {
            color: var(--error-red);
        }
        .sidebar-item.danger .sidebar-item-text {
            color: var(--error-red);
        }
        .sidebar-divider {
            height: 1px;
            background: var(--border-light);
            margin: 8px 12px;
        }
        .sidebar-footer {
            padding: 12px 16px calc(var(--safe-area-bottom) + 12px);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-footer-text {
            font-size: 11px;
            color: var(--tertiary-text);
        }
        .sidebar-theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--background-light);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-theme-toggle:active {
            transform: scale(0.9);
        }
        .sidebar-theme-toggle .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }
        /* ==================== AUTH SCREEN ==================== */
        .auth-screen {
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            background: var(--white);
        }
        .auth-logo {
            width: 80px;
            height: 80px;
            background: var(--accent-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(193, 53, 132, 0.3);
        }
        .auth-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .auth-subtitle {
            font-size: 14px;
            color: var(--secondary-text);
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.5;
            max-width: 280px;
        }
        .google-btn {
            width: 100%;
            max-width: 280px;
            height: 44px;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--primary-text);
        }
        .google-btn:active {
            transform: scale(0.98);
            background: var(--hover-gray);
        }
        .google-icon {
            width: 18px;
            height: 18px;
        }
        /* ==================== USERNAME SCREEN ==================== */
        .username-screen {
            padding: calc(var(--safe-area-top) + 20px) 20px 20px;
        }
        .username-header {
            margin-bottom: 24px;
        }
        .username-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }
        .username-subtitle {
            font-size: 13px;
            color: var(--secondary-text);
            line-height: 1.4;
        }
        .username-input-wrapper {
            position: relative;
            margin-bottom: 16px;
        }
        .username-input {
            width: 100%;
            height: 44px;
            padding: 0 44px 0 14px;
            background: var(--background-light);
            border: 1.5px solid var(--border-light);
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
            color: var(--primary-text);
        }
        .username-input:focus {
            border-color: var(--link-blue);
            background: var(--white);
        }
        .username-status {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }
        .username-status .material-icons-round {
            font-size: 20px;
        }
        .username-status.available .material-icons-round {
            color: var(--online-green);
        }
        .username-status.taken .material-icons-round {
            color: var(--error-red);
        }
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-light);
            border-top-color: var(--link-blue);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .username-suggestions {
            margin-bottom: 24px;
        }
        .suggestions-label {
            font-size: 12px;
            color: var(--secondary-text);
            margin-bottom: 10px;
            font-weight: 500;
        }
        .suggestions-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .suggestion-chip {
            padding: 8px 14px;
            background: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: 18px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--primary-text);
        }
        .suggestion-chip:active {
            transform: scale(0.95);
            background: var(--hover-gray);
        }
        .username-continue-btn {
            width: 100%;
            height: 44px;
            background: var(--link-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.4;
            pointer-events: none;
        }
        .username-continue-btn.enabled {
            opacity: 1;
            pointer-events: auto;
        }
        .username-continue-btn.enabled:active {
            transform: scale(0.98);
        }
        /* ==================== TOP BAR ==================== */
        .top-bar {
            height: calc(var(--top-bar-height) + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--white);
            border-bottom: 0.5px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 4px;
            padding-right: 4px;
            flex-shrink: 0;
        }
        .top-bar-left {
            display: flex;
            align-items: center;
        }
        .app-name-btn {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 8px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .app-name-btn:active {
            background: var(--hover-gray);
        }
        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-text);
            letter-spacing: -0.5px;
        }
        .app-name-btn .material-icons-round {
            font-size: 18px;
            color: var(--secondary-text);
            transition: transform 0.2s;
        }
        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .icon-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        .icon-btn:active {
            background: var(--hover-gray);
            transform: scale(0.92);
        }
        .icon-btn .material-icons-round {
            font-size: 24px;
            color: var(--primary-text);
        }
        .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--error-red);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ==================== CHAT LIST ==================== */
        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .chat-list-container::-webkit-scrollbar {
            display: none;
        }
        .pinned-section {
            background: var(--background-light);
        }
        .section-header {
            padding: 10px 16px 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .section-header .material-icons-round {
            font-size: 14px;
        }
        .chat-item {
            height: 64px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
            background: var(--white);
            position: relative;
        }
        .chat-item:active {
            background: var(--hover-gray);
        }
        .chat-item.pinned {
            background: var(--background-light);
        }
        .chat-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 72px;
            right: 16px;
            height: 0.5px;
            background: var(--border-light);
        }
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--background-light);
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .online-dot {
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid var(--white);
            border-radius: 50%;
        }
        .chat-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 3px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-username {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pin-icon {
            font-size: 12px !important;
            color: var(--secondary-text);
            transform: rotate(45deg);
        }
        .chat-time {
            font-size: 11px;
            color: var(--secondary-text);
            flex-shrink: 0;
        }
        .chat-preview {
            font-size: 13px;
            color: var(--secondary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chat-preview span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .unread-badge {
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--link-blue);
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .muted-badge {
            background: var(--secondary-text);
        }
        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            text-align: center;
        }
        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .empty-icon .material-icons-round {
            font-size: 36px;
            color: var(--tertiary-text);
        }
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--primary-text);
        }
        .empty-text {
            font-size: 13px;
            color: var(--secondary-text);
            line-height: 1.4;
        }
        /* ==================== FAB ==================== */
        .fab {
            position: fixed;
            bottom: calc(20px + var(--safe-area-bottom));
            right: 16px;
            width: 52px;
            height: 52px;
            background: var(--accent-gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(193, 53, 132, 0.35);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
            border: none;
        }
        .fab:active {
            transform: scale(0.92);
        }
        .fab .material-icons-round {
            font-size: 26px;
            color: white;
        }
        .profile-fab {
            bottom: calc(80px + var(--safe-area-bottom));
            width: 44px;
            height: 44px;
            background: var(--white);
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
            border: 1px solid var(--border-light);
        }
        .profile-fab .material-icons-round {
            font-size: 22px;
            color: var(--primary-text);
        }
        /* ==================== SEARCH SCREEN ==================== */
        .search-header {
            height: calc(52px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--white);
            border-bottom: 0.5px solid var(--border-light);
            display: flex;
            align-items: center;
            padding-left: 4px;
            padding-right: 12px;
            gap: 8px;
            flex-shrink: 0;
        }
        .back-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }
        .back-btn:active {
            background: var(--hover-gray);
            transform: scale(0.92);
        }
        .back-btn .material-icons-round {
            font-size: 24px;
            color: var(--primary-text);
        }
        .search-input-wrapper {
            flex: 1;
            position: relative;
        }
        .search-input {
            width: 100%;
            height: 36px;
            padding: 0 14px;
            background: var(--background-light);
            border: none;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            color: var(--primary-text);
        }
        .search-input::placeholder {
            color: var(--tertiary-text);
        }
        .search-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .search-section {
            padding: 12px 0;
        }
        .search-section-title {
            font-size: 13px;
            font-weight: 600;
            padding: 0 16px 8px;
            color: var(--primary-text);
        }
        .user-item {
            height: 56px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-item:active {
            background: var(--hover-gray);
        }
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--background-light);
            flex-shrink: 0;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-info {
            flex: 1;
            min-width: 0;
        }
        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .user-username {
            font-size: 12px;
            color: var(--secondary-text);
        }
        .send-request-btn {
            padding: 7px 14px;
            background: var(--link-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .send-request-btn:active {
            transform: scale(0.95);
        }
        .send-request-btn.pending {
            background: var(--background-light);
            color: var(--secondary-text);
        }
        /* ==================== REQUESTS SCREEN ==================== */
        .request-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .request-content {
            flex: 1;
            min-width: 0;
        }
        .request-text {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 2px;
        }
        .request-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .request-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .request-btn.accept {
            background: var(--link-blue);
            color: white;
        }
        .request-btn.decline {
            background: var(--background-light);
            color: var(--primary-text);
        }
        .request-btn:active {
            transform: scale(0.95);
        }
        /* ==================== CHAT SCREEN ==================== */
        .chat-top-bar {
            height: calc(52px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--white);
            border-bottom: 0.5px solid var(--border-light);
            display: flex;
            align-items: center;
            padding-left: 4px;
            padding-right: 4px;
            gap: 6px;
            flex-shrink: 0;
        }
        .chat-user-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .chat-user-info:active {
            background: var(--hover-gray);
        }
        .chat-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--background-light);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        .chat-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-user-avatar .online-dot {
            width: 10px;
            height: 10px;
            border-width: 1.5px;
        }
        .chat-user-details {
            flex: 1;
            min-width: 0;
        }
        .chat-user-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-user-status {
            font-size: 11px;
            color: var(--secondary-text);
        }
        .typing-text {
            color: var(--link-blue);
            font-weight: 500;
        }
        .chat-actions {
            display: flex;
            gap: 2px;
        }
        /* ==================== MESSAGES ==================== */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            -webkit-overflow-scrolling: touch;
            background: var(--white);
        }
        .messages-container::-webkit-scrollbar {
            display: none;
        }
        .date-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px 0;
        }
        .date-label {
            padding: 4px 10px;
            background: var(--hover-gray);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            color: var(--secondary-text);
        }
        .message {
            display: flex;
            gap: 6px;
            max-width: 75%;
            animation: messageIn 0.2s var(--ease-out);
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(8px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message.sent {
            flex-direction: row-reverse;
            align-self: flex-end;
        }
        .message.received {
            align-self: flex-start;
        }
        .message-bubble {
            max-width: 100%;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.35;
            word-wrap: break-word;
            position: relative;
        }
        .message.received .message-bubble {
            background: var(--message-received);
            color: var(--primary-text);
            border-bottom-left-radius: 6px;
        }
        .message.sent .message-bubble {
            background: var(--message-sent);
            color: white;
            border-bottom-right-radius: 6px;
        }
        .message-text {
            white-space: pre-wrap;
        }
        .message-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
            margin-top: 2px;
        }
        .message-time {
            font-size: 10px;
            opacity: 0.65;
        }
        .message-status .material-icons-round {
            font-size: 14px;
            opacity: 0.65;
        }
        .message-status.read .material-icons-round {
            color: #34B7F1;
            opacity: 1;
        }
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-top: 4px;
        }
        .reaction {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
        }
        .message.sent .reaction {
            background: rgba(255,255,255,0.2);
        }
        .reaction-emoji {
            font-size: 12px;
        }
        .reaction-count {
            font-size: 10px;
            opacity: 0.7;
        }
        /* Reply Preview in Message */
        .reply-preview-inline {
            padding: 6px 8px;
            background: rgba(0,0,0,0.06);
            border-radius: 8px;
            margin-bottom: 4px;
            border-left: 2px solid var(--link-blue);
            font-size: 12px;
        }
        .message.sent .reply-preview-inline {
            background: rgba(255,255,255,0.15);
            border-left-color: rgba(255,255,255,0.5);
        }
        .reply-preview-name {
            font-weight: 600;
            color: var(--link-blue);
            margin-bottom: 1px;
        }
        .message.sent .reply-preview-name {
            color: rgba(255,255,255,0.9);
        }
        .reply-preview-text {
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* ==================== INPUT BAR ==================== */
        .input-bar {
            min-height: calc(var(--input-bar-height) + var(--safe-area-bottom));
            padding: 6px 8px calc(var(--safe-area-bottom) + 6px);
            background: var(--white);
            border-top: 0.5px solid var(--border-light);
            display: flex;
            align-items: flex-end;
            gap: 6px;
            flex-shrink: 0;
        }
        .reply-bar {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: var(--background-light);
            border-radius: 10px 10px 0 0;
            margin: -6px -8px 6px -8px;
            border-left: 3px solid var(--link-blue);
        }
        .reply-bar-content {
            flex: 1;
            overflow: hidden;
        }
        .reply-bar-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--link-blue);
        }
        .reply-bar-text {
            font-size: 12px;
            color: var(--secondary-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .reply-bar-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 50%;
        }
        .reply-bar-close:active {
            background: var(--hover-gray);
        }
        .reply-bar-close .material-icons-round {
            font-size: 18px;
            color: var(--secondary-text);
        }
        .input-actions-left {
            display: flex;
            gap: 2px;
            padding-bottom: 4px;
        }
        .input-btn {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }
        .input-btn:active {
            background: var(--hover-gray);
            transform: scale(0.92);
        }
        .input-btn .material-icons-round {
            font-size: 22px;
            color: var(--secondary-text);
        }
        .message-input-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .message-input {
            width: 100%;
            min-height: 36px;
            max-height: 100px;
            padding: 8px 12px;
            background: var(--background-light);
            border: none;
            border-radius: 18px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            resize: none;
            overflow-y: auto;
            color: var(--primary-text);
            line-height: 1.35;
        }
        .message-input::placeholder {
            color: var(--tertiary-text);
        }
        .message-input::-webkit-scrollbar {
            display: none;
        }
        .send-btn {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        .send-btn .material-icons-round {
            font-size: 22px;
            color: var(--tertiary-text);
            transition: color 0.2s;
        }
        .send-btn.active {
            background: var(--link-blue);
            transform: scale(1);
        }
        .send-btn.active .material-icons-round {
            color: white;
        }
        .send-btn:active {
            transform: scale(0.9);
        }
        /* Schedule Button */
        .schedule-btn {
            width: 34px;
            height: 34px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            margin-bottom: 4px;
        }
        .schedule-btn.show {
            display: flex;
        }
        .schedule-btn .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }
        .schedule-btn:active {
            background: var(--hover-gray);
        }
        /* ==================== EMOJI PICKER ==================== */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            height: 260px;
            background: var(--white);
            border-top: 0.5px solid var(--border-light);
            display: none;
            flex-direction: column;
        }
        .emoji-picker.active {
            display: flex;
        }
        .emoji-categories {
            display: flex;
            padding: 6px 8px;
            gap: 2px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .emoji-category {
            flex: 1;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .emoji-category:active,
        .emoji-category.active {
            background: var(--hover-gray);
        }
        .emoji-category .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }
        .emoji-category.active .material-icons-round {
            color: var(--link-blue);
        }
        .emoji-grid {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
        }
        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .emoji-item:active {
            background: var(--hover-gray);
            transform: scale(1.1);
        }
        /* ==================== PROFILE SCREEN ==================== */
        .profile-header {
            height: calc(52px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--white);
            border-bottom: 0.5px solid var(--border-light);
            display: flex;
            align-items: center;
            padding-left: 4px;
            padding-right: 12px;
            gap: 8px;
            flex-shrink: 0;
        }
        .profile-header-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }
        .save-btn {
            padding: 7px 16px;
            background: var(--link-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .save-btn:active {
            transform: scale(0.95);
        }
        .save-btn:disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }
        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 28px;
        }
        .profile-avatar-edit {
            position: relative;
            width: 96px;
            height: 96px;
            margin-bottom: 12px;
        }
        .profile-avatar-large {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: var(--background-light);
            overflow: hidden;
            border: 3px solid var(--border-light);
        }
        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-edit-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: var(--link-blue);
            border: 2px solid var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .avatar-edit-btn .material-icons-round {
            font-size: 16px;
            color: white;
        }
        .avatar-edit-btn:active {
            transform: scale(0.92);
        }
        .profile-avatar-hint {
            font-size: 12px;
            color: var(--secondary-text);
        }
        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-input {
            width: 100%;
            height: 44px;
            padding: 0 12px;
            background: var(--background-light);
            border: 1.5px solid transparent;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
            color: var(--primary-text);
        }
        .form-input:focus {
            border-color: var(--link-blue);
            background: var(--white);
        }
        .form-textarea {
            height: auto;
            min-height: 80px;
            padding: 10px 12px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
        }
        .form-hint {
            font-size: 11px;
            color: var(--tertiary-text);
        }
        .char-count {
            font-size: 11px;
            color: var(--tertiary-text);
            text-align: right;
        }
        /* ==================== SETTINGS SCREEN ==================== */
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: var(--safe-area-bottom);
        }
        .settings-content::-webkit-scrollbar {
            display: none;
        }
        .settings-section {
            padding: 4px 0;
        }
        .settings-section-title {
            padding: 14px 16px 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--link-blue);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .settings-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .settings-item:active {
            background: var(--hover-gray);
        }
        .settings-icon {
            width: 36px;
            height: 36px;
            background: var(--background-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .settings-icon .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }
        .settings-icon.accent {
            background: var(--accent-gradient);
        }
        .settings-icon.accent .material-icons-round {
            color: white;
        }
        .settings-icon.blue {
            background: var(--link-blue);
        }
        .settings-icon.blue .material-icons-round {
            color: white;
        }
        .settings-icon.green {
            background: var(--online-green);
        }
        .settings-icon.green .material-icons-round {
            color: white;
        }
        .settings-icon.red {
            background: var(--error-red);
        }
        .settings-icon.red .material-icons-round {
            color: white;
        }
        .settings-icon.purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .settings-icon.purple .material-icons-round {
            color: white;
        }
        .settings-info {
            flex: 1;
            min-width: 0;
        }
        .settings-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-text);
        }
        .settings-subtitle {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 1px;
        }
        .settings-value {
            font-size: 13px;
            color: var(--secondary-text);
        }
        .settings-arrow .material-icons-round {
            font-size: 18px;
            color: var(--tertiary-text);
        }
        /* Toggle Switch */
        .toggle-switch {
            width: 48px;
            height: 28px;
            background: var(--border-light);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.25s;
            flex-shrink: 0;
        }
        .toggle-switch.active {
            background: var(--online-green);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.25s var(--ease-out);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            width: 100%;
            max-width: 320px;
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            transform: scale(0.95) translateY(10px);
            transition: transform 0.25s var(--ease-out);
        }
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }
        .modal-header {
            padding: 20px 20px 0;
            text-align: center;
        }
        .modal-icon {
            width: 48px;
            height: 48px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
        }
        .modal-icon.danger {
            background: rgba(239, 68, 68, 0.1);
        }
        .modal-icon .material-icons-round {
            font-size: 24px;
            color: var(--secondary-text);
        }
        .modal-icon.danger .material-icons-round {
            color: var(--error-red);
        }
        .modal-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .modal-body {
            padding: 10px 20px 20px;
        }
        .modal-text {
            font-size: 13px;
            color: var(--secondary-text);
            text-align: center;
            line-height: 1.5;
        }
        .modal-input {
            width: 100%;
            height: 44px;
            padding: 0 12px;
            background: var(--background-light);
            border: 1.5px solid var(--border-light);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            margin-top: 12px;
            color: var(--primary-text);
        }
        .modal-input:focus {
            border-color: var(--link-blue);
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            padding: 0 20px 20px;
        }
        .modal-btn {
            flex: 1;
            height: 44px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .modal-btn.secondary {
            background: var(--background-light);
            color: var(--primary-text);
        }
        .modal-btn.primary {
            background: var(--link-blue);
            color: white;
        }
        .modal-btn.danger {
            background: var(--error-red);
            color: white;
        }
        .modal-btn:active {
            transform: scale(0.98);
        }
        /* ==================== ACTION SHEETS ==================== */
        .action-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
        }
        .action-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            border-radius: 16px 16px 0 0;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s var(--ease-out);
        }
        .action-sheet-overlay.active .action-sheet {
            transform: translateY(0);
        }
        .action-sheet-handle {
            width: 32px;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin: 10px auto;
        }
        .action-sheet-title {
            padding: 6px 16px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .action-sheet-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .action-sheet-item:active {
            background: var(--hover-gray);
        }
        .action-sheet-item .material-icons-round {
            font-size: 22px;
            color: var(--secondary-text);
        }
        .action-sheet-item-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-text);
        }
        .action-sheet-item.danger .material-icons-round,
        .action-sheet-item.danger .action-sheet-item-text {
            color: var(--error-red);
        }
        .action-sheet-cancel {
            margin: 8px 16px 16px;
            height: 48px;
            background: var(--background-light);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: var(--link-blue);
            cursor: pointer;
            transition: all 0.15s;
            width: calc(100% - 32px);
        }
        .action-sheet-cancel:active {
            transform: scale(0.98);
        }
        /* ==================== CONTEXT MENU ==================== */
        .message-context-menu {
            position: fixed;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 160px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all 0.15s var(--ease-out);
        }
        .message-context-menu.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .context-menu-item:active {
            background: var(--hover-gray);
        }
        .context-menu-item .material-icons-round {
            font-size: 18px;
            color: var(--secondary-text);
        }
        .context-menu-item span:last-child {
            font-size: 14px;
            font-weight: 500;
        }
        .context-menu-item.danger .material-icons-round,
        .context-menu-item.danger span {
            color: var(--error-red);
        }
        /* ==================== QUICK REACTIONS ==================== */
        .quick-reactions {
            display: flex;
            gap: 2px;
            padding: 6px 8px;
            background: var(--white);
            border-radius: 22px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            position: fixed;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.85) translateY(8px);
            transition: all 0.2s var(--ease-out);
        }
        .quick-reactions.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }
        .quick-reaction {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.15s;
        }
        .quick-reaction:active {
            transform: scale(1.25);
        }
        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: calc(70px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-text);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            animation: toastIn 0.25s var(--ease-out);
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 16px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        /* ==================== LOADING ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        [data-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.9);
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--link-blue);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        /* ==================== UPLOAD PROGRESS ==================== */
        .upload-progress {
            position: fixed;
            bottom: calc(80px + var(--safe-area-bottom));
            left: 12px;
            right: 12px;
            background: var(--white);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            z-index: 500;
            display: none;
            border: 1px solid var(--border-light);
        }
        .upload-progress.active {
            display: block;
            animation: slideUp 0.25s var(--ease-out);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .upload-icon {
            width: 36px;
            height: 36px;
            background: var(--background-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-icon .material-icons-round {
            font-size: 20px;
            color: var(--link-blue);
        }
        .upload-details {
            flex: 1;
            min-width: 0;
        }
        .upload-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .upload-size {
            font-size: 11px;
            color: var(--secondary-text);
        }
        .upload-bar {
            height: 4px;
            background: var(--background-light);
            border-radius: 2px;
            overflow: hidden;
        }
        .upload-bar-fill {
            height: 100%;
            background: var(--link-blue);
            border-radius: 2px;
            transition: width 0.2s;
        }
        /* ==================== STORAGE WARNING ==================== */
        .storage-warning {
            padding: 10px 14px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--error-red);
            margin: 12px 16px;
            border-radius: 8px;
        }
        .storage-warning-text {
            font-size: 12px;
            color: var(--error-red);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .storage-warning-text .material-icons-round {
            font-size: 16px;
        }
        /* ==================== SCHEDULE MODAL ==================== */
        .schedule-picker {
            padding: 16px 20px;
        }
        .schedule-picker-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-text);
        }
        .schedule-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .schedule-input {
            flex: 1;
            height: 44px;
            padding: 0 12px;
            background: var(--background-light);
            border: 1.5px solid var(--border-light);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            color: var(--primary-text);
        }
        .schedule-input:focus {
            border-color: var(--link-blue);
        }
        /* ==================== FORWARD MODAL ==================== */
        .forward-search {
            padding: 12px 16px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .forward-search-input {
            width: 100%;
            height: 36px;
            padding: 0 12px;
            background: var(--background-light);
            border: none;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            color: var(--primary-text);
        }
        .forward-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .forward-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .forward-item:active {
            background: var(--hover-gray);
        }
        .forward-item.selected {
            background: rgba(0, 149, 246, 0.1);
        }
        .forward-item-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--background-light);
            overflow: hidden;
        }
        .forward-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .forward-item-info {
            flex: 1;
            min-width: 0;
        }
        .forward-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
        }
        .forward-item-username {
            font-size: 12px;
            color: var(--secondary-text);
        }
        .forward-item-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .forward-item.selected .forward-item-check {
            background: var(--link-blue);
            border-color: var(--link-blue);
        }
        .forward-item-check .material-icons-round {
            font-size: 14px;
            color: white;
            opacity: 0;
        }
        .forward-item.selected .forward-item-check .material-icons-round {
            opacity: 1;
        }
        /* ==================== AI BADGE ==================== */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 9px;
            font-weight: 700;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        /* ==================== UTILITIES ==================== */
        .hide {
            display: none !important;
        }
        .show {
            display: flex !important;
        }
        /* Storage Screen Specific */
        .storage-usage-card {
            margin: 16px;
            padding: 16px;
            background: var(--background-light);
            border-radius: 12px;
        }
        .storage-usage-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .storage-usage-label {
            font-size: 13px;
            color: var(--primary-text);
        }
        .storage-usage-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-text);
        }
        .storage-bar-container {
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .storage-bar-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .storage-usage-footer {
            display: flex;
            justify-content: space-between;
        }
        .storage-usage-footer span {
            font-size: 11px;
            color: var(--secondary-text);
        }
        /* Loading State for Lists */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 12px;
        }
        .loading-state-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-light);
            border-top-color: var(--link-blue);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        .loading-state-text {
            font-size: 13px;
            color: var(--secondary-text);
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* QR Code Styles */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        .qr-code-wrapper {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #qrcode {
            width: 256px;
            height: 256px;
        }
        #qrcode img {
            width: 100% !important;
            height: 100% !important;
        }
        .qr-info {
            text-align: center;
            margin-top: 16px;
        }
        .qr-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .qr-subtitle {
            font-size: 14px;
            color: var(--secondary-text);
            margin-bottom: 20px;
        }
        .qr-actions {
            display: flex;
            gap: 12px;
        }
        .qr-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .qr-btn.primary {
            background: var(--link-blue);
            color: white;
        }
        .qr-btn.secondary {
            background: var(--background-light);
            color: var(--primary-text);
        }
        .qr-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Modern Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-profile" id="sidebarProfileBtn">
                    <div class="sidebar-avatar">
                        <img id="sidebarAvatar" src="" alt="">
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-username" id="sidebarUsername">Username</div>
                        <div class="sidebar-email" id="sidebarEmail">email@example.com</div>
                    </div>
                    <span class="material-icons-round sidebar-profile-arrow">chevron_right</span>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="sidebar-item" data-action="home">
                        <div class="sidebar-item-icon blue">
                            <span class="material-icons-round">chat_bubble</span>
                        </div>
                        <span class="sidebar-item-text">Chats</span>
                    </div>
                    <div class="sidebar-item" data-action="requests">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">person_add</span>
                        </div>
                        <span class="sidebar-item-text">Friend Requests</span>
                        <span class="sidebar-item-badge hide" id="sidebarRequestsBadge">0</span>
                    </div>
                    <div class="sidebar-item" data-action="archived">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">archive</span>
                        </div>
                        <span class="sidebar-item-text">Archived</span>
                    </div>
                    <div class="sidebar-item" data-action="starred">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">star</span>
                        </div>
                        <span class="sidebar-item-text">Starred Messages</span>
                    </div>
                </div>
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Settings</div>
                    <div class="sidebar-item" data-action="settings">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">settings</span>
                        </div>
                        <span class="sidebar-item-text">Settings</span>
                    </div>
                    <div class="sidebar-item" data-action="privacy">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">lock</span>
                        </div>
                        <span class="sidebar-item-text">Privacy</span>
                    </div>
                    <div class="sidebar-item" data-action="storage">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">folder</span>
                        </div>
                        <span class="sidebar-item-text">Storage & Data</span>
                    </div>
                </div>
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Support</div>
                    <div class="sidebar-item" data-action="help">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">help_outline</span>
                        </div>
                        <span class="sidebar-item-text">Help Center</span>
                    </div>
                    <div class="sidebar-item" data-action="about">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">info_outline</span>
                        </div>
                        <span class="sidebar-item-text">About</span>
                    </div>
                </div>
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-section">
                    <div class="sidebar-item" data-action="logout">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">logout</span>
                        </div>
                        <span class="sidebar-item-text">Log Out</span>
                    </div>
                    <div class="sidebar-item danger" data-action="delete-account">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">delete_forever</span>
                        </div>
                        <span class="sidebar-item-text">Delete Account</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="sidebar-footer-text">What's Up v2.0</div>
                <button class="sidebar-theme-toggle" id="sidebarThemeToggle">
                    <span class="material-icons-round">dark_mode</span>
                </button>
            </div>
        </div>

        <!-- Auth Screen -->
        <div class="screen auth-screen active" id="authScreen">
            <div class="auth-logo">W</div>
            <h1 class="auth-title">What's Up</h1>
            <p class="auth-subtitle">Connect with friends through beautiful, instant messaging</p>
            <button class="google-btn" id="googleSignInBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
        </div>

        <!-- Username Setup Screen -->
        <div class="screen username-screen" id="usernameScreen">
            <div class="username-header">
                <h1 class="username-title">Choose your username</h1>
                <p class="username-subtitle">Pick a unique name that friends can search for. You can only set this once.</p>
            </div>
            
            <div class="username-input-wrapper">
                <input type="text" class="username-input" id="usernameInput" placeholder="Enter username" autocomplete="off" maxlength="20">
                <div class="username-status" id="usernameStatus">
                    <div class="spinner" style="display: none;"></div>
                </div>
            </div>
            
            <div class="username-suggestions">
                <div class="suggestions-label">Suggestions</div>
                <div class="suggestions-chips" id="suggestionChips"></div>
            </div>
            
            <button class="username-continue-btn" id="usernameContinueBtn">Continue</button>
        </div>

        <!-- Home Screen -->
        <div class="screen home-screen" id="homeScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="app-name-btn" id="openSidebarBtn">
                        <span class="app-name">What's Up</span>
                        <span class="material-icons-round">keyboard_arrow_down</span>
                    </button>
                </div>
                <div class="top-bar-right">
                    <button class="icon-btn" id="searchBtn">
                        <span class="material-icons-round">search</span>
                    </button>
                    <button class="icon-btn" id="requestsBtn">
                        <span class="material-icons-round">person_add</span>
                        <span class="badge hide" id="requestsBadge">0</span>
                    </button>
                </div>
            </div>
            
            <div class="chat-list-container" id="chatListContainer">
                <div class="empty-state">
                    <div class="empty-icon">
                        <span class="material-icons-round">forum</span>
                    </div>
                    <div class="empty-title">No chats yet</div>
                    <div class="empty-text">Search for friends to start chatting</div>
                </div>
            </div>
            
            <button class="fab profile-fab" id="profileFab">
                <span class="material-icons-round">person</span>
            </button>
            
            <button class="fab" id="newChatBtn">
                <span class="material-icons-round">edit</span>
            </button>
        </div>

        <!-- Search Screen -->
        <div class="screen search-screen" id="searchScreen">
            <div class="search-header">
                <button class="back-btn" id="searchBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" id="searchUserInput" placeholder="Search username...">
                </div>
            </div>
            
            <div class="search-content" id="searchContent">
                <div class="search-section">
                    <div class="search-section-title">Recommended</div>
                    <div id="recommendedUsers">
                        <div class="loading-state">
                            <div class="loading-state-spinner"></div>
                            <span class="loading-state-text">Loading users...</span>
                        </div>
                    </div>
                </div>
                <div class="search-section hide" id="searchResultsSection">
                    <div class="search-section-title">Results</div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>

        <!-- Requests Screen -->
        <div class="screen requests-screen" id="requestsScreen">
            <div class="search-header">
                <button class="back-btn" id="requestsBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="search-input-wrapper">
                    <span style="font-size: 16px; font-weight: 600; padding-left: 4px;">Friend Requests</span>
                </div>
            </div>
            
            <div class="chat-list-container" id="requestsList">
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                    <span class="loading-state-text">Loading requests...</span>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div class="screen chat-screen" id="chatScreen">
            <div class="chat-top-bar">
                <button class="back-btn" id="chatBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="chat-user-info" id="chatUserInfo">
                    <div class="chat-user-avatar">
                        <img id="chatUserAvatar" src="" alt="">
                        <div class="online-dot hide" id="chatUserOnlineDot"></div>
                    </div>
                    <div class="chat-user-details">
                        <div class="chat-user-name" id="chatUserName">Username</div>
                        <div class="chat-user-status" id="chatUserStatus">online</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" id="chatCallBtn">
                        <span class="material-icons-round">call</span>
                    </button>
                    <button class="icon-btn" id="chatVideoBtn">
                        <span class="material-icons-round">videocam</span>
                    </button>
                    <button class="icon-btn" id="chatMenuBtn">
                        <span class="material-icons-round">more_vert</span>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer"></div>
            
            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-categories">
                    <div class="emoji-category active" data-category="smileys">
                        <span class="material-icons-round">emoji_emotions</span>
                    </div>
                    <div class="emoji-category" data-category="gestures">
                        <span class="material-icons-round">waving_hand</span>
                    </div>
                    <div class="emoji-category" data-category="animals">
                        <span class="material-icons-round">pets</span>
                    </div>
                    <div class="emoji-category" data-category="food">
                        <span class="material-icons-round">restaurant</span>
                    </div>
                    <div class="emoji-category" data-category="objects">
                        <span class="material-icons-round">lightbulb</span>
                    </div>
                    <div class="emoji-category" data-category="symbols">
                        <span class="material-icons-round">favorite</span>
                    </div>
                </div>
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>
            
            <div class="input-bar" id="inputBar">
                <div class="input-actions-left">
                    <button class="input-btn" id="emojiBtn">
                        <span class="material-icons-round">emoji_emotions</span>
                    </button>
                    <button class="input-btn" id="attachBtn">
                        <span class="material-icons-round">add_circle</span>
                    </button>
                </div>
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
                </div>
                <button class="input-btn" id="cameraBtn">
                    <span class="material-icons-round">photo_camera</span>
                </button>
                <button class="schedule-btn" id="scheduleBtn">
                    <span class="material-icons-round">schedule</span>
                </button>
                <button class="send-btn" id="sendBtn">
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>

        <!-- Profile Edit Screen -->
        <div class="screen profile-screen" id="profileScreen">
            <div class="profile-header">
                <button class="back-btn" id="profileBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Edit Profile</span>
                <button class="save-btn" id="saveProfileBtn" disabled>Save</button>
            </div>
            
            <div class="profile-content">
                <div class="profile-avatar-section">
                    <div class="profile-avatar-edit">
                        <div class="profile-avatar-large">
                            <img id="profileAvatarLarge" src="" alt="">
                        </div>
                        <button class="avatar-edit-btn" id="changeAvatarBtn">
                            <span class="material-icons-round">camera_alt</span>
                        </button>
                    </div>
                    <div class="profile-avatar-hint">Tap to change photo</div>
                </div>
                
                <form class="profile-form" id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="profileName" placeholder="Your name" maxlength="30">
                        <span class="char-count"><span id="nameCount">0</span>/30</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="profileUsername" placeholder="@username" disabled>
                        <span class="form-hint">Username cannot be changed</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bio</label>
                        <textarea class="form-input form-textarea" id="profileBio" placeholder="Write something about yourself..." maxlength="150"></textarea>
                        <span class="char-count"><span id="bioCount">0</span>/150</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="profileEmail" disabled>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Screen -->
        <div class="screen settings-screen" id="settingsScreen">
            <div class="profile-header">
                <button class="back-btn" id="settingsBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Settings</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="settings-content" id="settingsContent">
                <!-- Account -->
                <div class="settings-section">
                    <div class="settings-section-title">Account</div>
                    <div class="settings-item" data-setting="edit-profile">
                        <div class="settings-icon accent">
                            <span class="material-icons-round">person</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Edit Profile</div>
                            <div class="settings-subtitle">Photo, name, bio</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="qr-code">
                        <div class="settings-icon blue">
                            <span class="material-icons-round">qr_code</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">QR Code</div>
                            <div class="settings-subtitle">Share your profile</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <!-- Privacy -->
                <div class="settings-section">
                    <div class="settings-section-title">Privacy</div>
                    <div class="settings-item" data-setting="last-seen">
                        <div class="settings-icon">
                            <span class="material-icons-round">schedule</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Last Seen</div>
                            <div class="settings-subtitle" id="lastSeenValue">Everyone</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="online-status">
                        <div class="settings-icon">
                            <span class="material-icons-round">visibility</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Online Status</div>
                            <div class="settings-subtitle">Show when you're online</div>
                        </div>
                        <div class="toggle-switch active" id="onlineStatusToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="read-receipts">
                        <div class="settings-icon">
                            <span class="material-icons-round">done_all</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Read Receipts</div>
                            <div class="settings-subtitle">Show when you've read messages</div>
                        </div>
                        <div class="toggle-switch active" id="readReceiptsToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="typing-indicator">
                        <div class="settings-icon">
                            <span class="material-icons-round">edit</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Typing Indicator</div>
                            <div class="settings-subtitle">Show when you're typing</div>
                        </div>
                        <div class="toggle-switch active" id="typingIndicatorToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="blocked-users">
                        <div class="settings-icon">
                            <span class="material-icons-round">block</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Blocked Users</div>
                            <div class="settings-subtitle" id="blockedCount">0 blocked</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Settings -->
                <div class="settings-section">
                    <div class="settings-section-title">Chats</div>
                    <div class="settings-item" data-setting="theme">
                        <div class="settings-icon">
                            <span class="material-icons-round">dark_mode</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Theme</div>
                            <div class="settings-subtitle" id="themeValue">System</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="wallpaper">
                        <div class="settings-icon">
                            <span class="material-icons-round">wallpaper</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Chat Wallpaper</div>
                            <div class="settings-subtitle">Customize chat background</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="enter-to-send">
                        <div class="settings-icon">
                            <span class="material-icons-round">keyboard_return</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Enter to Send</div>
                            <div class="settings-subtitle">Press enter to send messages</div>
                        </div>
                        <div class="toggle-switch active" id="enterToSendToggle"></div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="settings-item" data-setting="message-notifications">
                        <div class="settings-icon green">
                            <span class="material-icons-round">notifications</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Message Notifications</div>
                            <div class="settings-subtitle">Show notifications for new messages</div>
                        </div>
                        <div class="toggle-switch active" id="messageNotifToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="vibration">
                        <div class="settings-icon">
                            <span class="material-icons-round">vibration</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Vibration</div>
                            <div class="settings-subtitle">Vibrate on new messages</div>
                        </div>
                        <div class="toggle-switch active" id="vibrationToggle"></div>
                    </div>
                </div>

                <!-- AI Features -->
                <div class="settings-section">
                    <div class="settings-section-title">
                        AI Features <span class="ai-badge"> AI</span>
                    </div>
                    <div class="settings-item" data-setting="ai-auto-reply">
                        <div class="settings-icon purple">
                            <span class="material-icons-round">smart_toy</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">AI Auto-Reply</div>
                            <div class="settings-subtitle">Generate smart replies</div>
                        </div>
                        <div class="toggle-switch" id="aiAutoReplyToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="ai-translate">
                        <div class="settings-icon purple">
                            <span class="material-icons-round">translate</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Auto-Translate</div>
                            <div class="settings-subtitle">Translate messages automatically</div>
                        </div>
                        <div class="toggle-switch" id="aiTranslateToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="ai-spam">
                        <div class="settings-icon purple">
                            <span class="material-icons-round">security</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Spam Detection</div>
                            <div class="settings-subtitle">Detect and filter spam messages</div>
                        </div>
                        <div class="toggle-switch active" id="aiSpamToggle"></div>
                    </div>
                </div>

                <!-- Storage -->
                <div class="settings-section">
                    <div class="settings-section-title">Storage & Data</div>
                    <div class="settings-item" data-setting="storage-usage">
                        <div class="settings-icon">
                            <span class="material-icons-round">pie_chart</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Storage Usage</div>
                            <div class="settings-subtitle" id="storageUsageValue">0 MB used</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="auto-download">
                        <div class="settings-icon">
                            <span class="material-icons-round">download</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Auto-Download Media</div>
                            <div class="settings-subtitle">Download photos and videos automatically</div>
                        </div>
                        <div class="toggle-switch" id="autoDownloadToggle"></div>
                    </div>
                    <div class="settings-item" data-setting="clear-cache">
                        <div class="settings-icon red">
                            <span class="material-icons-round">delete_sweep</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Clear Cache</div>
                            <div class="settings-subtitle">Free up space</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <!-- About -->
                <div class="settings-section">
                    <div class="settings-section-title">About</div>
                    <div class="settings-item" data-setting="help">
                        <div class="settings-icon">
                            <span class="material-icons-round">help_outline</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Help Center</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-setting="about">
                        <div class="settings-icon">
                            <span class="material-icons-round">info_outline</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">About What's Up</div>
                            <div class="settings-subtitle">Version 2.0.0</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Settings Screen -->
        <div class="screen settings-screen" id="privacyScreen">
            <div class="profile-header">
                <button class="back-btn" id="privacyBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Privacy</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-section-title">Who can see my info</div>
                    <div class="settings-item" data-privacy="last-seen">
                        <div class="settings-icon">
                            <span class="material-icons-round">schedule</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Last Seen</div>
                            <div class="settings-subtitle" id="privacyLastSeen">Everyone</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-privacy="profile-photo">
                        <div class="settings-icon">
                            <span class="material-icons-round">account_circle</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Profile Photo</div>
                            <div class="settings-subtitle" id="privacyPhoto">Everyone</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-privacy="online">
                        <div class="settings-icon">
                            <span class="material-icons-round">circle</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Online Status</div>
                            <div class="settings-subtitle" id="privacyOnline">Everyone</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">Messaging</div>
                    <div class="settings-item">
                        <div class="settings-icon">
                            <span class="material-icons-round">done_all</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Read Receipts</div>
                            <div class="settings-subtitle">If turned off, you won't see read receipts either</div>
                        </div>
                        <div class="toggle-switch active" id="privacyReadReceipts"></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-icon">
                            <span class="material-icons-round">edit</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Typing Indicator</div>
                            <div class="settings-subtitle">Show when you're typing</div>
                        </div>
                        <div class="toggle-switch active" id="privacyTyping"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">Blocked</div>
                    <div class="settings-item" data-privacy="blocked">
                        <div class="settings-icon red">
                            <span class="material-icons-round">block</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Blocked Users</div>
                            <div class="settings-subtitle" id="blockedUsersCount">0 users</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Screen -->
        <div class="screen settings-screen" id="storageScreen">
            <div class="profile-header">
                <button class="back-btn" id="storageBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Storage & Data</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="settings-content">
                <div class="storage-warning" id="storageWarning" style="display: none;">
                    <div class="storage-warning-text">
                        <span class="material-icons-round">warning</span>
                        You're approaching your storage limit
                    </div>
                </div>
                
                <div class="storage-usage-card">
                    <div class="storage-usage-header">
                        <span class="storage-usage-label">Storage Used</span>
                        <span class="storage-usage-value" id="totalStorageUsed">0 MB / 100 MB</span>
                    </div>
                    <div class="storage-bar-container">
                        <div class="storage-bar-fill" id="storageBar" style="width: 0%;"></div>
                    </div>
                    <div class="storage-usage-footer">
                        <span>Daily: <span id="dailyUsed">0</span> / 5 MB</span>
                        <span>Lifetime limit: 100 MB</span>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">Manage Storage</div>
                    <div class="settings-item" data-storage="photos">
                        <div class="settings-icon blue">
                            <span class="material-icons-round">photo</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Photos</div>
                            <div class="settings-subtitle" id="photosSize">0 MB</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-storage="videos">
                        <div class="settings-icon green">
                            <span class="material-icons-round">videocam</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Videos</div>
                            <div class="settings-subtitle" id="videosSize">0 MB</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="settings-item" data-storage="documents">
                        <div class="settings-icon">
                            <span class="material-icons-round">folder</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Documents</div>
                            <div class="settings-subtitle" id="documentsSize">0 MB</div>
                        </div>
                        <div class="settings-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">Data Settings</div>
                    <div class="settings-item">
                        <div class="settings-icon">
                            <span class="material-icons-round">download</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Auto-Download Media</div>
                            <div class="settings-subtitle">Download photos & videos automatically</div>
                        </div>
                        <div class="toggle-switch" id="storageAutoDownload"></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-icon">
                            <span class="material-icons-round">data_saver_on</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title">Data Saver Mode</div>
                            <div class="settings-subtitle">Reduce data and storage usage</div>
                        </div>
                        <div class="toggle-switch" id="storageDataSaver"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-item" data-storage="clear-all">
                        <div class="settings-icon red">
                            <span class="material-icons-round">delete_forever</span>
                        </div>
                        <div class="settings-info">
                            <div class="settings-title" style="color: var(--error-red);">Clear All Data</div>
                            <div class="settings-subtitle">Delete all cached media</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archived Chats Screen -->
        <div class="screen settings-screen" id="archivedScreen">
            <div class="profile-header">
                <button class="back-btn" id="archivedBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Archived Chats</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="chat-list-container" id="archivedList">
                <div class="empty-state">
                    <div class="empty-icon">
                        <span class="material-icons-round">archive</span>
                    </div>
                    <div class="empty-title">No archived chats</div>
                    <div class="empty-text">Chats you archive will appear here</div>
                </div>
            </div>
        </div>

        <!-- Starred Messages Screen -->
        <div class="screen settings-screen" id="starredScreen">
            <div class="profile-header">
                <button class="back-btn" id="starredBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Starred Messages</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="chat-list-container" id="starredList">
                <div class="empty-state">
                    <div class="empty-icon">
                        <span class="material-icons-round">star</span>
                    </div>
                    <div class="empty-title">No starred messages</div>
                    <div class="empty-text">Messages you star will appear here</div>
                </div>
            </div>
        </div>

        <!-- Blocked Users Screen -->
        <div class="screen settings-screen" id="blockedScreen">
            <div class="profile-header">
                <button class="back-btn" id="blockedBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">Blocked Users</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="chat-list-container" id="blockedList">
                <div class="empty-state">
                    <div class="empty-icon">
                        <span class="material-icons-round">block</span>
                    </div>
                    <div class="empty-title">No blocked users</div>
                    <div class="empty-text">Users you block will appear here</div>
                </div>
            </div>
        </div>

        <!-- QR Code Screen -->
        <div class="screen settings-screen" id="qrScreen">
            <div class="profile-header">
                <button class="back-btn" id="qrBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <span class="profile-header-title">My QR Code</span>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="qr-container">
                <div class="qr-code-wrapper">
                    <div id="qrcode"></div>
                </div>
                <div class="qr-info">
                    <div class="qr-title" id="qrUsername">@username</div>
                    <div class="qr-subtitle">Scan this code to connect with me</div>
                    <div class="qr-actions">
                        <button class="qr-btn secondary" id="shareQRBtn">
                            <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">share</span>
                            Share
                        </button>
                        <button class="qr-btn primary" id="downloadQRBtn">
                            <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">download</span>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="deleteAccountModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon danger">
                    <span class="material-icons-round">warning</span>
                </div>
                <h3 class="modal-title">Delete Account?</h3>
            </div>
            <div class="modal-body">
                <p class="modal-text">This action cannot be undone. All your data, messages, and media will be permanently deleted.</p>
                <input type="text" class="modal-input" id="deleteConfirmInput" placeholder="Type DELETE to confirm">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="modal-btn danger" id="confirmDeleteBtn" disabled>Delete</button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">
                    <span class="material-icons-round">logout</span>
                </div>
                <h3 class="modal-title">Log Out?</h3>
            </div>
            <div class="modal-body">
                <p class="modal-text">Are you sure you want to log out of your account?</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelLogoutBtn">Cancel</button>
                <button class="modal-btn primary" id="confirmLogoutBtn">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Privacy Option Modal -->
    <div class="modal-overlay" id="privacyOptionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="privacyOptionTitle">Last Seen</h3>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="settings-item privacy-option" data-value="everyone">
                    <span class="material-icons-round privacy-check" style="color: var(--online-green);">check_circle</span>
                    <div class="settings-info">
                        <div class="settings-title">Everyone</div>
                    </div>
                </div>
                <div class="settings-item privacy-option" data-value="contacts">
                    <span class="material-icons-round privacy-check" style="color: transparent;">check_circle</span>
                    <div class="settings-info">
                        <div class="settings-title">My Contacts</div>
                    </div>
                </div>
                <div class="settings-item privacy-option" data-value="nobody">
                    <span class="material-icons-round privacy-check" style="color: transparent;">check_circle</span>
                    <div class="settings-info">
                        <div class="settings-title">Nobody</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="closePrivacyOption" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal-overlay" id="themeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Choose Theme</h3>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="settings-item theme-option" data-theme="light">
                    <span class="material-icons-round">light_mode</span>
                    <div class="settings-info">
                        <div class="settings-title">Light</div>
                    </div>
                    <span class="material-icons-round theme-check" style="color: transparent;">check_circle</span>
                </div>
                <div class="settings-item theme-option" data-theme="dark">
                    <span class="material-icons-round">dark_mode</span>
                    <div class="settings-info">
                        <div class="settings-title">Dark</div>
                    </div>
                    <span class="material-icons-round theme-check" style="color: transparent;">check_circle</span>
                </div>
                <div class="settings-item theme-option" data-theme="system">
                    <span class="material-icons-round">settings_suggest</span>
                    <div class="settings-info">
                        <div class="settings-title">System Default</div>
                    </div>
                    <span class="material-icons-round theme-check" style="color: var(--online-green);">check_circle</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="closeThemeModal" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Schedule Message Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Schedule Message</h3>
            </div>
            <div class="schedule-picker">
                <div class="schedule-picker-title">Select date and time</div>
                <div class="schedule-input-group">
                    <input type="date" class="schedule-input" id="scheduleDate">
                    <input type="time" class="schedule-input" id="scheduleTime">
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelScheduleBtn">Cancel</button>
                <button class="modal-btn primary" id="confirmScheduleBtn">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div class="modal-overlay" id="forwardModal">
        <div class="modal" style="max-width: 340px; max-height: 80vh;">
            <div class="modal-header" style="padding-bottom: 0;">
                <h3 class="modal-title">Forward Message</h3>
            </div>
            <div class="forward-search">
                <input type="text" class="forward-search-input" id="forwardSearchInput" placeholder="Search contacts...">
            </div>
            <div class="forward-list" id="forwardList"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelForwardBtn">Cancel</button>
                <button class="modal-btn primary" id="confirmForwardBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- Action Sheet for Attachments -->
    <div class="action-sheet-overlay" id="attachmentSheet">
        <div class="action-sheet">
            <div class="action-sheet-handle"></div>
            <div class="action-sheet-title">Share Content</div>
            <div class="action-sheet-item" data-attach="photo">
                <span class="material-icons-round" style="color: #4CAF50;">photo</span>
                <span class="action-sheet-item-text">Photo</span>
            </div>
            <div class="action-sheet-item" data-attach="video">
                <span class="material-icons-round" style="color: #E91E63;">videocam</span>
                <span class="action-sheet-item-text">Video</span>
            </div>
            <div class="action-sheet-item" data-attach="document">
                <span class="material-icons-round" style="color: #2196F3;">description</span>
                <span class="action-sheet-item-text">Document</span>
            </div>
            <div class="action-sheet-item" data-attach="location">
                <span class="material-icons-round" style="color: #F44336;">location_on</span>
                <span class="action-sheet-item-text">Location</span>
            </div>
            <button class="action-sheet-cancel" id="closeAttachmentSheet">Cancel</button>
        </div>
    </div>

    <!-- Chat Options Action Sheet -->
    <div class="action-sheet-overlay" id="chatOptionsSheet">
        <div class="action-sheet">
            <div class="action-sheet-handle"></div>
            <div class="action-sheet-title">Chat Options</div>
            <div class="action-sheet-item" data-chat-option="pin">
                <span class="material-icons-round">push_pin</span>
                <span class="action-sheet-item-text" id="pinOptionText">Pin Chat</span>
            </div>
            <div class="action-sheet-item" data-chat-option="mute">
                <span class="material-icons-round">notifications_off</span>
                <span class="action-sheet-item-text" id="muteOptionText">Mute Notifications</span>
            </div>
            <div class="action-sheet-item" data-chat-option="archive">
                <span class="material-icons-round">archive</span>
                <span class="action-sheet-item-text">Archive Chat</span>
            </div>
            <div class="action-sheet-item" data-chat-option="search">
                <span class="material-icons-round">search</span>
                <span class="action-sheet-item-text">Search Messages</span>
            </div>
            <div class="action-sheet-item" data-chat-option="clear">
                <span class="material-icons-round">delete_outline</span>
                <span class="action-sheet-item-text">Clear Chat</span>
            </div>
            <div class="action-sheet-item danger" data-chat-option="block">
                <span class="material-icons-round">block</span>
                <span class="action-sheet-item-text">Block User</span>
            </div>
            <button class="action-sheet-cancel" id="closeChatOptionsSheet">Cancel</button>
        </div>
    </div>

    <!-- Message Context Menu -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item" data-action="reply">
            <span class="material-icons-round">reply</span>
            <span>Reply</span>
        </div>
        <div class="context-menu-item" data-action="copy">
            <span class="material-icons-round">content_copy</span>
            <span>Copy</span>
        </div>
        <div class="context-menu-item" data-action="forward">
            <span class="material-icons-round">forward</span>
            <span>Forward</span>
        </div>
        <div class="context-menu-item" data-action="star">
            <span class="material-icons-round">star_outline</span>
            <span>Star</span>
        </div>
        <div class="context-menu-item" data-action="edit">
            <span class="material-icons-round">edit</span>
            <span>Edit</span>
        </div>
        <div class="context-menu-item danger" data-action="delete">
            <span class="material-icons-round">delete</span>
            <span>Delete</span>
        </div>
    </div>

    <!-- Quick Reactions -->
    <div class="quick-reactions" id="quickReactions">
        <div class="quick-reaction" data-emoji=""></div>
        <div class="quick-reaction" data-emoji=""></div>
        <div class="quick-reaction" data-emoji=""></div>
        <div class="quick-reaction" data-emoji=""></div>
        <div class="quick-reaction" data-emoji=""></div>
        <div class="quick-reaction" data-emoji=""></div>
    </div>

    <!-- Upload Progress -->
    <div class="upload-progress" id="uploadProgress">
        <div class="upload-info">
            <div class="upload-icon">
                <span class="material-icons-round">cloud_upload</span>
            </div>
            <div class="upload-details">
                <div class="upload-name" id="uploadFileName">Uploading...</div>
                <div class="upload-size" id="uploadFileSize">0 KB</div>
            </div>
        </div>
        <div class="upload-bar">
            <div class="upload-bar-fill" id="uploadBarFill" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
    <input type="file" id="avatarInput" accept="image/*" style="display: none;">

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyADpJve2b95BtSKxYFUxoo9MX40ASxvYSY",
            authDomain: "whatsupg6753.firebaseapp.com",
            databaseURL: "https://whatsupg6753-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "whatsupg6753",
            storageBucket: "whatsupg6753.firebasestorage.app",
            messagingSenderId: "622597842742",
            appId: "1:622597842742:web:72642ae955f15c91a6b597"
        };

        const cloudinaryConfig = {
            cloudName: 'dxvq8gxud',
            uploadPreset: 'whatsup_preset'
        };

        const geminiApiKey = 'AIzaSyBYovgobnIWppXnE0GHRdI5-5OpIAbmtH4';

        const STORAGE_LIMITS = {
            maxFileSize: 1 * 1024 * 1024,
            dailyLimit: 5 * 1024 * 1024,
            lifetimeLimit: 100 * 1024 * 1024
        };

        // ==================== INITIALIZE FIREBASE ====================
        let app, auth, db, rtdb;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            rtdb = firebase.database();
            
            db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                console.log('Persistence error:', err.code);
            });
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase init error:', error);
        }

        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let currentUserData = null;
        let currentChatUser = null;
        let currentChatId = null;
        let messagesListener = null;
        let typingTimeout = null;
        let usernameCheckTimeout = null;
        let selectedMessage = null;
        let replyingTo = null;
        let forwardingMessage = null;
        let selectedForwardUsers = [];
        let scheduledMessages = [];
        let userSettings = {
            theme: 'system',
            fontSize: 'medium',
            enterToSend: true,
            onlineStatus: true,
            readReceipts: true,
            typingIndicator: true,
            messageNotifications: true,
            vibration: true,
            autoDownload: false,
            dataSaver: false,
            aiAutoReply: false,
            aiTranslate: false,
            aiSummary: false,
            aiSpam: true,
            privacy: {
                lastSeen: 'everyone',
                profilePhoto: 'everyone',
                bio: 'everyone',
                online: 'everyone'
            }
        };

        let storageUsage = {
            daily: 0,
            total: 0,
            photos: 0,
            videos: 0,
            documents: 0,
            lastReset: new Date().toDateString()
        };

        const emojis = {
            smileys: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            gestures: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            animals: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            food: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            objects: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            symbols: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
        };

        // ==================== AUTH STATE ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists || !userDoc.data().username) {
                        showScreen('usernameScreen');
                        generateUsernameSuggestions(user);
                    } else {
                        currentUserData = userDoc.data();
                        loadUserSettings();
                        loadStorageUsage();
                        showScreen('homeScreen');
                        setupPresence();
                        loadChats();
                        listenForRequests();
                        updateSidebarUser();
                        checkScheduledMessages();
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    showToast('Error loading user data');
                }
            } else {
                currentUser = null;
                currentUserData = null;
                showScreen('authScreen');
            }
        });

        // ==================== SCREEN MANAGEMENT ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }

        // ==================== SIDEBAR ====================
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            vibrate(5);
        }

        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        document.getElementById('openSidebarBtn').addEventListener('click', openSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        document.getElementById('sidebarProfileBtn').addEventListener('click', () => {
            closeSidebar();
            setTimeout(() => {
                showScreen('profileScreen');
                loadProfileData();
            }, 300);
        });

        document.getElementById('sidebarThemeToggle').addEventListener('click', () => {
            const currentTheme = userSettings.theme;
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            vibrate(5);
        });

        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.action;
                closeSidebar();
                
                setTimeout(() => {
                    switch(action) {
                        case 'home':
                            showScreen('homeScreen');
                            break;
                        case 'requests':
                            showScreen('requestsScreen');
                            loadRequests();
                            break;
case 'archived':
    showScreen('archivedScreen');
    loadArchivedChats();
    break;
case 'starred':
    showScreen('starredScreen');
    loadStarredMessages();
    break;
                        case 'settings':
                            showScreen('settingsScreen');
                            break;
                        case 'privacy':
                            showScreen('privacyScreen');
                            break;
                        case 'storage':
                            showScreen('storageScreen');
                            updateStorageDisplay();
                            break;
                        case 'logout':
                            showModal('logoutModal');
                            break;
                        case 'delete-account':
                            showModal('deleteAccountModal');
                            break;
                        case 'help':
    showHelpCenter();
    break;
case 'about':
    showAboutScreen();
    break;
                    }
                }, 300);
                
                vibrate(3);
            });
        });

        function updateSidebarUser() {
            if (currentUserData) {
                document.getElementById('sidebarUsername').textContent = currentUserData.username || 'User';
                document.getElementById('sidebarEmail').textContent = currentUser.email || '';
                document.getElementById('sidebarAvatar').src = currentUserData.photoURL || generateAvatar(currentUserData.username);
            }
        }

        // Add back button handlers for new screens
        document.getElementById('archivedBackBtn')?.addEventListener('click', () => {
            showScreen('homeScreen');
        });

        document.getElementById('starredBackBtn')?.addEventListener('click', () => {
            showScreen('homeScreen');
        });

        document.getElementById('blockedBackBtn')?.addEventListener('click', () => {
            showScreen('privacyScreen');
        });

        document.getElementById('qrBackBtn')?.addEventListener('click', () => {
            showScreen('settingsScreen');
        });

        // ==================== AUTHENTICATION ====================
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                showLoading(true);
                await auth.signInWithPopup(provider);
            } catch (error) {
                showToast('Sign in failed');
                console.error('Auth error:', error);
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('confirmLogoutBtn').addEventListener('click', async () => {
            hideModal('logoutModal');
            showLoading(true);
            
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await auth.signOut();
                showToast('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('cancelLogoutBtn').addEventListener('click', () => {
            hideModal('logoutModal');
        });

       document.getElementById('deleteConfirmInput').addEventListener('input', (e) => {
    const btn = document.getElementById('confirmDeleteBtn');
    const input = e.target.value.trim();
    btn.disabled = input !== 'DELETE';
    
    // Visual feedback
    if (input === 'DELETE') {
        btn.style.opacity = '1';
    } else {
        btn.style.opacity = '0.4';
    }
});

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    hideModal('deleteAccountModal');
    showLoading(true);
    
    try {
        // Step 1: Re-authenticate user (required by Firebase)
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await currentUser.reauthenticateWithPopup(provider);
        } catch (reauthError) {
            console.error('Re-authentication error:', reauthError);
            showToast('Please sign in again to delete account');
            showLoading(false);
            return;
        }
        
        // Step 2: Delete all user's chats
        const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.uid)
            .get();
        
        const deleteBatch = db.batch();
        chatsSnapshot.forEach(doc => {
            deleteBatch.delete(doc.ref);
        });
        await deleteBatch.commit();
        
        // Step 3: Delete friend requests
        const requestsSnapshot = await db.collection('friendRequests')
            .where('fromUid', '==', currentUser.uid)
            .get();
        
        const requestsBatch = db.batch();
        requestsSnapshot.forEach(doc => {
            requestsBatch.delete(doc.ref);
        });
        await requestsBatch.commit();
        
        const receivedRequestsSnapshot = await db.collection('friendRequests')
            .where('toUid', '==', currentUser.uid)
            .get();
        
        const receivedBatch = db.batch();
        receivedRequestsSnapshot.forEach(doc => {
            receivedBatch.delete(doc.ref);
        });
        await receivedBatch.commit();
        
        // Step 4: Delete starred messages
        const starredSnapshot = await db.collection('users').doc(currentUser.uid)
            .collection('starredMessages')
            .get();
        
        const starredBatch = db.batch();
        starredSnapshot.forEach(doc => {
            starredBatch.delete(doc.ref);
        });
        await starredBatch.commit();
        
        // Step 5: Delete blocked users
        const blockedSnapshot = await db.collection('users').doc(currentUser.uid)
            .collection('blocked')
            .get();
        
        const blockedBatch = db.batch();
        blockedSnapshot.forEach(doc => {
            blockedBatch.delete(doc.ref);
        });
        await blockedBatch.commit();
        
        // Step 6: Delete user document
        await db.collection('users').doc(currentUser.uid).delete();
        
        // Step 7: Delete username claim
        if (currentUserData?.username) {
            await db.collection('usernames').doc(currentUserData.username).delete();
        }
        
        // Step 8: Delete auth account
        await currentUser.delete();
        
        showToast('Account deleted successfully');
        
        // Reload page to go back to auth screen
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Delete error:', error);
        
        if (error.code === 'auth/requires-recent-login') {
            showToast('Please sign in again and retry');
            await auth.signOut();
            window.location.reload();
        } else if (error.code === 'permission-denied') {
            showToast('Permission denied. Please try again.');
        } else {
            showToast('Failed to delete account: ' + error.message);
        }
    } finally {
        showLoading(false);
        document.getElementById('deleteConfirmInput').value = '';
    }
});

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            hideModal('deleteAccountModal');
            document.getElementById('deleteConfirmInput').value = '';
        });

        // ==================== USERNAME SETUP ====================
        function generateUsernameSuggestions(user) {
            const email = user.email.split('@')[0].toLowerCase();
            const name = (user.displayName || email).replace(/\s+/g, '_').toLowerCase();
            
            const suggestions = [
                email.substring(0, 15),
                name.substring(0, 15),
                `${email}${Math.floor(Math.random() * 100)}`,
                `${name.split('_')[0]}${Math.floor(Math.random() * 1000)}`,
                `its_${email.substring(0, 10)}`,
                `${email}_${new Date().getFullYear() % 100}`
            ];
            
            const uniqueSuggestions = [...new Set(suggestions.map(s => s.replace(/[^a-z0-9_]/g, '')))].slice(0, 6);
            const chipsContainer = document.getElementById('suggestionChips');
            chipsContainer.innerHTML = uniqueSuggestions.map(username => 
                `<div class="suggestion-chip" onclick="selectSuggestion('${username}')">${username}</div>`
            ).join('');
        }

        window.selectSuggestion = function(username) {
            document.getElementById('usernameInput').value = username;
            checkUsernameAvailability(username);
            vibrate(3);
        };

        document.getElementById('usernameInput').addEventListener('input', (e) => {
            const username = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
            e.target.value = username;
            
            clearTimeout(usernameCheckTimeout);
            
            if (username.length < 3) {
                updateUsernameStatus('');
                return;
            }
            
            updateUsernameStatus('checking');
            usernameCheckTimeout = setTimeout(() => {
                checkUsernameAvailability(username);
            }, 300);
        });

        async function checkUsernameAvailability(username) {
            if (username.length < 3) return;
            
            try {
                const usernameDoc = await db.collection('usernames').doc(username).get();
                updateUsernameStatus(usernameDoc.exists ? 'taken' : 'available');
            } catch (error) {
                console.error('Username check error:', error);
                updateUsernameStatus('');
            }
        }

        function updateUsernameStatus(status) {
            const statusEl = document.getElementById('usernameStatus');
            const continueBtn = document.getElementById('usernameContinueBtn');
            
            statusEl.className = 'username-status';
            statusEl.innerHTML = '';
            
            if (status === 'checking') {
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                statusEl.appendChild(spinner);
                continueBtn.classList.remove('enabled');
            } else if (status === 'available') {
                statusEl.classList.add('available');
                statusEl.innerHTML = '<span class="material-icons-round">check_circle</span>';
                continueBtn.classList.add('enabled');
            } else if (status === 'taken') {
                statusEl.classList.add('taken');
                statusEl.innerHTML = '<span class="material-icons-round">cancel</span>';
                continueBtn.classList.remove('enabled');
            } else {
                statusEl.innerHTML = '';
                continueBtn.classList.remove('enabled');
            }
        }

        document.getElementById('usernameContinueBtn').addEventListener('click', async () => {
            const username = document.getElementById('usernameInput').value;
            if (!username || username.length < 3) return;
            
            showLoading(true);
            
            try {
                await db.collection('usernames').doc(username).set({
                    uid: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('users').doc(currentUser.uid).set({
                    username: username,
                    displayName: currentUser.displayName || username,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || generateAvatar(username),
                    bio: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    settings: userSettings,
                    storage: storageUsage
                });
                
                currentUserData = { 
                    username, 
                    displayName: currentUser.displayName || username, 
                    email: currentUser.email, 
                    photoURL: currentUser.photoURL || generateAvatar(username),
                    bio: ''
                };
                
                showScreen('homeScreen');
                setupPresence();
                loadChats();
                listenForRequests();
                updateSidebarUser();
                showToast('Welcome to What\'s Up!');
            } catch (error) {
                console.error('Username save error:', error);
                showToast('Failed to save username');
            } finally {
                showLoading(false);
            }
        });

        // ==================== PRESENCE ====================
        function setupPresence() {
            if (!currentUser) return;
            
            const userStatusRef = rtdb.ref(`/status/${currentUser.uid}`);
            const isOnlineForDatabase = {
                state: 'online',
                lastChanged: firebase.database.ServerValue.TIMESTAMP,
            };
            const isOfflineForDatabase = {
                state: 'offline',
                lastChanged: firebase.database.ServerValue.TIMESTAMP,
            };
            
            rtdb.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) return;
                
                userStatusRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                    if (userSettings.onlineStatus) {
                        userStatusRef.set(isOnlineForDatabase);
                    }
                });
            });
            
            if (userSettings.onlineStatus) {
                db.collection('users').doc(currentUser.uid).update({
                    online: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(console.error);
            }
        }

        // ==================== CHATS ====================
        function loadChats() {
            if (!currentUser) return;
            
            db.collection('chats')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTime', 'desc')
                .onSnapshot((snapshot) => {
                    const container = document.getElementById('chatListContainer');
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <span class="material-icons-round">forum</span>
                                </div>
                                <div class="empty-title">No chats yet</div>
                                <div class="empty-text">Search for friends to start chatting</div>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = '';
                    const pinnedChats = [];
                    const regularChats = [];
                    
                    snapshot.forEach((doc) => {
                        const chat = doc.data();
                        chat.id = doc.id;
                        
                        // Check if chat is archived
                        if (chat.archived?.[currentUser.uid]) return;
                        
                        if (chat.pinned?.[currentUser.uid]) {
                            pinnedChats.push(chat);
                        } else {
                            regularChats.push(chat);
                        }
                    });
                    
                    if (pinnedChats.length > 0) {
                        const pinnedSection = document.createElement('div');
                        pinnedSection.className = 'pinned-section';
                        pinnedSection.innerHTML = '<div class="section-header"><span class="material-icons-round">push_pin</span>Pinned</div>';
                        
                        pinnedChats.forEach(chat => {
                            renderChatItem(chat, pinnedSection, true);
                        });
                        
                        container.appendChild(pinnedSection);
                    }
                    
                    regularChats.forEach(chat => {
                        renderChatItem(chat, container, false);
                    });
                }, (error) => {
                    console.error('Load chats error:', error);
                });
        }

        function renderChatItem(chat, container, isPinned) {
            const otherUserId = chat.participants.find(id => id !== currentUser.uid);
            
            db.collection('users').doc(otherUserId).get().then((userDoc) => {
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                userData.uid = otherUserId;
                
                const chatItem = createChatItem(chat.id, userData, chat, isPinned);
                container.appendChild(chatItem);
            }).catch(console.error);
        }

        function createChatItem(chatId, userData, chatData, isPinned) {
            const div = document.createElement('div');
            div.className = `chat-item${isPinned ? ' pinned' : ''}`;
            
            const lastMessage = chatData.lastMessage || 'Say hi!';
            const time = chatData.lastMessageTime ? formatTime(chatData.lastMessageTime.toDate()) : '';
            const unread = chatData.unreadCount?.[currentUser.uid] || 0;
            const muted = chatData.muted?.[currentUser.uid] || false;
            
            div.innerHTML = `
                <div class="chat-avatar">
                    <img src="${userData.photoURL || generateAvatar(userData.username)}" alt="">
                    ${userData.online && userSettings.onlineStatus ? '<div class="online-dot"></div>' : ''}
                </div>
                <div class="chat-content">
                    <div class="chat-header">
                        <div class="chat-username">
                            ${isPinned ? '<span class="material-icons-round pin-icon">push_pin</span>' : ''}
                            ${escapeHtml(userData.username || 'User')}
                        </div>
                        <div class="chat-time">${time}</div>
                    </div>
                    <div class="chat-preview">
                        <span>${escapeHtml(lastMessage)}</span>
                        ${unread > 0 ? `<span class="unread-badge${muted ? ' muted-badge' : ''}">${unread}</span>` : ''}
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => openChat(chatId, userData));
            
            let pressTimer;
            div.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    vibrate(10);
                    showChatOptions(chatId, userData, chatData);
                }, 500);
            });
            div.addEventListener('touchend', () => clearTimeout(pressTimer));
            div.addEventListener('touchmove', () => clearTimeout(pressTimer));
            
            return div;
        }

        function showChatOptions(chatId, userData, chatData) {
            currentChatId = chatId;
            currentChatUser = userData;
            
            const isPinned = chatData?.pinned?.[currentUser.uid];
            const isMuted = chatData?.muted?.[currentUser.uid];
            
            document.getElementById('pinOptionText').textContent = isPinned ? 'Unpin Chat' : 'Pin Chat';
            document.getElementById('muteOptionText').textContent = isMuted ? 'Unmute Notifications' : 'Mute Notifications';
            
            document.getElementById('chatOptionsSheet').classList.add('active');
        }

        // ==================== ARCHIVED CHATS ====================
        async function loadArchivedChats() {
            if (!currentUser) return;
            
            const container = document.getElementById('archivedList');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                    <span class="loading-state-text">Loading archived chats...</span>
                </div>
            `;
            
            try {
                const snapshot = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .where(`archived.${currentUser.uid}`, '==', true)
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons-round">archive</span>
                            </div>
                            <div class="empty-title">No archived chats</div>
                            <div class="empty-text">Chats you archive will appear here</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach((doc) => {
                    const chat = doc.data();
                    chat.id = doc.id;
                    renderChatItem(chat, container, false);
                });
            } catch (error) {
                console.error('Load archived error:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-icons-round">error_outline</span>
                        </div>
                        <div class="empty-title">Error</div>
                        <div class="empty-text">Failed to load archived chats</div>
                    </div>
                `;
            }
        }

        // ==================== STARRED MESSAGES ====================
        async function loadStarredMessages() {
            if (!currentUser) return;
            
            const container = document.getElementById('starredList');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                    <span class="loading-state-text">Loading starred messages...</span>
                </div>
            `;
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('starredMessages')
                    .orderBy('starredAt', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons-round">star</span>
                            </div>
                            <div class="empty-title">No starred messages</div>
                            <div class="empty-text">Messages you star will appear here</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                for (const doc of snapshot.docs) {
                    const starred = doc.data();
                    
                    // Get the original message
                    const messageDoc = await db.collection('chats').doc(starred.chatId)
                        .collection('messages').doc(starred.messageId).get();
                    
                    if (messageDoc.exists) {
                        const message = messageDoc.data();
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message-item';
                        messageDiv.style.padding = '12px 16px';
                        messageDiv.style.borderBottom = '0.5px solid var(--border-light)';
                        
                        const time = starred.timestamp ? formatTime(starred.timestamp.toDate()) : '';
                        
                        messageDiv.innerHTML = `
                            <div style="font-size: 11px; color: var(--secondary-text); margin-bottom: 6px;">
                                ${escapeHtml(starred.chatWith || 'Unknown')}  ${time}
                            </div>
                            <div style="font-size: 14px; color: var(--primary-text);">
                                ${escapeHtml(message.text || 'Media')}
                            </div>
                        `;
                        
                        messageDiv.addEventListener('click', () => {
                            // Navigate to chat
                            openChat(starred.chatId, null);
                        });
                        
                        container.appendChild(messageDiv);
                    }
                }
            } catch (error) {
                console.error('Load starred error:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-icons-round">error_outline</span>
                        </div>
                        <div class="empty-title">Error</div>
                        <div class="empty-text">Failed to load starred messages</div>
                    </div>
                `;
            }
        }

        // ==================== BLOCKED USERS ====================
        async function loadBlockedUsers() {
            if (!currentUser) return;
            
            const container = document.getElementById('blockedList');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                    <span class="loading-state-text">Loading blocked users...</span>
                </div>
            `;
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('blocked')
                    .orderBy('blockedAt', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons-round">block</span>
                            </div>
                            <div class="empty-title">No blocked users</div>
                            <div class="empty-text">Users you block will appear here</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const blocked = doc.data();
                    const blockedId = doc.id;
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">
                            <img src="${generateAvatar(blocked.username)}" alt="">
                        </div>
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(blocked.username || 'Unknown')}</div>
                            <div class="user-username">Blocked</div>
                        </div>
                        <button class="send-request-btn" onclick="unblockUser('${blockedId}', '${blocked.username}')">
                            Unblock
                        </button>
                    `;
                    
                    container.appendChild(userItem);
                });
                
                // Update blocked count
                const count = snapshot.size;
                document.getElementById('blockedCount').textContent = `${count} blocked`;
                document.getElementById('blockedUsersCount').textContent = `${count} users`;
            } catch (error) {
                console.error('Load blocked error:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-icons-round">error_outline</span>
                        </div>
                        <div class="empty-title">Error</div>
                        <div class="empty-text">Failed to load blocked users</div>
                    </div>
                `;
            }
        }

        window.unblockUser = async function(blockedId, username) {
            if (!confirm(`Unblock ${username}?`)) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('blocked').doc(blockedId).delete();
                
                showToast('User unblocked');
                loadBlockedUsers();
            } catch (error) {
                console.error('Unblock error:', error);
                showToast('Failed to unblock user');
            }
        };

        // ==================== QR CODE ====================
        function generateQRCode() {
            if (!currentUserData?.username) return;
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear existing QR code
            
            const profileUrl = `https://whatsupg6753.web.app/user/${currentUserData.username}`;
            
            new QRCode(qrContainer, {
                text: profileUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('qrUsername').textContent = `@${currentUserData.username}`;
        }

        document.getElementById('shareQRBtn')?.addEventListener('click', async () => {
            if (!navigator.share) {
                showToast('Sharing not supported');
                return;
            }
            
            try {
                await navigator.share({
                    title: 'Connect with me on What\'s Up',
                    text: `Add me on What\'s Up: @${currentUserData.username}`,
                    url: `https://whatsupg6753.web.app/user/${currentUserData.username}`
                });
            } catch (error) {
                console.error('Share error:', error);
            }
        });

        document.getElementById('downloadQRBtn')?.addEventListener('click', () => {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `whatsup-qr-${currentUserData.username}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });

        // ==================== SEARCH ====================
        document.getElementById('searchBtn').addEventListener('click', () => {
            showScreen('searchScreen');
            document.getElementById('searchUserInput').value = '';
            document.getElementById('searchResultsSection').classList.add('hide');
            loadRecommendedUsers();
            setTimeout(() => document.getElementById('searchUserInput').focus(), 300);
            vibrate(3);
        });

        document.getElementById('newChatBtn').addEventListener('click', () => {
            showScreen('searchScreen');
            document.getElementById('searchUserInput').value = '';
            document.getElementById('searchResultsSection').classList.add('hide');
            loadRecommendedUsers();
            setTimeout(() => document.getElementById('searchUserInput').focus(), 300);
            vibrate(3);
        });

        document.getElementById('searchBackBtn').addEventListener('click', () => {
            showScreen('homeScreen');
        });

        document.getElementById('searchUserInput').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            if (query.length === 0) {
                document.getElementById('searchResultsSection').classList.add('hide');
                return;
            }
            
            searchUsers(query);
        });

        async function loadRecommendedUsers() {
            const container = document.getElementById('recommendedUsers');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                    <span class="loading-state-text">Loading users...</span>
                </div>
            `;
            
            try {
                const usersSnapshot = await db.collection('users')
                    .limit(20)
                    .get();
                
                container.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">No users found</div>';
                    return;
                }
                
                usersSnapshot.forEach((doc) => {
                    if (doc.id === currentUser.uid) return;
                    const userData = doc.data();
                    userData.uid = doc.id;
                    const userItem = createUserItem(doc.id, userData);
                    container.appendChild(userItem);
                });
            } catch (error) {
                console.error('Load users error:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">Failed to load users</div>';
            }
        }

        async function searchUsers(query) {
            const container = document.getElementById('searchResults');
            const section = document.getElementById('searchResultsSection');
            container.innerHTML = '';
            section.classList.remove('hide');
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('username', '>=', query)
                    .where('username', '<=', query + '\uf8ff')
                    .limit(20)
                    .get();
                
                if (usersSnapshot.empty) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">No users found</div>';
                    return;
                }
                
                usersSnapshot.forEach((doc) => {
                    if (doc.id === currentUser.uid) return;
                    const userData = doc.data();
                    userData.uid = doc.id;
                    const userItem = createUserItem(doc.id, userData);
                    container.appendChild(userItem);
                });
            } catch (error) {
                console.error('Search error:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">Search failed</div>';
            }
        }

        function createUserItem(userId, userData) {
            const div = document.createElement('div');
            div.className = 'user-item';
            
            div.innerHTML = `
                <div class="user-avatar">
                    <img src="${userData.photoURL || generateAvatar(userData.username)}" alt="">
                </div>
                <div class="user-info">
                    <div class="user-name">${escapeHtml(userData.displayName || userData.username)}</div>
                    <div class="user-username">@${escapeHtml(userData.username)}</div>
                </div>
                <button class="send-request-btn" data-userid="${userId}" data-username="${userData.username}">
                    Add
                </button>
            `;
            
            const btn = div.querySelector('.send-request-btn');
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                sendFriendRequest(userId, userData.username, btn);
            });
            
            return div;
        }

        async function sendFriendRequest(toUserId, toUsername, btn) {
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '...';
                
                if (currentUser.uid === toUserId) {
                    showToast('Cannot send request to yourself');
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }
                
                const chatId = generateChatId(currentUser.uid, toUserId);
                const chatDoc = await db.collection('chats').doc(chatId).get();
                
                if (chatDoc.exists) {
                    showToast('Already connected');
                    btn.textContent = 'Connected';
                    btn.classList.add('pending');
                    return;
                }
                
                const requestId = `${currentUser.uid}_${toUserId}`;
                const reverseRequestId = `${toUserId}_${currentUser.uid}`;
                
                const [req1, req2] = await Promise.all([
                    db.collection('friendRequests').doc(requestId).get(),
                    db.collection('friendRequests').doc(reverseRequestId).get()
                ]);
                
                if (req1.exists && req1.data().status === 'pending') {
                    showToast('Request already sent');
                    btn.textContent = 'Pending';
                    btn.classList.add('pending');
                    return;
                }
                
                if (req2.exists && req2.data().status === 'pending') {
                    await acceptRequestDirect(reverseRequestId, toUserId);
                    btn.textContent = 'Connected';
                    btn.classList.add('pending');
                    return;
                }
                
                await db.collection('friendRequests').doc(requestId).set({
                    fromUid: currentUser.uid,
                    fromUsername: currentUserData.username,
                    fromDisplayName: currentUserData.displayName || currentUserData.username,
                    fromPhotoURL: currentUserData.photoURL || '',
                    toUid: toUserId,
                    toUsername: toUsername,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Request sent!');
                btn.textContent = 'Sent';
                btn.classList.add('pending');
                vibrate(5);
                
            } catch (error) {
                console.error('Send request error:', error);
                btn.disabled = false;
                btn.textContent = originalText;
                showToast('Failed to send request');
            }
        }

        async function acceptRequestDirect(requestId, fromUid) {
            try {
                const chatId = generateChatId(currentUser.uid, fromUid);
                
                await db.collection('chats').doc(chatId).set({
                    participants: [currentUser.uid, fromUid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: '',
                    unreadCount: {
                        [currentUser.uid]: 0,
                        [fromUid]: 0
                    },
                    pinned: {},
                    muted: {},
                    archived: {}
                });
                
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'accepted'
                });
                
                showToast('Connected!');
                loadChats();
            } catch (error) {
                console.error('Accept direct error:', error);
            }
        }
        // ==================== REQUESTS ====================
        document.getElementById('requestsBtn').addEventListener('click', () => {
            showScreen('requestsScreen');
            loadRequests();
            vibrate(3);
        });

        document.getElementById('requestsBackBtn').addEventListener('click', () => {
            showScreen('homeScreen');
        });

        function listenForRequests() {
            if (!currentUser) return;
            
            db.collection('friendRequests')
                .where('toUid', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    const badge = document.getElementById('requestsBadge');
                    const sidebarBadge = document.getElementById('sidebarRequestsBadge');
                    const count = snapshot.size;
                    
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('hide');
                        if (sidebarBadge) {
                            sidebarBadge.textContent = count;
                            sidebarBadge.classList.remove('hide');
                        }
                    } else {
                        badge.classList.add('hide');
                        if (sidebarBadge) {
                            sidebarBadge.classList.add('hide');
                        }
                    }
                }, (error) => {
                    console.error('Listen requests error:', error);
                });
        }

        async function loadRequests() {
    const container = document.getElementById('requestsList');
    container.innerHTML = `
        <div class="loading-state">
            <div class="loading-state-spinner"></div>
            <span class="loading-state-text">Loading requests...</span>
        </div>
    `;
    
    try {
        // First try with ordering
        let snapshot;
        try {
            snapshot = await db.collection('friendRequests')
                .where('toUid', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
        } catch (indexError) {
            // Fallback: load without ordering if index doesn't exist
            console.log('Using fallback query (no index)');
            const allSnapshot = await db.collection('friendRequests')
                .where('toUid', '==', currentUser.uid)
                .get();
            
            // Filter manually
            const docs = allSnapshot.docs.filter(doc => doc.data().status === 'pending');
            snapshot = { empty: docs.length === 0, docs: docs, forEach: (fn) => docs.forEach(fn) };
        }
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons-round">person_add</span>
                            </div>
                            <div class="empty-title">No requests</div>
                            <div class="empty-text">Friend requests will appear here</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach((doc) => {
                    const request = doc.data();
                    const requestItem = createRequestItem(doc.id, request);
                    container.appendChild(requestItem);
                });
            } catch (error) {
                console.error('Load requests error:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-icons-round">error_outline</span>
                        </div>
                        <div class="empty-title">Error</div>
                        <div class="empty-text">Failed to load requests</div>
                    </div>
                `;
            }
        }

        function createRequestItem(requestId, requestData) {
            const div = document.createElement('div');
            div.className = 'request-item';
            div.id = `request-${requestId}`;
            
            div.innerHTML = `
                <div class="user-avatar">
                    <img src="${requestData.fromPhotoURL || generateAvatar(requestData.fromUsername)}" alt="">
                </div>
                <div class="request-content">
                    <div class="user-name">${escapeHtml(requestData.fromUsername)}</div>
                    <div class="request-text">wants to connect with you</div>
                </div>
                <div class="request-actions">
                    <button class="request-btn accept" data-request-id="${requestId}" data-from-uid="${requestData.fromUid}">Accept</button>
                    <button class="request-btn decline" data-request-id="${requestId}">Decline</button>
                </div>
            `;
            
            const acceptBtn = div.querySelector('.request-btn.accept');
            const declineBtn = div.querySelector('.request-btn.decline');
            
            acceptBtn.addEventListener('click', () => acceptRequest(requestId, requestData.fromUid, div));
            declineBtn.addEventListener('click', () => declineRequest(requestId, div));
            
            return div;
        }

        async function acceptRequest(requestId, fromUid, element) {
            try {
                const chatId = generateChatId(currentUser.uid, fromUid);
                
                await db.collection('chats').doc(chatId).set({
                    participants: [currentUser.uid, fromUid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: '',
                    unreadCount: {
                        [currentUser.uid]: 0,
                        [fromUid]: 0
                    },
                    pinned: {},
                    muted: {},
                    archived: {}
                });
                
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'accepted'
                });
                
                element.style.animation = 'slideUp 0.3s reverse forwards';
                setTimeout(() => element.remove(), 300);
                
                showToast('Request accepted!');
                loadChats();
                vibrate(5);
            } catch (error) {
                console.error('Accept error:', error);
                showToast('Failed to accept');
            }
        }

        async function declineRequest(requestId, element) {
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'declined'
                });
                
                element.style.animation = 'slideUp 0.3s reverse forwards';
                setTimeout(() => element.remove(), 300);
                
                showToast('Request declined');
            } catch (error) {
                console.error('Decline error:', error);
                showToast('Failed to decline');
            }
        }

        // ==================== CHAT SCREEN ====================
        document.getElementById('chatBackBtn').addEventListener('click', () => {
            if (messagesListener) {
                messagesListener();
                messagesListener = null;
            }
            cancelReply();
            showScreen('homeScreen');
        });

        document.getElementById('chatMenuBtn').addEventListener('click', () => {
            document.getElementById('chatOptionsSheet').classList.add('active');
        });

        document.getElementById('chatCallBtn').addEventListener('click', () => {
            showToast('Voice calls coming soon!');
        });

        document.getElementById('chatVideoBtn').addEventListener('click', () => {
            showToast('Video calls coming soon!');
        });

        async function openChat(chatId, userData) {
            currentChatId = chatId;
            
            // If userData not provided, fetch it
            if (!userData) {
                const chatDoc = await db.collection('chats').doc(chatId).get();
                if (!chatDoc.exists) return;
                
                const otherUserId = chatDoc.data().participants.find(id => id !== currentUser.uid);
                const userDoc = await db.collection('users').doc(otherUserId).get();
                if (!userDoc.exists) return;
                
                userData = userDoc.data();
                userData.uid = otherUserId;
            }
            
            currentChatUser = userData;
            
            showScreen('chatScreen');
            
            document.getElementById('chatUserAvatar').src = userData.photoURL || generateAvatar(userData.username);
            document.getElementById('chatUserName').textContent = userData.username || 'User';
            document.getElementById('messagesContainer').innerHTML = '';
            
            updateChatUserStatus(userData);
            loadMessages(chatId);
            markMessagesAsRead(chatId);
            
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 300);
        }

        function updateChatUserStatus(userData) {
            const statusEl = document.getElementById('chatUserStatus');
            const onlineDot = document.getElementById('chatUserOnlineDot');
            
            if (userData.online && userSettings.onlineStatus) {
                statusEl.textContent = 'online';
                statusEl.className = 'chat-user-status';
                onlineDot.classList.remove('hide');
            } else if (userData.lastSeen) {
                const lastSeen = userData.lastSeen.toDate ? formatLastSeen(userData.lastSeen.toDate()) : 'offline';
                statusEl.textContent = lastSeen;
                statusEl.className = 'chat-user-status';
                onlineDot.classList.add('hide');
            } else {
                statusEl.textContent = 'offline';
                onlineDot.classList.add('hide');
            }
            
            // Listen for typing
            if (currentChatId && userSettings.typingIndicator && userData.uid) {
                const typingRef = rtdb.ref(`typing/${currentChatId}/${userData.uid}`);
                typingRef.on('value', (snapshot) => {
                    if (snapshot.val()) {
                        statusEl.innerHTML = '<span class="typing-text">typing...</span>';
                    } else if (userData.online) {
                        statusEl.textContent = 'online';
                    }
                });
            }
        }

        function loadMessages(chatId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (messagesListener) {
                messagesListener();
            }
            
            let lastDate = null;
            
            messagesListener = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            message.id = change.doc.id;
                            
                            // Skip if deleted for current user
                            if (message.deletedFor?.includes(currentUser.uid)) return;
                            
                            // Add date divider if needed
                            if (message.timestamp) {
                                const messageDate = message.timestamp.toDate().toDateString();
                                if (messageDate !== lastDate) {
                                    lastDate = messageDate;
                                    addDateDivider(container, message.timestamp.toDate());
                                }
                            }
                            
                            displayMessage(message, container);
                        } else if (change.type === 'modified') {
                            const message = change.doc.data();
                            message.id = change.doc.id;
                            
                            if (message.deletedFor?.includes(currentUser.uid)) {
                                removeMessageDisplay(change.doc.id);
                            } else {
                                updateMessageDisplay(change.doc.id, message);
                            }
                        } else if (change.type === 'removed') {
                            removeMessageDisplay(change.doc.id);
                        }
                    });
                    
                    scrollToBottom();
                }, (error) => {
                    console.error('Load messages error:', error);
                });
        }

        function addDateDivider(container, date) {
            const divider = document.createElement('div');
            divider.className = 'date-divider';
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            let dateText;
            if (date.toDateString() === today.toDateString()) {
                dateText = 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateText = 'Yesterday';
            } else {
                dateText = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            
            divider.innerHTML = `<span class="date-label">${dateText}</span>`;
            container.appendChild(divider);
        }

        function displayMessage(message, container) {
            const isSent = message.senderId === currentUser.uid;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.id = `message-${message.id}`;
            messageDiv.dataset.messageId = message.id;
            
            const time = message.timestamp ? formatMessageTime(message.timestamp.toDate()) : '';
            
            let statusIcon = '';
            if (isSent) {
                if (message.read) {
                    statusIcon = '<span class="message-status read"><span class="material-icons-round">done_all</span></span>';
                } else if (message.delivered) {
                    statusIcon = '<span class="message-status"><span class="material-icons-round">done_all</span></span>';
                } else {
                    statusIcon = '<span class="message-status"><span class="material-icons-round">done</span></span>';
                }
            }
            
            let messageContent = '';
            
            // Reply preview
            if (message.replyTo) {
                messageContent += `
                    <div class="reply-preview-inline">
                        <div class="reply-preview-name">${escapeHtml(message.replyTo.username)}</div>
                        <div class="reply-preview-text">${escapeHtml(message.replyTo.text || 'Media')}</div>
                    </div>
                `;
            }
            
            // Media content
            if (message.mediaType === 'image') {
                messageContent += `<img src="${message.mediaUrl}" style="max-width: 100%; border-radius: 10px; margin-bottom: 4px; cursor: pointer;" onclick="viewImage('${message.mediaUrl}')">`;
            } else if (message.mediaType === 'video') {
                messageContent += `<video src="${message.mediaUrl}" controls style="max-width: 100%; border-radius: 10px; margin-bottom: 4px;"></video>`;
            } else if (message.mediaType === 'document') {
                messageContent += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 4px;">
                        <span class="material-icons-round" style="font-size: 20px;">description</span>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; font-size: 13px;">${escapeHtml(message.fileName || 'Document')}</span>
                        <a href="${message.mediaUrl}" target="_blank" style="color: inherit;">
                            <span class="material-icons-round" style="font-size: 20px;">download</span>
                        </a>
                    </div>
                `;
            }
            
            // Text content
            if (message.text) {
                messageContent += `<div class="message-text">${formatMessageText(message.text)}</div>`;
            }
            
            // Edited indicator
            if (message.edited) {
                messageContent += `<span style="font-size: 9px; opacity: 0.5; margin-left: 4px;">edited</span>`;
            }
            
            // Reactions
            if (message.reactions && Object.keys(message.reactions).length > 0) {
                const reactionCounts = {};
                Object.values(message.reactions).forEach(emoji => {
                    reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                });
                
                messageContent += '<div class="message-reactions">';
                Object.entries(reactionCounts).forEach(([emoji, count]) => {
                    messageContent += `
                        <div class="reaction" data-message-id="${message.id}" data-emoji="${emoji}">
                            <span class="reaction-emoji">${emoji}</span>
                            ${count > 1 ? `<span class="reaction-count">${count}</span>` : ''}
                        </div>
                    `;
                });
                messageContent += '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${messageContent}
                    <div class="message-footer">
                        <span class="message-time">${time}</span>
                        ${statusIcon}
                    </div>
                </div>
            `;
            
            // Add reaction click handlers
            messageDiv.querySelectorAll('.reaction').forEach(r => {
                r.addEventListener('click', () => {
                    addReaction(r.dataset.messageId, r.dataset.emoji);
                });
            });
            
            // Long press for context menu
            let pressTimer;
            const bubble = messageDiv.querySelector('.message-bubble');
            
            bubble.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    vibrate(10);
                    showMessageContextMenu(message, e);
                }, 500);
            });
            bubble.addEventListener('touchend', () => clearTimeout(pressTimer));
            bubble.addEventListener('touchmove', () => clearTimeout(pressTimer));
            
            // Double tap for quick reaction
            let lastTap = 0;
            bubble.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    showQuickReactions(message, bubble);
                }
                lastTap = currentTime;
            });
            
            // Desktop right-click
            bubble.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(message, e);
            });
            
            container.appendChild(messageDiv);
        }

        function formatMessageText(text) {
            if (!text) return '';
            
            // First escape HTML
            let escaped = escapeHtml(text);
            
            // Then apply formatting
            // Bold: *text*
            escaped = escaped.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
            // Italic: _text_
            escaped = escaped.replace(/_([^_]+)_/g, '<em>$1</em>');
            // Code: `text`
            escaped = escaped.replace(/`([^`]+)`/g, '<code style="background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 4px; font-size: 13px;">$1</code>');
            // Links
            escaped = escaped.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');
            // Line breaks
            escaped = escaped.replace(/\n/g, '<br>');
            
            return escaped;
        }

        function updateMessageDisplay(messageId, data) {
            const messageEl = document.getElementById(`message-${messageId}`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl && data.read) {
                    statusEl.classList.add('read');
                }
            }
        }

        function removeMessageDisplay(messageId) {
            const messageEl = document.getElementById(`message-${messageId}`);
            if (messageEl) {
                messageEl.style.animation = 'messageIn 0.2s reverse forwards';
                setTimeout(() => messageEl.remove(), 200);
            }
        }

        // ==================== MESSAGE CONTEXT MENU ====================
        function showMessageContextMenu(message, event) {
            selectedMessage = message;
            const menu = document.getElementById('messageContextMenu');
            
            const touch = event.touches?.[0] || event;
            const rect = event.target.getBoundingClientRect();
            
            let top = rect.top - 10;
            let left = rect.left;
            
            // Adjust position to stay on screen
            if (top + 250 > window.innerHeight) {
                top = window.innerHeight - 260;
            }
            if (top < 60) top = 60;
            
            if (left + 170 > window.innerWidth) {
                left = window.innerWidth - 180;
            }
            if (left < 10) left = 10;
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            // Show/hide edit option based on ownership
            const editOption = menu.querySelector('[data-action="edit"]');
            if (message.senderId === currentUser.uid && message.text) {
                editOption.style.display = 'flex';
            } else {
                editOption.style.display = 'none';
            }
            
            menu.classList.add('active');
            
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
                document.addEventListener('touchstart', closeContextMenu);
            }, 10);
        }

        function closeContextMenu() {
            document.getElementById('messageContextMenu').classList.remove('active');
            document.getElementById('quickReactions').classList.remove('active');
            document.removeEventListener('click', closeContextMenu);
            document.removeEventListener('touchstart', closeContextMenu);
        }

        // Context menu actions
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const action = item.dataset.action;
                
                switch(action) {
                    case 'reply':
                        replyToMessage(selectedMessage);
                        break;
                    case 'copy':
                        copyMessage(selectedMessage);
                        break;
                    case 'forward':
                        forwardMessage(selectedMessage);
                        break;
                    case 'star':
                        starMessage(selectedMessage);
                        break;
                    case 'edit':
                        editMessage(selectedMessage);
                        break;
                    case 'delete':
                        deleteMessage(selectedMessage);
                        break;
                }
                
                closeContextMenu();
            });
        });

        function replyToMessage(message) {
            replyingTo = message;
            
            const inputBar = document.getElementById('inputBar');
            let replyBar = inputBar.querySelector('.reply-bar');
            
            if (!replyBar) {
                replyBar = document.createElement('div');
                replyBar.className = 'reply-bar';
                inputBar.insertBefore(replyBar, inputBar.firstChild);
            }
            
            const senderName = message.senderId === currentUser.uid ? 'You' : (currentChatUser?.username || 'User');
            
            replyBar.innerHTML = `
                <div class="reply-bar-content">
                    <div class="reply-bar-name">${escapeHtml(senderName)}</div>
                    <div class="reply-bar-text">${escapeHtml(message.text || 'Media')}</div>
                </div>
                <button class="reply-bar-close" onclick="cancelReply()">
                    <span class="material-icons-round">close</span>
                </button>
            `;
            
            document.getElementById('messageInput').focus();
        }

        window.cancelReply = function() {
            replyingTo = null;
            const replyBar = document.querySelector('.reply-bar');
            if (replyBar) replyBar.remove();
        };

        function copyMessage(message) {
            if (message.text) {
                navigator.clipboard.writeText(message.text).then(() => {
                    showToast('Copied to clipboard');
                    vibrate(3);
                }).catch(() => {
                    showToast('Failed to copy');
                });
            }
        }

        function forwardMessage(message) {
            forwardingMessage = message;
            selectedForwardUsers = [];
            loadForwardList();
            showModal('forwardModal');
        }

        async function loadForwardList() {
            const container = document.getElementById('forwardList');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-state-spinner"></div>
                </div>
            `;
            
            try {
                const chatsSnapshot = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                container.innerHTML = '';
                
                for (const doc of chatsSnapshot.docs) {
                    const chat = doc.data();
                    const otherUserId = chat.participants.find(id => id !== currentUser.uid);
                    
                    const userDoc = await db.collection('users').doc(otherUserId).get();
                    if (!userDoc.exists) continue;
                    
                    const userData = userDoc.data();
                    
                    const item = document.createElement('div');
                    item.className = 'forward-item';
                    item.dataset.chatId = doc.id;
                    item.dataset.userId = otherUserId;
                    
                    item.innerHTML = `
                        <div class="forward-item-avatar">
                            <img src="${userData.photoURL || generateAvatar(userData.username)}" alt="">
                        </div>
                        <div class="forward-item-info">
                            <div class="forward-item-name">${escapeHtml(userData.username)}</div>
                        </div>
                        <div class="forward-item-check">
                            <span class="material-icons-round">check</span>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        item.classList.toggle('selected');
                        const chatId = item.dataset.chatId;
                        
                        if (item.classList.contains('selected')) {
                            selectedForwardUsers.push({ chatId, userId: otherUserId });
                        } else {
                            selectedForwardUsers = selectedForwardUsers.filter(u => u.chatId !== chatId);
                        }
                        
                        document.getElementById('confirmForwardBtn').disabled = selectedForwardUsers.length === 0;
                    });
                    
                    container.appendChild(item);
                }
                
                if (container.children.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">No contacts to forward to</div>';
                }
            } catch (error) {
                console.error('Load forward list error:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--secondary-text);">Failed to load contacts</div>';
            }
        }
        document.getElementById('confirmForwardBtn').addEventListener('click', async () => {
            if (!forwardingMessage || selectedForwardUsers.length === 0) return;
            
            hideModal('forwardModal');
            showLoading(true);
            
            try {
                for (const { chatId, userId } of selectedForwardUsers) {
                    const forwardedMessage = {
                        text: forwardingMessage.text || '',
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        delivered: false,
                        read: false,
                        forwarded: true
                    };
                    
                    if (forwardingMessage.mediaType) {
                        forwardedMessage.mediaType = forwardingMessage.mediaType;
                        forwardedMessage.mediaUrl = forwardingMessage.mediaUrl;
                        forwardedMessage.fileName = forwardingMessage.fileName;
                    }
                    
                    await db.collection('chats').doc(chatId).collection('messages').add(forwardedMessage);
                    
                    await db.collection('chats').doc(chatId).update({
                        lastMessage: forwardingMessage.text || ` ${forwardingMessage.mediaType || 'Media'}`,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount.${userId}`]: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                showToast(`Forwarded to ${selectedForwardUsers.length} chat${selectedForwardUsers.length > 1 ? 's' : ''}`);
                vibrate(5);
            } catch (error) {
                console.error('Forward error:', error);
                showToast('Failed to forward');
            } finally {
                showLoading(false);
                forwardingMessage = null;
                selectedForwardUsers = [];
            }
        });

        document.getElementById('cancelForwardBtn').addEventListener('click', () => {
            hideModal('forwardModal');
            forwardingMessage = null;
            selectedForwardUsers = [];
        });

        document.getElementById('forwardSearchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.forward-item').forEach(item => {
                const name = item.querySelector('.forward-item-name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        });

        async function starMessage(message) {
            try {
                // Get chat partner info
                let chatWith = 'Unknown';
                if (currentChatUser) {
                    chatWith = currentChatUser.username;
                }
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('starredMessages')
                    .doc(message.id)
                    .set({
                        chatId: currentChatId,
                        messageId: message.id,
                        text: message.text || '',
                        mediaType: message.mediaType || null,
                        timestamp: message.timestamp,
                        chatWith: chatWith,
                        starredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showToast('Message starred');
                vibrate(3);
            } catch (error) {
                console.error('Star error:', error);
                showToast('Failed to star message');
            }
        }

        function editMessage(message) {
            if (message.senderId !== currentUser.uid || !message.text) return;
            
            const input = document.getElementById('messageInput');
            input.value = message.text;
            input.dataset.editingId = message.id;
            input.focus();
            
            // Auto resize
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            
            document.getElementById('sendBtn').classList.add('active');
            document.getElementById('sendBtn').innerHTML = '<span class="material-icons-round">check</span>';
        }

        async function deleteMessage(message) {
            const isSent = message.senderId === currentUser.uid;
            
            if (isSent) {
                const deleteForEveryone = confirm('Delete for everyone?\n\nOK = Delete for everyone\nCancel = Delete for me only');
                
                try {
                    if (deleteForEveryone) {
                        await db.collection('chats').doc(currentChatId)
                            .collection('messages').doc(message.id).delete();
                        showToast('Deleted for everyone');
                    } else {
                        await db.collection('chats').doc(currentChatId)
                            .collection('messages').doc(message.id)
                            .update({ deletedFor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                        showToast('Deleted for you');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('Failed to delete');
                }
            } else {
                try {
                    await db.collection('chats').doc(currentChatId)
                        .collection('messages').doc(message.id)
                        .update({ deletedFor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    showToast('Deleted for you');
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('Failed to delete');
                }
            }
            
            vibrate(5);
        }

        // ==================== QUICK REACTIONS ====================
        function showQuickReactions(message, element) {
            selectedMessage = message;
            const reactions = document.getElementById('quickReactions');
            const rect = element.getBoundingClientRect();
            
            let top = rect.top - 50;
            if (top < 60) top = rect.bottom + 10;
            
            let left = rect.left + (rect.width / 2) - 120;
            if (left < 10) left = 10;
            if (left + 240 > window.innerWidth) left = window.innerWidth - 250;
            
            reactions.style.top = `${top}px`;
            reactions.style.left = `${left}px`;
            reactions.classList.add('active');
        }

        document.querySelectorAll('.quick-reaction').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const emoji = item.dataset.emoji;
                if (selectedMessage) {
                    addReaction(selectedMessage.id, emoji);
                }
                closeContextMenu();
            });
        });

        async function addReaction(messageId, emoji) {
            try {
                const currentReaction = await db.collection('chats').doc(currentChatId)
                    .collection('messages').doc(messageId).get();
                
                const reactions = currentReaction.data()?.reactions || {};
                
                if (reactions[currentUser.uid] === emoji) {
                    // Remove reaction if same
                    await db.collection('chats').doc(currentChatId)
                        .collection('messages').doc(messageId)
                        .update({
                            [`reactions.${currentUser.uid}`]: firebase.firestore.FieldValue.delete()
                        });
                } else {
                    // Add/change reaction
                    await db.collection('chats').doc(currentChatId)
                        .collection('messages').doc(messageId)
                        .update({
                            [`reactions.${currentUser.uid}`]: emoji
                        });
                }
                
                vibrate(3);
            } catch (error) {
                console.error('Reaction error:', error);
            }
        }

        // ==================== MESSAGE INPUT ====================
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        messageInput.addEventListener('input', (e) => {
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            
            if (textarea.value.trim()) {
                sendBtn.classList.add('active');
                document.getElementById('scheduleBtn').classList.add('show');
            } else {
                sendBtn.classList.remove('active');
                document.getElementById('scheduleBtn').classList.remove('show');
            }
            
            // Typing indicator
            if (currentChatId && userSettings.typingIndicator) {
                const typingRef = rtdb.ref(`typing/${currentChatId}/${currentUser.uid}`);
                typingRef.set(true);
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    typingRef.remove();
                }, 1500);
            }
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && userSettings.enterToSend) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        async function sendMessage(scheduledTime = null) {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChatId) return;
            
            const editingId = input.dataset.editingId;
            
            try {
                if (editingId) {
                    // Edit existing message
                    await db.collection('chats').doc(currentChatId)
                        .collection('messages').doc(editingId)
                        .update({
                            text: text,
                            edited: true,
                            editedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    delete input.dataset.editingId;
                    sendBtn.innerHTML = '<span class="material-icons-round">send</span>';
                    showToast('Message edited');
                } else if (scheduledTime) {
                    // Schedule message
                    const scheduledMessage = {
                        chatId: currentChatId,
                        text: text,
                        scheduledTime: scheduledTime.getTime(),
                        replyTo: replyingTo ? {
                            messageId: replyingTo.id,
                            text: replyingTo.text,
                            username: replyingTo.senderId === currentUser.uid ? 'You' : currentChatUser?.username
                        } : null
                    };
                    
                    scheduledMessages.push(scheduledMessage);
                    localStorage.setItem('scheduledMessages', JSON.stringify(scheduledMessages));
                    
                    cancelReply();
                    showToast(`Message scheduled for ${scheduledTime.toLocaleString()}`);
                } else {
                    // Send new message immediately
                    const messageData = {
                        text: text,
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        delivered: false,
                        read: false
                    };
                    
                    if (replyingTo) {
                        messageData.replyTo = {
                            messageId: replyingTo.id,
                            text: replyingTo.text,
                            username: replyingTo.senderId === currentUser.uid ? 'You' : currentChatUser?.username
                        };
                        cancelReply();
                    }
                    
                    await db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
                    
                    await db.collection('chats').doc(currentChatId).update({
                        lastMessage: text,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount.${currentChatUser.uid}`]: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                input.value = '';
                input.style.height = 'auto';
                sendBtn.classList.remove('active');
                document.getElementById('scheduleBtn').classList.remove('show');
                
                // Clear typing
                if (currentChatId) {
                    const typingRef = rtdb.ref(`typing/${currentChatId}/${currentUser.uid}`);
                    typingRef.remove();
                }
                
                vibrate(3);
                
            } catch (error) {
                console.error('Send error:', error);
                showToast('Failed to send');
            }
        }

        // ==================== SCHEDULE MESSAGE ====================
        document.getElementById('scheduleBtn').addEventListener('click', () => {
            const now = new Date();
            document.getElementById('scheduleDate').value = now.toISOString().split('T')[0];
            document.getElementById('scheduleTime').value = now.toTimeString().slice(0, 5);
            showModal('scheduleModal');
        });

        document.getElementById('confirmScheduleBtn').addEventListener('click', () => {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date || !time) {
                showToast('Please select date and time');
                return;
            }
            
            const scheduledTime = new Date(`${date}T${time}`);
            
            if (scheduledTime <= new Date()) {
                showToast('Please select a future time');
                return;
            }
            
            hideModal('scheduleModal');
            sendMessage(scheduledTime);
        });

        document.getElementById('cancelScheduleBtn').addEventListener('click', () => {
            hideModal('scheduleModal');
        });

        function checkScheduledMessages() {
            // Load from localStorage
            const stored = localStorage.getItem('scheduledMessages');
            if (stored) {
                try {
                    scheduledMessages = JSON.parse(stored);
                } catch (e) {
                    scheduledMessages = [];
                }
            }
            
            // Check every minute
            setInterval(async () => {
                const now = Date.now();
                const toSend = scheduledMessages.filter(m => m.scheduledTime <= now);
                
                for (const msg of toSend) {
                    try {
                        const messageData = {
                            text: msg.text,
                            senderId: currentUser.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            delivered: false,
                            read: false
                        };
                        
                        if (msg.replyTo) {
                            messageData.replyTo = msg.replyTo;
                        }
                        
                        await db.collection('chats').doc(msg.chatId).collection('messages').add(messageData);
                        
                        // Get other user ID for unread count
                        const chatDoc = await db.collection('chats').doc(msg.chatId).get();
                        if (chatDoc.exists) {
                            const otherUserId = chatDoc.data().participants.find(id => id !== currentUser.uid);
                            
                            await db.collection('chats').doc(msg.chatId).update({
                                lastMessage: msg.text,
                                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                                [`unreadCount.${otherUserId}`]: firebase.firestore.FieldValue.increment(1)
                            });
                        }
                        
                        // Remove from scheduled
                        scheduledMessages = scheduledMessages.filter(m => m !== msg);
                        localStorage.setItem('scheduledMessages', JSON.stringify(scheduledMessages));
                        
                    } catch (error) {
                        console.error('Send scheduled message error:', error);
                    }
                }
            }, 60000); // Check every minute
        }

        async function markMessagesAsRead(chatId) {
            if (!userSettings.readReceipts) return;
            
            try {
                const messagesSnapshot = await db.collection('chats').doc(chatId)
                    .collection('messages')
                    .where('senderId', '!=', currentUser.uid)
                    .where('read', '==', false)
                    .get();
                
                if (messagesSnapshot.empty) return;
                
                const batch = db.batch();
                messagesSnapshot.forEach((doc) => {
                    batch.update(doc.ref, { read: true, delivered: true });
                });
                
                await batch.commit();
                
                await db.collection('chats').doc(chatId).update({
                    [`unreadCount.${currentUser.uid}`]: 0
                });
            } catch (error) {
                console.error('Mark read error:', error);
            }
        }

        // ==================== EMOJI PICKER ====================
        document.getElementById('emojiBtn').addEventListener('click', () => {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
            if (picker.classList.contains('active')) {
                loadEmojis('smileys');
            }
            vibrate(3);
        });

        document.querySelectorAll('.emoji-category').forEach(cat => {
            cat.addEventListener('click', () => {
                document.querySelectorAll('.emoji-category').forEach(c => c.classList.remove('active'));
                cat.classList.add('active');
                loadEmojis(cat.dataset.category);
            });
        });

        function loadEmojis(category) {
            const grid = document.getElementById('emojiGrid');
            if (!emojis[category]) return;
            
            grid.innerHTML = emojis[category].map(emoji => 
                `<div class="emoji-item" data-emoji="${emoji}">${emoji}</div>`
            ).join('');
            
            grid.querySelectorAll('.emoji-item').forEach(item => {
                item.addEventListener('click', () => {
                    insertEmoji(item.dataset.emoji);
                });
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
            
            sendBtn.classList.add('active');
            document.getElementById('scheduleBtn').classList.add('show');
            vibrate(2);
        }

        // ==================== FILE UPLOAD ====================
        document.getElementById('attachBtn').addEventListener('click', () => {
            document.getElementById('attachmentSheet').classList.add('active');
            vibrate(3);
        });

        document.getElementById('closeAttachmentSheet').addEventListener('click', () => {
            document.getElementById('attachmentSheet').classList.remove('active');
        });

        document.getElementById('attachmentSheet').addEventListener('click', (e) => {
            if (e.target.classList.contains('action-sheet-overlay')) {
                document.getElementById('attachmentSheet').classList.remove('active');
            }
        });

        document.querySelectorAll('[data-attach]').forEach(item => {
            item.addEventListener('click', () => {
                const type = item.dataset.attach;
                document.getElementById('attachmentSheet').classList.remove('active');
                
                const fileInput = document.getElementById('fileInput');
                
                switch(type) {
                    case 'photo':
                        fileInput.accept = 'image/*';
                        fileInput.removeAttribute('capture');
                        fileInput.click();
                        break;
                    case 'video':
                        fileInput.accept = 'video/*';
                        fileInput.removeAttribute('capture');
                        fileInput.click();
                        break;
                    case 'document':
                        fileInput.accept = '.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx';
                        fileInput.removeAttribute('capture');
                        fileInput.click();
                        break;
                    case 'location':
                        shareLocation();
                        break;
                }
            });
        });

        document.getElementById('cameraBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('fileInput');
            fileInput.accept = 'image/*';
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > STORAGE_LIMITS.maxFileSize) {
                showToast('File too large (max 1MB)');
                e.target.value = '';
                return;
            }
            
            if (storageUsage.daily + file.size > STORAGE_LIMITS.dailyLimit) {
                showToast('Daily upload limit reached (5MB)');
                e.target.value = '';
                return;
            }
            
            if (storageUsage.total + file.size > STORAGE_LIMITS.lifetimeLimit) {
                showToast('Storage limit reached (100MB)');
                e.target.value = '';
                return;
            }
            
            await uploadFile(file);
            e.target.value = '';
        });

        async function uploadFile(file) {
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadFileName = document.getElementById('uploadFileName');
            const uploadFileSize = document.getElementById('uploadFileSize');
            const uploadBarFill = document.getElementById('uploadBarFill');
            
            uploadFileName.textContent = file.name;
            uploadFileSize.textContent = formatFileSize(file.size);
            uploadBarFill.style.width = '0%';
            uploadProgress.classList.add('active');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                formData.append('cloud_name', cloudinaryConfig.cloudName);
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        uploadBarFill.style.width = `${percent}%`;
                    }
                });
                
                xhr.onload = async () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        
                        let mediaType = 'document';
                        if (file.type.startsWith('image/')) mediaType = 'image';
                        else if (file.type.startsWith('video/')) mediaType = 'video';
                        
                        await db.collection('chats').doc(currentChatId).collection('messages').add({
                            senderId: currentUser.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            mediaType: mediaType,
                            mediaUrl: response.secure_url,
                            fileName: file.name,
                            fileSize: file.size,
                            delivered: false,
                            read: false
                        });
                        
                        const lastMessageText = mediaType === 'image' ? ' Photo' : mediaType === 'video' ? ' Video' : ' Document';
                        
                        await db.collection('chats').doc(currentChatId).update({
                            lastMessage: lastMessageText,
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                            [`unreadCount.${currentChatUser.uid}`]: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        // Update storage usage
                        storageUsage.daily += file.size;
                        storageUsage.total += file.size;
                        if (mediaType === 'image') storageUsage.photos += file.size;
                        else if (mediaType === 'video') storageUsage.videos += file.size;
                        else storageUsage.documents += file.size;
                        
                        saveStorageUsage();
                        
                        showToast('File sent');
                        vibrate(5);
                    } else {
                        throw new Error('Upload failed');
                    }
                    
                    uploadProgress.classList.remove('active');
                };
                
                xhr.onerror = () => {
                    showToast('Upload failed');
                    uploadProgress.classList.remove('active');
                };
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`);
                xhr.send(formData);
                
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed');
                uploadProgress.classList.remove('active');
            }
        }

        function shareLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported');
                return;
            }
            
            showLoading(true);
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const mapUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                
                try {
                    await db.collection('chats').doc(currentChatId).collection('messages').add({
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        text: ` Location: ${mapUrl}`,
                        location: { latitude, longitude },
                        delivered: false,
                        read: false
                    });
                    
                    await db.collection('chats').doc(currentChatId).update({
                        lastMessage: ' Location',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount.${currentChatUser.uid}`]: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    showToast('Location shared');
                    vibrate(5);
                } catch (error) {
                    console.error('Share location error:', error);
                    showToast('Failed to share location');
                }
                
                showLoading(false);
            }, (error) => {
                showLoading(false);
                showToast('Failed to get location');
                console.error('Geolocation error:', error);
            }, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        }
        // ==================== PROFILE EDIT ====================
        document.getElementById('profileFab').addEventListener('click', () => {
            showScreen('profileScreen');
            loadProfileData();
            vibrate(3);
        });

        document.getElementById('profileBackBtn').addEventListener('click', () => {
            showScreen('homeScreen');
        });

        function loadProfileData() {
            if (currentUserData) {
                document.getElementById('profileAvatarLarge').src = currentUserData.photoURL || generateAvatar(currentUserData.username);
                document.getElementById('profileName').value = currentUserData.displayName || '';
                document.getElementById('profileUsername').value = '@' + (currentUserData.username || '');
                document.getElementById('profileBio').value = currentUserData.bio || '';
                document.getElementById('profileEmail').value = currentUser?.email || '';
                
                updateCharCount('profileName', 'nameCount', 30);
                updateCharCount('profileBio', 'bioCount', 150);
                
                document.getElementById('saveProfileBtn').disabled = true;
            }
        }

        document.getElementById('profileName').addEventListener('input', () => {
            updateCharCount('profileName', 'nameCount', 30);
            document.getElementById('saveProfileBtn').disabled = false;
        });

        document.getElementById('profileBio').addEventListener('input', () => {
            updateCharCount('profileBio', 'bioCount', 150);
            document.getElementById('saveProfileBtn').disabled = false;
        });

        function updateCharCount(inputId, countId, max) {
            const input = document.getElementById(inputId);
            const count = document.getElementById(countId);
            count.textContent = input.value.length;
            count.style.color = input.value.length >= max ? 'var(--error-red)' : 'var(--tertiary-text)';
        }

        document.getElementById('changeAvatarBtn').addEventListener('click', () => {
            document.getElementById('avatarInput').click();
        });

        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > STORAGE_LIMITS.maxFileSize) {
                showToast('Image too large (max 1MB)');
                e.target.value = '';
                return;
            }
            
            showLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
                    { method: 'POST', body: formData }
                );
                
                const data = await response.json();
                
                if (data.secure_url) {
                    document.getElementById('profileAvatarLarge').src = data.secure_url;
                    document.getElementById('saveProfileBtn').disabled = false;
                    showToast('Photo updated');
                } else {
                    throw new Error('No URL returned');
                }
            } catch (error) {
                console.error('Avatar upload error:', error);
                showToast('Failed to upload photo');
            } finally {
                showLoading(false);
                e.target.value = '';
            }
        });

        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            showLoading(true);
            
            try {
                const updates = {
                    displayName: document.getElementById('profileName').value.trim(),
                    bio: document.getElementById('profileBio').value.trim(),
                    photoURL: document.getElementById('profileAvatarLarge').src
                };
                
                await db.collection('users').doc(currentUser.uid).update(updates);
                
                currentUserData = { ...currentUserData, ...updates };
                updateSidebarUser();
                
                document.getElementById('saveProfileBtn').disabled = true;
                showToast('Profile saved');
                vibrate(5);
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save');
            } finally {
                showLoading(false);
            }
        });

        // ==================== SETTINGS ====================
        document.getElementById('settingsBackBtn').addEventListener('click', () => {
            showScreen('homeScreen');
        });

        document.getElementById('privacyBackBtn').addEventListener('click', () => {
            showScreen('settingsScreen');
        });

        document.getElementById('storageBackBtn').addEventListener('click', () => {
            showScreen('settingsScreen');
        });

        // Settings item clicks
        document.querySelectorAll('.settings-item[data-setting]').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-switch')) return;
                
                const setting = item.dataset.setting;
                
                switch(setting) {
                    case 'edit-profile':
                        showScreen('profileScreen');
                        loadProfileData();
                        break;
                    case 'qr-code':
                        showScreen('qrScreen');
                        generateQRCode();
                        break;
                    case 'theme':
                        showModal('themeModal');
                        break;
                    case 'last-seen':
                        showPrivacyOption('last-seen', 'Last Seen');
                        break;
                    case 'blocked-users':
                        showScreen('blockedScreen');
                        loadBlockedUsers();
                        break;
                    case 'storage-usage':
                        showScreen('storageScreen');
                        updateStorageDisplay();
                        break;
                    case 'clear-cache':
                        clearCache();
                        break;
                    case 'wallpaper':
    showWallpaperModal();
    break;
case 'help':
    showHelpCenter();
    break;
case 'about':
    showAboutScreen();
    break;
                }
                
                vibrate(2);
            });
        });

        // Settings items on privacy screen
        document.querySelectorAll('[data-privacy]').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-switch')) return;
                
                const setting = item.dataset.privacy;
                
                switch(setting) {
                    case 'last-seen':
                        showPrivacyOption('last-seen', 'Last Seen');
                        break;
                    case 'profile-photo':
                        showPrivacyOption('profile-photo', 'Profile Photo');
                        break;
                    case 'online':
                        showPrivacyOption('online', 'Online Status');
                        break;
                    case 'blocked':
                        showScreen('blockedScreen');
                        loadBlockedUsers();
                        break;
                }
            });
        });

        // Storage screen items
        document.querySelectorAll('[data-storage]').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.storage;
                
                switch(action) {
                    case 'clear-all':
                        clearCache();
                        break;
                    case 'photos':
                    case 'videos':
                    case 'documents':
                        showToast('Coming soon!');
                        break;
                }
            });
        });

        // Toggle switches
        document.querySelectorAll('.toggle-switch').forEach(toggle => {
            toggle.addEventListener('click', async () => {
                toggle.classList.toggle('active');
                const isActive = toggle.classList.contains('active');
                
                const settingMap = {
                    'onlineStatusToggle': 'onlineStatus',
                    'readReceiptsToggle': 'readReceipts',
                    'typingIndicatorToggle': 'typingIndicator',
                    'enterToSendToggle': 'enterToSend',
                    'messageNotifToggle': 'messageNotifications',
                    'vibrationToggle': 'vibration',
                    'autoDownloadToggle': 'autoDownload',
                    'dataSaverToggle': 'dataSaver',
                    'aiAutoReplyToggle': 'aiAutoReply',
                    'aiTranslateToggle': 'aiTranslate',
                    'aiSummaryToggle': 'aiSummary',
                    'aiSpamToggle': 'aiSpam',
                    'privacyReadReceipts': 'readReceipts',
                    'privacyTyping': 'typingIndicator',
                    'storageAutoDownload': 'autoDownload',
                    'storageDataSaver': 'dataSaver'
                };
                
                const settingKey = settingMap[toggle.id];
                if (settingKey) {
                    userSettings[settingKey] = isActive;
                    saveUserSettings();
                    
                    // Update presence if online status changed
                    if (settingKey === 'onlineStatus') {
                        setupPresence();
                    }
                }
                
                vibrate(3);
            });
        });

        // Theme selection
        document.querySelectorAll('.theme-option').forEach(item => {
            item.addEventListener('click', () => {
                const theme = item.dataset.theme;
                setTheme(theme);
                hideModal('themeModal');
                
                document.querySelectorAll('.theme-check').forEach(check => {
                    check.style.color = 'transparent';
                });
                item.querySelector('.theme-check').style.color = 'var(--online-green)';
                
                document.getElementById('themeValue').textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
            });
        });

        document.getElementById('closeThemeModal').addEventListener('click', () => {
            hideModal('themeModal');
        });

        function setTheme(theme) {
            userSettings.theme = theme;
            
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // Update theme toggle icon
            const themeIcon = document.querySelector('#sidebarThemeToggle .material-icons-round');
            if (themeIcon) {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                themeIcon.textContent = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';
            }
            
            saveUserSettings();
        }

        function showPrivacyOption(setting, title) {
            const modal = document.getElementById('privacyOptionModal');
            const titleEl = document.getElementById('privacyOptionTitle');
            
            titleEl.textContent = title;
            modal.dataset.setting = setting;
            
            // Update checkmarks
            const settingKey = setting === 'last-seen' ? 'lastSeen' : setting === 'profile-photo' ? 'profilePhoto' : setting;
            const currentValue = userSettings.privacy[settingKey] || 'everyone';
            
            document.querySelectorAll('.privacy-option').forEach(opt => {
                const check = opt.querySelector('.privacy-check');
                check.style.color = opt.dataset.value === currentValue ? 'var(--online-green)' : 'transparent';
            });
            
            showModal('privacyOptionModal');
        }

        document.querySelectorAll('.privacy-option').forEach(item => {
            item.addEventListener('click', () => {
                const value = item.dataset.value;
                const setting = document.getElementById('privacyOptionModal').dataset.setting;
                
                document.querySelectorAll('.privacy-option .privacy-check').forEach(check => {
                    check.style.color = 'transparent';
                });
                item.querySelector('.privacy-check').style.color = 'var(--online-green)';
                
                const displayValue = value.charAt(0).toUpperCase() + value.slice(1);
                
                if (setting === 'last-seen') {
                    userSettings.privacy.lastSeen = value;
                    document.getElementById('lastSeenValue').textContent = displayValue;
                    if (document.getElementById('privacyLastSeen')) {
                        document.getElementById('privacyLastSeen').textContent = displayValue;
                    }
                } else if (setting === 'profile-photo') {
                    userSettings.privacy.profilePhoto = value;
                    if (document.getElementById('privacyPhoto')) {
                        document.getElementById('privacyPhoto').textContent = displayValue;
                    }
                } else if (setting === 'online') {
                    userSettings.privacy.online = value;
                    if (document.getElementById('privacyOnline')) {
                        document.getElementById('privacyOnline').textContent = displayValue;
                    }
                }
                
                saveUserSettings();
                hideModal('privacyOptionModal');
                vibrate(3);
            });
        });

        document.getElementById('closePrivacyOption').addEventListener('click', () => {
            hideModal('privacyOptionModal');
        });

        // ==================== CHAT OPTIONS ====================
        document.getElementById('closeChatOptionsSheet').addEventListener('click', () => {
            document.getElementById('chatOptionsSheet').classList.remove('active');
        });

        document.querySelectorAll('[data-chat-option]').forEach(item => {
            item.addEventListener('click', async () => {
                const option = item.dataset.chatOption;
                document.getElementById('chatOptionsSheet').classList.remove('active');
                
                switch(option) {
                    case 'pin':
                        await togglePinChat();
                        break;
                    case 'mute':
                        await toggleMuteChat();
                        break;
                    case 'archive':
                        await archiveChat();
                        break;
                    case 'search':
                        showToast('Search in chat coming soon');
                        break;
                    case 'clear':
                        clearChatHistory();
                        break;
                    case 'block':
                        blockUser();
                        break;
                }
            });
        });

        async function togglePinChat() {
            if (!currentChatId) return;
            
            try {
                const chatRef = db.collection('chats').doc(currentChatId);
                const chatDoc = await chatRef.get();
                const isPinned = chatDoc.data()?.pinned?.[currentUser.uid];
                
                await chatRef.update({
                    [`pinned.${currentUser.uid}`]: !isPinned
                });
                
                showToast(isPinned ? 'Chat unpinned' : 'Chat pinned');
                vibrate(5);
            } catch (error) {
                console.error('Pin error:', error);
                showToast('Failed to update');
            }
        }

        async function toggleMuteChat() {
            if (!currentChatId) return;
            
            try {
                const chatRef = db.collection('chats').doc(currentChatId);
                const chatDoc = await chatRef.get();
                const isMuted = chatDoc.data()?.muted?.[currentUser.uid];
                
                await chatRef.update({
                    [`muted.${currentUser.uid}`]: !isMuted
                });
                
                showToast(isMuted ? 'Notifications unmuted' : 'Notifications muted');
                vibrate(5);
            } catch (error) {
                console.error('Mute error:', error);
                showToast('Failed to update');
            }
        }

        async function archiveChat() {
            if (!currentChatId) return;
            
            try {
                const chatRef = db.collection('chats').doc(currentChatId);
                await chatRef.update({
                    [`archived.${currentUser.uid}`]: true
                });
                
                showToast('Chat archived');
                showScreen('homeScreen');
                vibrate(5);
            } catch (error) {
                console.error('Archive error:', error);
                showToast('Failed to archive');
            }
        }

        async function clearChatHistory() {
            if (!currentChatId) return;
            if (!confirm('Clear all messages in this chat?')) return;
            
            showLoading(true);
            
            try {
                const messagesSnapshot = await db.collection('chats').doc(currentChatId)
                    .collection('messages').get();
                
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        deletedFor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                });
                
                await batch.commit();
                
                document.getElementById('messagesContainer').innerHTML = '';
                showToast('Chat cleared');
                vibrate(5);
            } catch (error) {
                console.error('Clear chat error:', error);
                showToast('Failed to clear chat');
            } finally {
                showLoading(false);
            }
        }

        async function blockUser() {
            if (!currentChatUser) return;
            if (!confirm(`Block ${currentChatUser.username}?\n\nYou won't receive messages from this user.`)) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('blocked').doc(currentChatUser.uid).set({
                        username: currentChatUser.username,
                        blockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showToast('User blocked');
                showScreen('homeScreen');
                vibrate(5);
            } catch (error) {
                console.error('Block error:', error);
                showToast('Failed to block user');
            }
        }

        // ==================== STORAGE ====================
        function loadStorageUsage() {
            if (currentUserData?.storage) {
                storageUsage = { ...storageUsage, ...currentUserData.storage };
                
                // Reset daily if new day
                if (storageUsage.lastReset !== new Date().toDateString()) {
                    storageUsage.daily = 0;
                    storageUsage.lastReset = new Date().toDateString();
                    saveStorageUsage();
                }
            }
        }

        function saveStorageUsage() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                storage: storageUsage
            }).catch(console.error);
        }

        function updateStorageDisplay() {
            const totalMB = (storageUsage.total / (1024 * 1024)).toFixed(2);
            const dailyMB = (storageUsage.daily / (1024 * 1024)).toFixed(2);
            const photosMB = (storageUsage.photos / (1024 * 1024)).toFixed(2);
            const videosMB = (storageUsage.videos / (1024 * 1024)).toFixed(2);
            const docsMB = (storageUsage.documents / (1024 * 1024)).toFixed(2);
            
            const totalEl = document.getElementById('totalStorageUsed');
            const dailyEl = document.getElementById('dailyUsed');
            const photosEl = document.getElementById('photosSize');
            const videosEl = document.getElementById('videosSize');
            const docsEl = document.getElementById('documentsSize');
            const storageValueEl = document.getElementById('storageUsageValue');
            const barEl = document.getElementById('storageBar');
            const warningEl = document.getElementById('storageWarning');
            
            if (totalEl) totalEl.textContent = `${totalMB} MB / 100 MB`;
            if (dailyEl) dailyEl.textContent = dailyMB;
            if (photosEl) photosEl.textContent = `${photosMB} MB`;
            if (videosEl) videosEl.textContent = `${videosMB} MB`;
            if (docsEl) docsEl.textContent = `${docsMB} MB`;
            if (storageValueEl) storageValueEl.textContent = `${totalMB} MB used`;
            
            const percent = (storageUsage.total / STORAGE_LIMITS.lifetimeLimit) * 100;
            if (barEl) barEl.style.width = `${Math.min(percent, 100)}%`;
            
            if (warningEl) {
                warningEl.style.display = percent > 80 ? 'block' : 'none';
            }
        }

        async function clearCache() {
            if (!confirm('Clear all cached data?\n\nThis will reset your storage usage tracking.')) return;
            
            showLoading(true);
            
            try {
                localStorage.clear();
                
                storageUsage = {
                    daily: 0,
                    total: 0,
                    photos: 0,
                    videos: 0,
                    documents: 0,
                    lastReset: new Date().toDateString()
                };
                
                saveStorageUsage();
                updateStorageDisplay();
                
                showToast('Cache cleared');
                vibrate(5);
            } catch (error) {
                console.error('Clear cache error:', error);
                showToast('Failed to clear cache');
            } finally {
                showLoading(false);
            }
        }

        // ==================== USER SETTINGS ====================
        function loadUserSettings() {
            if (currentUserData?.settings) {
                userSettings = { ...userSettings, ...currentUserData.settings };
            }
            
            setTheme(userSettings.theme);
            updateSettingsUI();
        }

        function saveUserSettings() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                settings: userSettings
            }).catch(console.error);
        }

        function updateSettingsUI() {
            const toggleMap = {
                'onlineStatusToggle': userSettings.onlineStatus,
                'readReceiptsToggle': userSettings.readReceipts,
                'typingIndicatorToggle': userSettings.typingIndicator,
                'enterToSendToggle': userSettings.enterToSend,
                'messageNotifToggle': userSettings.messageNotifications,
                'vibrationToggle': userSettings.vibration,
                'autoDownloadToggle': userSettings.autoDownload,
                'dataSaverToggle': userSettings.dataSaver,
                'aiAutoReplyToggle': userSettings.aiAutoReply,
                'aiTranslateToggle': userSettings.aiTranslate,
                'aiSummaryToggle': userSettings.aiSummary,
                'aiSpamToggle': userSettings.aiSpam,
                'privacyReadReceipts': userSettings.readReceipts,
                'privacyTyping': userSettings.typingIndicator,
                'storageAutoDownload': userSettings.autoDownload,
                'storageDataSaver': userSettings.dataSaver
            };
            
            Object.entries(toggleMap).forEach(([id, value]) => {
                const toggle = document.getElementById(id);
                if (toggle) {
                    toggle.classList.toggle('active', value);
                }
            });
            
            // Update text values
            const themeValueEl = document.getElementById('themeValue');
            const lastSeenValueEl = document.getElementById('lastSeenValue');
            
            if (themeValueEl) {
                themeValueEl.textContent = userSettings.theme.charAt(0).toUpperCase() + userSettings.theme.slice(1);
            }
            
            if (lastSeenValueEl) {
                const lastSeenValue = userSettings.privacy?.lastSeen || 'everyone';
                lastSeenValueEl.textContent = lastSeenValue.charAt(0).toUpperCase() + lastSeenValue.slice(1);
            }
            
            // Update theme checkmarks
            document.querySelectorAll('.theme-option').forEach(opt => {
                const check = opt.querySelector('.theme-check');
                if (check) {
                    check.style.color = opt.dataset.theme === userSettings.theme ? 'var(--online-green)' : 'transparent';
                }
            });
        }

        // ==================== AI FEATURES ====================
        async function callGeminiAI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error('Gemini AI error:', error);
                return null;
            }
        }

        async function generateAIReply(message) {
            if (!userSettings.aiAutoReply) return null;
            
            const prompt = `Generate a short, friendly reply to this message: "${message}". Keep it under 50 words and conversational.`;
            return await callGeminiAI(prompt);
        }

        async function translateMessage(text, targetLang = 'en') {
            if (!userSettings.aiTranslate) return null;
            
            const prompt = `Translate this text to ${targetLang}: "${text}". Only return the translation, nothing else.`;
            return await callGeminiAI(prompt);
        }

        async function checkSpam(text) {
            if (!userSettings.aiSpam) return false;
            
            const prompt = `Is this message spam or suspicious? Answer only "yes" or "no": "${text}"`;
            const result = await callGeminiAI(prompt);
            return result?.toLowerCase().includes('yes');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('active', show);
            }
        }

        function generateChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        function generateAvatar(name) {
            const colors = ['F56040', 'C13584', '833AB4', '5851DB', '0095F6', '22C55E', 'F59E0B', 'EF4444'];
            const color = colors[Math.abs(hashCode(name || 'User')) % colors.length];
            const initial = (name || 'U').charAt(0).toUpperCase();
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(initial)}&background=${color}&color=fff&bold=true&size=200`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            if (diff < 604800000) return date.toLocaleDateString('en-US', { weekday: 'short' });
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatMessageTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function formatLastSeen(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'last seen just now';
            if (diff < 3600000) return `last seen ${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `last seen ${Math.floor(diff / 3600000)}h ago`;
            if (diff < 172800000) return 'last seen yesterday';
            
            return `last seen ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastIn 0.25s reverse forwards';
                setTimeout(() => toast.remove(), 250);
            }, 2500);
        }

        function vibrate(duration = 10) {
            if (userSettings.vibration && 'vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        // Image viewer
        window.viewImage = function(url) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.25s ease;
                padding: 20px;
            `;
            overlay.innerHTML = `
                <img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">
                <button style="position: absolute; top: calc(var(--safe-area-top, 0px) + 16px); right: 16px; background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px);">
                    <span class="material-icons-round" style="color: white; font-size: 24px;">close</span>
                </button>
            `;
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    overlay.style.animation = 'fadeIn 0.25s reverse forwards';
                    setTimeout(() => overlay.remove(), 250);
                }
            });
            document.body.appendChild(overlay);
        };

        // ==================== EVENT LISTENERS ====================
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Close action sheets on overlay click
        document.querySelectorAll('.action-sheet-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Handle online/offline
        window.addEventListener('online', () => {
            showToast('Back online');
            if (currentUser && userSettings.onlineStatus) {
                db.collection('users').doc(currentUser.uid).update({ 
                    online: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(console.error);
            }
        });

        window.addEventListener('offline', () => {
            showToast('You\'re offline');
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (currentUser && userSettings.onlineStatus) {
                db.collection('users').doc(currentUser.uid).update({
                    online: !document.hidden,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(console.error);
            }
        });

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (userSettings.theme === 'system') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                
                const themeIcon = document.querySelector('#sidebarThemeToggle .material-icons-round');
                if (themeIcon) {
                    themeIcon.textContent = e.matches ? 'light_mode' : 'dark_mode';
                }
            }
        });

        // Handle back button on mobile
        window.addEventListener('popstate', (e) => {
            const activeScreens = document.querySelectorAll('.screen.active');
            
            let topScreen = null;
            let maxZ = -1;
            
            activeScreens.forEach(screen => {
                const z = parseInt(window.getComputedStyle(screen).zIndex) || 0;
                if (z > maxZ) {
                    maxZ = z;
                    topScreen = screen;
                }
            });
            
            if (topScreen) {
                const screenId = topScreen.id;
                
                if (screenId === 'chatScreen') {
                    if (messagesListener) {
                        messagesListener();
                        messagesListener = null;
                    }
                    cancelReply();
                    showScreen('homeScreen');
                } else if (screenId === 'searchScreen' || screenId === 'requestsScreen') {
                    showScreen('homeScreen');
                } else if (screenId === 'profileScreen' || screenId === 'settingsScreen') {
                    showScreen('homeScreen');
                } else if (screenId === 'privacyScreen' || screenId === 'storageScreen' || screenId === 'blockedScreen' || screenId === 'qrScreen') {
                    showScreen('settingsScreen');
                } else if (screenId === 'archivedScreen' || screenId === 'starredScreen') {
                    showScreen('homeScreen');
                }
            }
            
            history.pushState(null, '', window.location.href);
        });

        // Push initial state
        history.pushState(null, '', window.location.href);

        // Initialize
        loadEmojis('smileys');

                // ==================== WALLPAPER ====================
        function showWallpaperModal() {
            const wallpapers = [
                { name: 'Default', value: 'var(--white)' },
                { name: 'Light Gray', value: '#F5F5F5' },
                { name: 'Blue', value: '#E3F2FD' },
                { name: 'Green', value: '#E8F5E9' },
                { name: 'Purple', value: '#F3E5F5' },
                { name: 'Pink', value: '#FCE4EC' }
            ];
            
            const modalContent = wallpapers.map((wp, idx) => `
                <div class="settings-item" onclick="applyWallpaper('${wp.value}'); hideModal('wallpaperModal');" style="cursor: pointer;">
                    <div style="width: 40px; height: 40px; background: ${wp.value}; border-radius: 8px; border: 2px solid var(--border-light);"></div>
                    <div class="settings-info">
                        <div class="settings-title">${wp.name}</div>
                    </div>
                </div>
            `).join('');
            
            const existingModal = document.getElementById('wallpaperModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHTML = `
                <div class="modal-overlay" id="wallpaperModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Chat Wallpaper</h3>
                        </div>
                        <div class="modal-body" style="padding: 0;">
                            ${modalContent}
                        </div>
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="hideModal('wallpaperModal')" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            showModal('wallpaperModal');
        }

        window.applyWallpaper = function(color) {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.style.background = color;
            }
            showToast('Wallpaper applied');
        };

        // ==================== HELP CENTER ====================
        function showHelpCenter() {
            alert('Help Center\n\n Getting Started:\n Sign in with Google\n Choose a username\n Add friends and start chatting\n\n Features:\n Send text, photos, videos\n React to messages\n Forward and reply\n Star important messages\n\n Privacy:\n Control who sees your info\n Block unwanted users\n Manage read receipts\n\n Support: support@whatsup.com');
        }

        // ==================== ABOUT ====================
        function showAboutScreen() {
            alert('What\'s Up v2.0.0\n\n A modern, secure messaging app\n\n 2024 What\'s Up\nAll rights reserved\n\nMade with  for seamless communication');
        }
        
        console.log(' What\'s Up v2.0 initialized successfully!');
        
    </script>
</body>
</html>
