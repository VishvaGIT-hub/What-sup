<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    <title>What's Up - Complete Chat App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --white: #FFFFFF;
            --black: #000000;
            --primary-text: #262626;
            --secondary-text: #8E8E8E;
            --tertiary-text: #C7C7C7;
            --border-light: #DBDBDB;
            --background-light: #FAFAFA;
            --hover-gray: #F5F5F5;
            --gradient-pink: #F56040;
            --gradient-purple: #C13584;
            --gradient-deep-purple: #833AB4;
            --gradient-blue: #5851DB;
            --accent-gradient: linear-gradient(135deg, #F56040 0%, #C13584 50%, #833AB4 100%);
            --message-sent: #3B82F6;
            --message-received: #E5E7EB;
            --online-green: #22C55E;
            --error-red: #EF4444;
            --link-blue: #3B82F6;
            --warning-yellow: #F59E0B;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --sidebar-width: 300px;
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --white: #0F172A;
            --black: #FFFFFF;
            --primary-text: #F1F5F9;
            --secondary-text: #94A3B8;
            --tertiary-text: #475569;
            --border-light: #334155;
            --background-light: #1E293B;
            --hover-gray: #334155;
            --message-received: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--white);
            color: var(--primary-text);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            user-select: none;
            transition: background 0.3s, color 0.3s;
        }

        .app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Screen Management */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--white);
            z-index: 1;
        }

        .screen.active {
            display: flex;
            animation: screenSlideIn 0.3s var(--ease-smooth);
        }

        @keyframes screenSlideIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes screenSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-30px); }
        }

        /* Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-smooth);
            backdrop-filter: blur(4px);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            max-width: 85vw;
            height: 100%;
            background: var(--white);
            z-index: 999;
            transform: translateX(-100%);
            transition: transform 0.35s var(--ease-spring);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: calc(var(--safe-area-top) + 24px) 20px 24px;
            background: var(--accent-gradient);
            color: white;
            flex-shrink: 0;
        }

        .sidebar-user-section {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .sidebar-avatar {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.4);
            overflow: hidden;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .sidebar-avatar:active {
            transform: scale(0.95);
        }

        .sidebar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-displayname {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-username {
            font-size: 14px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-stats {
            display: flex;
            gap: 24px;
        }

        .sidebar-stat {
            text-align: center;
        }

        .sidebar-stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .sidebar-stat-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-section {
            padding: 8px 0;
        }

        .sidebar-section-title {
            padding: 12px 20px 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-item:active {
            background: var(--hover-gray);
            transform: scale(0.98);
        }

        .sidebar-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item-icon .material-icons-round {
            font-size: 24px;
            color: var(--secondary-text);
        }

        .sidebar-item-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .sidebar-item-badge {
            min-width: 22px;
            height: 22px;
            padding: 0 7px;
            background: var(--error-red);
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item-arrow .material-icons-round {
            font-size: 20px;
            color: var(--tertiary-text);
        }

        .sidebar-item.danger .sidebar-item-icon .material-icons-round,
        .sidebar-item.danger .sidebar-item-text {
            color: var(--error-red);
        }

        .sidebar-divider {
            height: 1px;
            background: var(--border-light);
            margin: 8px 20px;
        }

        .sidebar-footer {
            padding: 16px 20px calc(var(--safe-area-bottom) + 16px);
            border-top: 1px solid var(--border-light);
            text-align: center;
        }

        .sidebar-version {
            font-size: 12px;
            color: var(--tertiary-text);
        }

        /* Auth Screen */
        .auth-screen {
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            background: linear-gradient(180deg, var(--white) 0%, var(--background-light) 100%);
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            background: var(--accent-gradient);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            font-weight: 900;
            color: white;
            margin-bottom: 28px;
            box-shadow: 0 12px 40px rgba(193, 53, 132, 0.35);
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .auth-title {
            font-size: 34px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin-bottom: 48px;
            line-height: 1.5;
            max-width: 300px;
        }

        .google-btn {
            width: 100%;
            max-width: 320px;
            height: 54px;
            background: var(--white);
            border: 2px solid var(--border-light);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--primary-text);
        }

        .google-btn:active {
            transform: scale(0.98);
            border-color: var(--secondary-text);
        }

        .google-icon {
            width: 22px;
            height: 22px;
        }

        /* Top Bar */
        .top-bar {
            height: calc(56px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding-left: 8px;
            padding-right: 8px;
            flex-shrink: 0;
            z-index: 10;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .menu-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn:active {
            background: var(--hover-gray);
            transform: scale(0.95);
        }

        .menu-btn .material-icons-round {
            font-size: 26px;
            color: var(--primary-text);
        }

        .app-title {
            font-size: 22px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-bar-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .icon-btn:active {
            background: var(--hover-gray);
            transform: scale(0.95);
        }

        .icon-btn .material-icons-round {
            font-size: 26px;
            color: var(--primary-text);
        }

        .icon-btn .badge {
            position: absolute;
            top: 6px;
            right: 6px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--error-red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .chat-list::-webkit-scrollbar {
            display: none;
        }

        .list-section-header {
            padding: 16px 16px 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--background-light);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 1px solid var(--border-light);
            background: var(--white);
        }

        .chat-item:active {
            background: var(--hover-gray);
        }

        .chat-item.pinned {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, var(--white) 100%);
        }

        .chat-item.archived {
            opacity: 0.6;
        }

        .chat-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background: var(--background-light);
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--online-green);
            border: 3px solid var(--white);
            border-radius: 50%;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .chat-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-name .material-icons-round {
            font-size: 16px;
            color: var(--link-blue);
        }

        .chat-time {
            font-size: 12px;
            color: var(--secondary-text);
            flex-shrink: 0;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-last-message {
            font-size: 14px;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-item.unread .chat-last-message {
            color: var(--primary-text);
            font-weight: 600;
        }

        .chat-unread-badge {
            min-width: 22px;
            height: 22px;
            padding: 0 7px;
            background: var(--link-blue);
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-muted-icon {
            color: var(--secondary-text);
            font-size: 18px !important;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .empty-icon {
            width: 100px;
            height: 100px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .empty-icon .material-icons-round {
            font-size: 48px;
            color: var(--secondary-text);
        }

        .empty-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-text);
        }

        .empty-text {
            font-size: 15px;
            color: var(--secondary-text);
            line-height: 1.5;
            max-width: 280px;
        }

        .empty-action {
            margin-top: 24px;
            padding: 14px 32px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .empty-action:active {
            transform: scale(0.95);
        }

        /* FAB */
        .fab-container {
            position: fixed;
            bottom: calc(24px + var(--safe-area-bottom));
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 100;
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-spring);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab-primary {
            background: var(--accent-gradient);
        }

        .fab-secondary {
            width: 48px;
            height: 48px;
            background: var(--white);
            border: 1px solid var(--border-light);
        }

        .fab .material-icons-round {
            font-size: 28px;
            color: white;
        }

        .fab-secondary .material-icons-round {
            font-size: 24px;
            color: var(--primary-text);
        }

        /* Search Screen */
        .search-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            padding-top: calc(var(--safe-area-top) + 8px);
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
        }

        .back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .back-btn:active {
            background: var(--hover-gray);
            transform: scale(0.95);
        }

        .back-btn .material-icons-round {
            font-size: 26px;
            color: var(--primary-text);
        }

        .search-input-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 44px;
            padding: 0 16px 0 44px;
            background: var(--background-light);
            border: none;
            border-radius: 22px;
            font-size: 16px;
            color: var(--primary-text);
            outline: none;
        }

        .search-input::placeholder {
            color: var(--secondary-text);
        }

        .search-input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-text);
            font-size: 22px;
            pointer-events: none;
        }

        .search-content {
            flex: 1;
            overflow-y: auto;
        }

        .search-section {
            padding: 16px 0;
        }

        .search-section-title {
            padding: 0 16px 12px;
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-text);
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .user-item:active {
            background: var(--hover-gray);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--background-light);
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 2px;
        }

        .user-username {
            font-size: 14px;
            color: var(--secondary-text);
        }

        .user-action-btn {
            padding: 10px 20px;
            background: var(--link-blue);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .user-action-btn:active {
            transform: scale(0.95);
        }

        .user-action-btn.pending {
            background: var(--background-light);
            color: var(--secondary-text);
        }

        .user-action-btn.friends {
            background: var(--online-green);
        }

        /* Requests Screen */
        .request-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .request-info {
            flex: 1;
            min-width: 0;
        }

        .request-text {
            font-size: 14px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .request-time {
            font-size: 12px;
            color: var(--tertiary-text);
            margin-top: 4px;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .request-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .request-btn:active {
            transform: scale(0.95);
        }

        .request-btn.accept {
            background: var(--link-blue);
            color: white;
        }

        .request-btn.decline {
            background: var(--background-light);
            color: var(--primary-text);
        }

        /* Chat Screen */
        .chat-screen {
            z-index: 20;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            padding-top: calc(var(--safe-area-top) + 8px);
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .chat-header-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            cursor: pointer;
        }

        .chat-header-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-header-avatar .online-indicator {
            width: 12px;
            height: 12px;
            border-width: 2px;
        }

        .chat-header-details {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-size: 17px;
            font-weight: 700;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--secondary-text);
        }

        .chat-header-status.typing {
            color: var(--online-green);
            font-weight: 500;
        }

        .chat-header-actions {
            display: flex;
            gap: 4px;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            -webkit-overflow-scrolling: touch;
            background: var(--background-light);
        }

        .messages-container::-webkit-scrollbar {
            display: none;
        }

        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 0;
        }

        .date-label {
            padding: 6px 16px;
            background: var(--white);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: messageSlideIn 0.25s var(--ease-spring);
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message-wrapper.sent {
            align-self: flex-end;
        }

        .message-wrapper.received {
            align-self: flex-start;
        }

        .message-reply-preview {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px 12px 0 0;
            border-left: 3px solid var(--link-blue);
            margin-bottom: -4px;
        }

        .message-reply-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--link-blue);
            margin-bottom: 2px;
        }

        .message-reply-text {
            font-size: 13px;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message-wrapper.sent .message-bubble {
            background: var(--message-sent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-wrapper.received .message-bubble {
            background: var(--white);
            color: var(--primary-text);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .message-media {
            max-width: 280px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .message-media img,
        .message-media video {
            width: 100%;
            display: block;
        }

        .message-document {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 4px;
        }

        .message-wrapper.received .message-document {
            background: var(--background-light);
        }

        .message-document-icon {
            width: 40px;
            height: 40px;
            background: var(--link-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-document-icon .material-icons-round {
            color: white;
            font-size: 22px;
        }

        .message-document-info {
            flex: 1;
            min-width: 0;
        }

        .message-document-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-document-size {
            font-size: 12px;
            opacity: 0.7;
        }

        .message-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .message-status {
            display: flex;
            align-items: center;
        }

        .message-status .material-icons-round {
            font-size: 16px;
            opacity: 0.7;
        }

        .message-status.read .material-icons-round {
            color: #34B7F1;
            opacity: 1;
        }

        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .message-reaction {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            background: var(--white);
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.15s;
        }

        .message-reaction:active {
            transform: scale(0.9);
        }

        .message-reaction-count {
            font-size: 11px;
            font-weight: 600;
            color: var(--secondary-text);
        }

        .message-edited {
            font-size: 11px;
            opacity: 0.6;
            margin-right: 4px;
        }

        .scheduled-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--warning-yellow);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scheduled-indicator .material-icons-round {
            font-size: 14px;
        }

        /* Input Bar */
        .input-bar {
            padding: 8px 12px calc(var(--safe-area-bottom) + 8px);
            background: var(--white);
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .reply-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--background-light);
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--link-blue);
        }

        .reply-bar-content {
            flex: 1;
            min-width: 0;
        }

        .reply-bar-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--link-blue);
        }

        .reply-bar-text {
            font-size: 13px;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-bar-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .reply-bar-close .material-icons-round {
            font-size: 20px;
            color: var(--secondary-text);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .input-actions {
            display: flex;
            gap: 2px;
            padding-bottom: 6px;
        }

        .input-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .input-btn:active {
            background: var(--hover-gray);
            transform: scale(0.9);
        }

        .input-btn .material-icons-round {
            font-size: 26px;
            color: var(--secondary-text);
        }

        .input-field-container {
            flex: 1;
            position: relative;
        }

        .input-field {
            width: 100%;
            min-height: 44px;
            max-height: 120px;
            padding: 10px 16px;
            background: var(--background-light);
            border: none;
            border-radius: 22px;
            font-size: 16px;
            font-family: inherit;
            color: var(--primary-text);
            resize: none;
            outline: none;
            overflow-y: auto;
        }

        .input-field::placeholder {
            color: var(--secondary-text);
        }

        .input-field::-webkit-scrollbar {
            display: none;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--background-light);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0;
        }

        .send-btn .material-icons-round {
            font-size: 24px;
            color: var(--secondary-text);
            transition: all 0.2s;
        }

        .send-btn.active {
            background: var(--link-blue);
        }

        .send-btn.active .material-icons-round {
            color: white;
        }

        .send-btn:active {
            transform: scale(0.9);
        }

        /* Profile Screen */
        .profile-header-bg {
            height: 140px;
            background: var(--accent-gradient);
            position: relative;
        }

        .profile-header-back {
            position: absolute;
            top: calc(var(--safe-area-top) + 8px);
            left: 8px;
        }

        .profile-header-back .back-btn {
            color: white;
        }

        .profile-header-back .back-btn .material-icons-round {
            color: white;
        }

        .profile-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: -50px;
            padding: 0 20px;
        }

        .profile-avatar-wrapper {
            position: relative;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--white);
            overflow: hidden;
            background: var(--background-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: var(--link-blue);
            border: 3px solid var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .profile-avatar-edit:active {
            transform: scale(0.9);
        }

        .profile-avatar-edit .material-icons-round {
            font-size: 18px;
            color: white;
        }

        .profile-name-display {
            font-size: 24px;
            font-weight: 700;
            margin-top: 12px;
            text-align: center;
        }

        .profile-username-display {
            font-size: 15px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .profile-bio-display {
            font-size: 14px;
            color: var(--secondary-text);
            text-align: center;
            margin-top: 8px;
            max-width: 280px;
            line-height: 1.4;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            padding: 20px;
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-text);
        }

        .profile-stat-label {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: var(--safe-area-bottom);
        }

        .profile-section {
            padding: 16px 0;
        }

        .profile-section-title {
            padding: 0 20px 12px;
            font-size: 14px;
            font-weight: 700;
            color: var(--link-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .profile-item:active {
            background: var(--hover-gray);
        }

        .profile-item-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-light);
        }

        .profile-item-icon .material-icons-round {
            font-size: 24px;
            color: var(--secondary-text);
        }

        .profile-item-icon.blue {
            background: rgba(59, 130, 246, 0.1);
        }

        .profile-item-icon.blue .material-icons-round {
            color: var(--link-blue);
        }

        .profile-item-icon.green {
            background: rgba(34, 197, 94, 0.1);
        }

        .profile-item-icon.green .material-icons-round {
            color: var(--online-green);
        }

        .profile-item-icon.red {
            background: rgba(239, 68, 68, 0.1);
        }

        .profile-item-icon.red .material-icons-round {
            color: var(--error-red);
        }

        .profile-item-icon.purple {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .profile-item-icon.purple .material-icons-round {
            color: #8B5CF6;
        }

        .profile-item-content {
            flex: 1;
            min-width: 0;
        }

        .profile-item-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .profile-item-subtitle {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .profile-item-value {
            font-size: 14px;
            color: var(--secondary-text);
        }

        .profile-item-arrow .material-icons-round {
            font-size: 22px;
            color: var(--tertiary-text);
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 52px;
            height: 32px;
            background: var(--border-light);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: var(--online-green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s var(--ease-spring);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Edit Profile Screen */
        .edit-profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(var(--safe-area-bottom) + 20px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            color: var(--primary-text);
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--link-blue);
        }

        .form-input::placeholder {
            color: var(--tertiary-text);
        }

        .form-textarea {
            min-height: 100px;
            resize: none;
            font-family: inherit;
        }

        .form-hint {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 6px;
        }

        .form-counter {
            text-align: right;
            font-size: 12px;
            color: var(--tertiary-text);
            margin-top: 4px;
        }

        .form-counter.warning {
            color: var(--warning-yellow);
        }

        .form-counter.error {
            color: var(--error-red);
        }

        .save-profile-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .save-profile-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .save-profile-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        /* Settings Screen */
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: calc(var(--safe-area-bottom) + 20px);
        }

        .settings-section {
            padding: 12px 0;
        }

        .settings-section-title {
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 700;
            color: var(--link-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .settings-item:active {
            background: var(--hover-gray);
        }

        .settings-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .settings-item-icon .material-icons-round {
            font-size: 22px;
        }

        .settings-item-content {
            flex: 1;
            min-width: 0;
        }

        .settings-item-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .settings-item-subtitle {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .settings-item-value {
            font-size: 14px;
            color: var(--secondary-text);
            flex-shrink: 0;
        }

        .settings-item-arrow .material-icons-round {
            font-size: 20px;
            color: var(--tertiary-text);
        }

        /* Schedule Message */
        .schedule-modal-content {
            padding: 20px;
        }

        .schedule-datetime {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .schedule-datetime input {
            flex: 1;
            padding: 12px;
            background: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 15px;
            color: var(--primary-text);
            outline: none;
        }

        .schedule-datetime input:focus {
            border-color: var(--link-blue);
        }

        .scheduled-messages-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
            border-top: 1px solid var(--border-light);
            padding-top: 16px;
        }

        .scheduled-message-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--background-light);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .scheduled-message-content {
            flex: 1;
            min-width: 0;
        }

        .scheduled-message-text {
            font-size: 14px;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scheduled-message-time {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .scheduled-message-delete {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .scheduled-message-delete .material-icons-round {
            font-size: 20px;
            color: var(--error-red);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 360px;
            max-height: 80vh;
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s var(--ease-spring);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 20px 20px 0;
            text-align: center;
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .modal-icon .material-icons-round {
            font-size: 30px;
            color: var(--secondary-text);
        }

        .modal-icon.danger {
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-icon.danger .material-icons-round {
            color: var(--error-red);
        }

        .modal-icon.success {
            background: rgba(34, 197, 94, 0.1);
        }

        .modal-icon.success .material-icons-round {
            color: var(--online-green);
        }

        .modal-icon.warning {
            background: rgba(245, 158, 11, 0.1);
        }

        .modal-icon.warning .material-icons-round {
            color: var(--warning-yellow);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 8px;
        }

        .modal-body {
            padding: 12px 20px 20px;
        }

        .modal-text {
            font-size: 15px;
            color: var(--secondary-text);
            text-align: center;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            color: var(--primary-text);
            outline: none;
            margin-top: 16px;
            text-align: center;
        }

        .modal-input:focus {
            border-color: var(--link-blue);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            padding: 0 20px 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn.secondary {
            background: var(--background-light);
            color: var(--primary-text);
        }

        .modal-btn.primary {
            background: var(--link-blue);
            color: white;
        }

        .modal-btn.danger {
            background: var(--error-red);
            color: white;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Action Sheet */
        .action-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .action-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.35s var(--ease-spring);
            max-height: 70vh;
            overflow-y: auto;
        }

        .action-sheet-overlay.active .action-sheet {
            transform: translateY(0);
        }

        .action-sheet-handle {
            width: 40px;
            height: 5px;
            background: var(--border-light);
            border-radius: 3px;
            margin: 12px auto;
        }

        .action-sheet-title {
            padding: 8px 20px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-text);
            text-align: center;
        }

        .action-sheet-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .action-sheet-item:active {
            background: var(--hover-gray);
        }

        .action-sheet-item .material-icons-round {
            font-size: 26px;
            width: 26px;
            text-align: center;
        }

        .action-sheet-item-text {
            font-size: 17px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .action-sheet-item.danger .material-icons-round,
        .action-sheet-item.danger .action-sheet-item-text {
            color: var(--error-red);
        }

        .action-sheet-cancel {
            margin: 8px 16px 16px;
            padding: 16px;
            background: var(--background-light);
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            color: var(--link-blue);
            cursor: pointer;
            width: calc(100% - 32px);
            transition: all 0.2s;
        }

        .action-sheet-cancel:active {
            transform: scale(0.98);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--white);
            border-radius: 14px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
            transition: all 0.2s var(--ease-spring);
        }

        .context-menu.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .context-menu-item:active {
            background: var(--hover-gray);
        }

        .context-menu-item .material-icons-round {
            font-size: 22px;
            color: var(--secondary-text);
        }

        .context-menu-item span {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .context-menu-item.danger .material-icons-round,
        .context-menu-item.danger span {
            color: var(--error-red);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-light);
            margin: 4px 0;
        }

        /* Quick Reactions Bar */
        .quick-reactions {
            display: flex;
            gap: 2px;
            padding: 8px 12px;
            background: var(--white);
            border-radius: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: fixed;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8) translateY(10px);
            transition: all 0.2s var(--ease-spring);
        }

        .quick-reactions.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }

        .quick-reaction-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.15s;
            background: transparent;
            border: none;
        }

        .quick-reaction-btn:hover {
            transform: scale(1.3);
            background: var(--hover-gray);
        }

        .quick-reaction-btn:active {
            transform: scale(1.4);
        }

        /* Emoji Picker */
        .emoji-picker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 320px;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            z-index: 500;
            transform: translateY(100%);
            transition: transform 0.3s var(--ease-spring);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .emoji-picker.active {
            transform: translateY(0);
        }

        .emoji-picker-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            gap: 8px;
        }

        .emoji-search {
            flex: 1;
            height: 36px;
            padding: 0 12px;
            background: var(--background-light);
            border: none;
            border-radius: 18px;
            font-size: 14px;
            color: var(--primary-text);
            outline: none;
        }

        .emoji-categories {
            display: flex;
            padding: 8px;
            gap: 4px;
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto;
        }

        .emoji-categories::-webkit-scrollbar {
            display: none;
        }

        .emoji-category-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            background: transparent;
            border: none;
            flex-shrink: 0;
        }

        .emoji-category-btn:active,
        .emoji-category-btn.active {
            background: var(--hover-gray);
        }

        .emoji-category-btn .material-icons-round {
            font-size: 24px;
            color: var(--secondary-text);
        }

        .emoji-category-btn.active .material-icons-round {
            color: var(--link-blue);
        }

        .emoji-grid {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.1s;
            background: transparent;
            border: none;
        }

        .emoji-item:active {
            background: var(--hover-gray);
            transform: scale(1.2);
        }

        /* Upload Progress */
        .upload-progress {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            left: 16px;
            right: 16px;
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
            z-index: 500;
            display: none;
        }

        .upload-progress.active {
            display: block;
            animation: slideUp 0.3s var(--ease-spring);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 12px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            background: var(--background-light);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon .material-icons-round {
            font-size: 28px;
            color: var(--link-blue);
        }

        .upload-details {
            flex: 1;
            min-width: 0;
        }

        .upload-filename {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upload-size {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .upload-bar {
            height: 6px;
            background: var(--background-light);
            border-radius: 3px;
            overflow: hidden;
        }

        .upload-bar-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-text);
            color: var(--white);
            padding: 14px 28px;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: toastIn 0.3s var(--ease-spring);
            max-width: calc(100% - 48px);
            text-align: center;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-light);
            border-top-color: var(--link-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* QR Code Modal */
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .qr-code-image {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .qr-code-image img,
        .qr-code-image canvas {
            width: 100%;
            height: 100%;
        }

        .qr-username {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 4px;
        }

        .qr-hint {
            font-size: 14px;
            color: var(--secondary-text);
            text-align: center;
        }

        /* Storage Screen */
        .storage-overview {
            padding: 24px 20px;
            background: var(--background-light);
        }

        .storage-circle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .storage-circle {
            width: 160px;
            height: 160px;
            position: relative;
        }

        .storage-circle svg {
            transform: rotate(-90deg);
        }

        .storage-circle-bg {
            fill: none;
            stroke: var(--border-light);
            stroke-width: 12;
        }

        .storage-circle-fill {
            fill: none;
            stroke: url(#storageGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1s var(--ease-smooth);
        }

        .storage-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .storage-used {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-text);
        }

        .storage-total {
            font-size: 14px;
            color: var(--secondary-text);
        }

        .storage-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px 0;
            border-top: 1px solid var(--border-light);
        }

        .storage-stat {
            text-align: center;
        }

        .storage-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-text);
        }

        .storage-stat-label {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .storage-stat-label.warning {
            color: var(--warning-yellow);
        }

        .storage-stat-label.error {
            color: var(--error-red);
        }

        /* Username Screen */
        .username-screen {
            padding: calc(var(--safe-area-top) + 24px) 24px 24px;
        }

        .username-header {
            margin-bottom: 32px;
        }

        .username-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .username-subtitle {
            font-size: 15px;
            color: var(--secondary-text);
            line-height: 1.5;
        }

        .username-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .username-input {
            width: 100%;
            height: 56px;
            padding: 0 50px 0 20px;
            background: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            font-size: 18px;
            color: var(--primary-text);
            outline: none;
            transition: border-color 0.2s;
        }

        .username-input:focus {
            border-color: var(--link-blue);
        }

        .username-status {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .username-status .material-icons-round {
            font-size: 24px;
        }

        .username-status.checking {
            color: var(--secondary-text);
        }

        .username-status.available {
            color: var(--online-green);
        }

        .username-status.taken {
            color: var(--error-red);
        }

        .username-suggestions {
            margin-bottom: 32px;
        }

        .username-suggestions-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-text);
            margin-bottom: 12px;
        }

        .username-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .username-chip {
            padding: 10px 18px;
            background: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 25px;
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .username-chip:active {
            transform: scale(0.95);
            border-color: var(--link-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .username-continue-btn {
            width: 100%;
            height: 56px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
            pointer-events: none;
        }

        .username-continue-btn.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .username-continue-btn.enabled:active {
            transform: scale(0.98);
        }

        /* Utilities */
        .hide {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user-section">
                    <div class="sidebar-avatar" id="sidebarAvatar">
                        <img src="" alt="" id="sidebarAvatarImg">
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-displayname" id="sidebarDisplayName">User</div>
                        <div class="sidebar-username" id="sidebarUsername">@username</div>
                    </div>
                </div>
                <div class="sidebar-stats">
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value" id="sidebarChatsCount">0</div>
                        <div class="sidebar-stat-label">Chats</div>
                    </div>
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value" id="sidebarFriendsCount">0</div>
                        <div class="sidebar-stat-label">Friends</div>
                    </div>
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value" id="sidebarMediaCount">0</div>
                        <div class="sidebar-stat-label">Media</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <!-- Main -->
                <div class="sidebar-section">
                    <div class="sidebar-item" data-action="home">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">chat_bubble</span>
                        </div>
                        <span class="sidebar-item-text">Chats</span>
                    </div>
                    <div class="sidebar-item" data-action="archived">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">archive</span>
                        </div>
                        <span class="sidebar-item-text">Archived</span>
                        <span class="sidebar-item-badge hide" id="archivedBadge">0</span>
                    </div>
                    <div class="sidebar-item" data-action="starred">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">star</span>
                        </div>
                        <span class="sidebar-item-text">Starred Messages</span>
                    </div>
                    <div class="sidebar-item" data-action="scheduled">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">schedule_send</span>
                        </div>
                        <span class="sidebar-item-text">Scheduled Messages</span>
                        <span class="sidebar-item-badge hide" id="scheduledBadge">0</span>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Account -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Account</div>
                    <div class="sidebar-item" data-action="profile">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">person</span>
                        </div>
                        <span class="sidebar-item-text">My Profile</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="sidebar-item" data-action="qrcode">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">qr_code_2</span>
                        </div>
                        <span class="sidebar-item-text">My QR Code</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Settings -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Settings</div>
                    <div class="sidebar-item" data-action="settings">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">settings</span>
                        </div>
                        <span class="sidebar-item-text">Settings</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="sidebar-item" data-action="privacy">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">lock</span>
                        </div>
                        <span class="sidebar-item-text">Privacy</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="sidebar-item" data-action="notifications">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">notifications</span>
                        </div>
                        <span class="sidebar-item-text">Notifications</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="sidebar-item" data-action="storage">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">storage</span>
                        </div>
                        <span class="sidebar-item-text">Storage & Data</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="sidebar-item" data-action="appearance">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">palette</span>
                        </div>
                        <span class="sidebar-item-text">Appearance</span>
                        <div class="sidebar-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Help -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Support</div>
                    <div class="sidebar-item" data-action="help">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">help</span>
                        </div>
                        <span class="sidebar-item-text">Help Center</span>
                    </div>
                    <div class="sidebar-item" data-action="report">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">bug_report</span>
                        </div>
                        <span class="sidebar-item-text">Report Problem</span>
                    </div>
                    <div class="sidebar-item" data-action="about">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">info</span>
                        </div>
                        <span class="sidebar-item-text">About</span>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Actions -->
                <div class="sidebar-section">
                    <div class="sidebar-item" data-action="logout">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">logout</span>
                        </div>
                        <span class="sidebar-item-text">Log Out</span>
                    </div>
                    <div class="sidebar-item danger" data-action="delete-account">
                        <div class="sidebar-item-icon">
                            <span class="material-icons-round">delete_forever</span>
                        </div>
                        <span class="sidebar-item-text">Delete Account</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-version">What's Up v1.0.0</div>
            </div>
        </div>

        <!-- Auth Screen -->
        <div class="screen auth-screen active" id="authScreen">
            <div class="auth-logo">W</div>
            <h1 class="auth-title">What's Up</h1>
            <p class="auth-subtitle">Connect instantly with friends through fast, secure messaging</p>
            <button class="google-btn" id="googleSignInBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
        </div>

        <!-- Username Screen -->
        <div class="screen username-screen" id="usernameScreen">
            <div class="username-header">
                <h1 class="username-title">Create Username</h1>
                <p class="username-subtitle">Choose a unique username. This will be how friends find you.</p>
            </div>

            <div class="username-input-container">
                <input type="text" class="username-input" id="usernameInput" placeholder="Enter username" maxlength="20" autocomplete="off">
                <div class="username-status" id="usernameStatus"></div>
            </div>

            <div class="username-suggestions">
                <div class="username-suggestions-title">Suggestions</div>
                <div class="username-chips" id="usernameChips"></div>
            </div>

            <button class="username-continue-btn" id="usernameContinueBtn">Continue</button>
        </div>

        <!-- Home Screen -->
        <div class="screen" id="homeScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-btn" id="menuBtn">
                        <span class="material-icons-round">menu</span>
                    </button>
                    <span class="app-title">What's Up</span>
                </div>
                <div class="top-bar-right">
                    <button class="icon-btn" id="searchBtn">
                        <span class="material-icons-round">search</span>
                    </button>
                    <button class="icon-btn" id="requestsBtn">
                        <span class="material-icons-round">person_add</span>
                        <span class="badge hide" id="requestsBadge">0</span>
                    </button>
                </div>
            </div>

            <div class="chat-list" id="chatList">
                <!-- Chats will be loaded here -->
            </div>

            <div class="fab-container">
                <button class="fab fab-secondary" id="profileFab">
                    <span class="material-icons-round">edit</span>
                </button>
                <button class="fab fab-primary" id="newChatFab">
                    <span class="material-icons-round">add</span>
                </button>
            </div>
        </div>

        <!-- Search Screen -->
        <div class="screen" id="searchScreen">
            <div class="search-header">
                <button class="back-btn" id="searchBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="search-input-container">
                    <span class="material-icons-round search-input-icon">search</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search users..." autocomplete="off">
                </div>
            </div>

            <div class="search-content" id="searchContent">
                <!-- Search results will be loaded here -->
            </div>
        </div>

        <!-- Requests Screen -->
        <div class="screen" id="requestsScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="requestsBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Friend Requests</span>
                </div>
            </div>

            <div class="chat-list" id="requestsList">
                <!-- Requests will be loaded here -->
            </div>
        </div>

        <!-- Chat Screen -->
        <div class="screen chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="back-btn" id="chatBackBtn">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="chat-header-info" id="chatHeaderInfo">
                    <div class="chat-header-avatar">
                        <img src="" alt="" id="chatHeaderAvatar">
                        <div class="online-indicator hide" id="chatOnlineIndicator"></div>
                    </div>
                    <div class="chat-header-details">
                        <div class="chat-header-name" id="chatHeaderName">User</div>
                        <div class="chat-header-status" id="chatHeaderStatus">offline</div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="icon-btn" id="chatCallBtn">
                        <span class="material-icons-round">call</span>
                    </button>
                    <button class="icon-btn" id="chatVideoBtn">
                        <span class="material-icons-round">videocam</span>
                    </button>
                    <button class="icon-btn" id="chatMenuBtn">
                        <span class="material-icons-round">more_vert</span>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>

            <div class="input-bar" id="inputBar">
                <div class="reply-bar hide" id="replyBar">
                    <div class="reply-bar-content">
                        <div class="reply-bar-name" id="replyBarName">Replying to</div>
                        <div class="reply-bar-text" id="replyBarText">Message text</div>
                    </div>
                    <button class="reply-bar-close" id="replyBarClose">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <div class="input-row">
                    <div class="input-actions">
                        <button class="input-btn" id="emojiBtn">
                            <span class="material-icons-round">emoji_emotions</span>
                        </button>
                        <button class="input-btn" id="attachBtn">
                            <span class="material-icons-round">attach_file</span>
                        </button>
                    </div>
                    <div class="input-field-container">
                        <textarea class="input-field" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                    </div>
                    <button class="input-btn" id="scheduleBtn">
                        <span class="material-icons-round">schedule_send</span>
                    </button>
                    <button class="send-btn" id="sendBtn">
                        <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div class="screen" id="profileScreen">
            <div class="profile-header-bg">
                <div class="profile-header-back">
                    <button class="back-btn" id="profileBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                </div>
            </div>
            <div class="profile-avatar-container">
                <div class="profile-avatar-wrapper">
                    <div class="profile-avatar-large">
                        <img src="" alt="" id="profileAvatarImg">
                    </div>
                    <div class="profile-avatar-edit" id="profileAvatarEdit">
                        <span class="material-icons-round">camera_alt</span>
                    </div>
                </div>
                <div class="profile-name-display" id="profileNameDisplay">User</div>
                <div class="profile-username-display" id="profileUsernameDisplay">@username</div>
                <div class="profile-bio-display" id="profileBioDisplay">No bio yet</div>
            </div>

            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileChatsCount">0</div>
                    <div class="profile-stat-label">Chats</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileFriendsCount">0</div>
                    <div class="profile-stat-label">Friends</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileMediaCount">0</div>
                    <div class="profile-stat-label">Media</div>
                </div>
            </div>

            <div class="profile-content">
                <div class="profile-section">
                    <div class="profile-section-title">Profile</div>
                    <div class="profile-item" data-action="edit-profile">
                        <div class="profile-item-icon blue">
                            <span class="material-icons-round">edit</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Edit Profile</div>
                            <div class="profile-item-subtitle">Change name, bio, photo</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="profile-item" data-action="qrcode">
                        <div class="profile-item-icon green">
                            <span class="material-icons-round">qr_code_2</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">My QR Code</div>
                            <div class="profile-item-subtitle">Share your profile</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">Settings</div>
                    <div class="profile-item" data-action="privacy">
                        <div class="profile-item-icon">
                            <span class="material-icons-round">lock</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Privacy</div>
                            <div class="profile-item-subtitle">Last seen, profile photo, status</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="profile-item" data-action="notifications">
                        <div class="profile-item-icon">
                            <span class="material-icons-round">notifications</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Notifications</div>
                            <div class="profile-item-subtitle">Message, group notifications</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="profile-item" data-action="storage">
                        <div class="profile-item-icon">
                            <span class="material-icons-round">storage</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Storage & Data</div>
                            <div class="profile-item-subtitle">Manage storage, network usage</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                    <div class="profile-item" data-action="appearance">
                        <div class="profile-item-icon purple">
                            <span class="material-icons-round">palette</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Appearance</div>
                            <div class="profile-item-subtitle">Theme, wallpaper, font size</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">AI Features</div>
                    <div class="profile-item" data-action="ai-settings">
                        <div class="profile-item-icon purple">
                            <span class="material-icons-round">smart_toy</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">AI Assistant</div>
                            <div class="profile-item-subtitle">Auto-reply, translate, summarize</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">Account</div>
                    <div class="profile-item" data-action="blocked">
                        <div class="profile-item-icon red">
                            <span class="material-icons-round">block</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Blocked Users</div>
                            <div class="profile-item-subtitle" id="blockedCountText">0 blocked</div>
                        </div>
                        <div class="profile-item-arrow">
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Profile Screen -->
        <div class="screen" id="editProfileScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="editProfileBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Edit Profile</span>
                </div>
            </div>

            <div class="edit-profile-content">
                <div style="display: flex; justify-content: center; margin-bottom: 24px;">
                    <div class="profile-avatar-wrapper">
                        <div class="profile-avatar-large">
                            <img src="" alt="" id="editProfileAvatarImg">
                        </div>
                        <div class="profile-avatar-edit" id="editProfileAvatarBtn">
                            <span class="material-icons-round">camera_alt</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" class="form-input" id="editDisplayName" placeholder="Enter your name" maxlength="30">
                    <div class="form-counter"><span id="nameCounter">0</span>/30</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="editUsername" disabled>
                    <div class="form-hint">Username cannot be changed</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input form-textarea" id="editBio" placeholder="Write something about yourself..." maxlength="150"></textarea>
                    <div class="form-counter"><span id="bioCounter">0</span>/150</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="editEmail" disabled>
                </div>

                <button class="save-profile-btn" id="saveProfileBtn">Save Changes</button>
            </div>
        </div>

        <!-- Settings Screen -->
        <div class="screen" id="settingsScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="settingsBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Settings</span>
                </div>
            </div>

            <div class="settings-content" id="settingsContent">
                <!-- Settings content will be rendered dynamically -->
            </div>
        </div>

        <!-- Privacy Settings Screen -->
        <div class="screen" id="privacyScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="privacyBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Privacy</span>
                </div>
            </div>

            <div class="settings-content" id="privacyContent">
                <!-- Privacy settings will be rendered here -->
            </div>
        </div>

        <!-- Storage Screen -->
        <div class="screen" id="storageScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="storageBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Storage & Data</span>
                </div>
            </div>

            <div class="settings-content" id="storageContent">
                <!-- Storage content will be rendered here -->
            </div>
        </div>

        <!-- Appearance Screen -->
        <div class="screen" id="appearanceScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="appearanceBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Appearance</span>
                </div>
            </div>

            <div class="settings-content" id="appearanceContent">
                <!-- Appearance settings will be rendered here -->
            </div>
        </div>

        <!-- Notifications Screen -->
        <div class="screen" id="notificationsScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="notificationsBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Notifications</span>
                </div>
            </div>

            <div class="settings-content" id="notificationsContent">
                <!-- Notification settings will be rendered here -->
            </div>
        </div>

        <!-- AI Settings Screen -->
        <div class="screen" id="aiSettingsScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="aiSettingsBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">AI Features</span>
                </div>
            </div>

            <div class="settings-content" id="aiSettingsContent">
                <!-- AI settings will be rendered here -->
            </div>
        </div>

        <!-- Starred Messages Screen -->
        <div class="screen" id="starredScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="starredBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Starred Messages</span>
                </div>
            </div>

            <div class="chat-list" id="starredList">
                <!-- Starred messages will be loaded here -->
            </div>
        </div>

        <!-- Archived Chats Screen -->
        <div class="screen" id="archivedScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="archivedBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Archived Chats</span>
                </div>
            </div>

            <div class="chat-list" id="archivedList">
                <!-- Archived chats will be loaded here -->
            </div>
        </div>

        <!-- Scheduled Messages Screen -->
        <div class="screen" id="scheduledScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="scheduledBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Scheduled Messages</span>
                </div>
            </div>

            <div class="chat-list" id="scheduledList">
                <!-- Scheduled messages will be loaded here -->
            </div>
        </div>

        <!-- Blocked Users Screen -->
        <div class="screen" id="blockedScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="blockedBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Blocked Users</span>
                </div>
            </div>

            <div class="chat-list" id="blockedList">
                <!-- Blocked users will be loaded here -->
            </div>
        </div>

        <!-- User Profile View Screen -->
        <div class="screen" id="userProfileScreen">
            <div class="profile-header-bg">
                <div class="profile-header-back">
                    <button class="back-btn" id="userProfileBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                </div>
            </div>
            <div class="profile-avatar-container">
                <div class="profile-avatar-wrapper">
                    <div class="profile-avatar-large">
                        <img src="" alt="" id="userProfileAvatarImg">
                    </div>
                </div>
                <div class="profile-name-display" id="userProfileName">User</div>
                <div class="profile-username-display" id="userProfileUsername">@username</div>
                <div class="profile-bio-display" id="userProfileBio">No bio</div>
            </div>

            <div class="profile-content">
                <div class="profile-section">
                    <div class="profile-item" id="userProfileMessageBtn">
                        <div class="profile-item-icon blue">
                            <span class="material-icons-round">chat</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title">Send Message</div>
                        </div>
                    </div>
                    <div class="profile-item" id="userProfileBlockBtn">
                        <div class="profile-item-icon red">
                            <span class="material-icons-round">block</span>
                        </div>
                        <div class="profile-item-content">
                            <div class="profile-item-title" id="userProfileBlockText">Block User</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Screen -->
        <div class="screen" id="helpScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="helpBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">Help Center</span>
                </div>
            </div>

            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-section-title">FAQ</div>
                    <div class="settings-item" data-faq="1">
                        <div class="settings-item-content">
                            <div class="settings-item-title">How do I add friends?</div>
                        </div>
                        <div class="settings-item-arrow">
                            <span class="material-icons-round">expand_more</span>
                        </div>
                    </div>
                    <div class="settings-item" data-faq="2">
                        <div class="settings-item-content">
                            <div class="settings-item-title">How do I schedule messages?</div>
                        </div>
                        <div class="settings-item-arrow">
                            <span class="material-icons-round">expand_more</span>
                        </div>
                    </div>
                    <div class="settings-item" data-faq="3">
                        <div class="settings-item-content">
                            <div class="settings-item-title">How do I use AI features?</div>
                        </div>
                        <div class="settings-item-arrow">
                            <span class="material-icons-round">expand_more</span>
                        </div>
                    </div>
                    <div class="settings-item" data-faq="4">
                        <div class="settings-item-content">
                            <div class="settings-item-title">What are storage limits?</div>
                        </div>
                        <div class="settings-item-arrow">
                            <span class="material-icons-round">expand_more</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Contact</div>
                    <div class="settings-item" id="contactSupportBtn">
                        <div class="settings-item-icon blue">
                            <span class="material-icons-round">email</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">Email Support</div>
                            <div class="settings-item-subtitle">support@whatsup.app</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Screen -->
        <div class="screen" id="aboutScreen">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="back-btn" id="aboutBackBtn">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    <span class="app-title">About</span>
                </div>
            </div>

            <div class="settings-content" style="padding: 40px 20px; text-align: center;">
                <div class="auth-logo" style="margin: 0 auto 20px;">W</div>
                <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 8px;">What's Up</h2>
                <p style="color: var(--secondary-text); margin-bottom: 24px;">Version 1.0.0</p>
                <p style="color: var(--secondary-text); line-height: 1.6; max-width: 300px; margin: 0 auto;">
                    A fast, secure, and feature-rich messaging app with AI-powered features.
                </p>
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-light);">
                    <p style="font-size: 13px; color: var(--tertiary-text);"> 2024 What's Up. All rights reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Logout Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">
                    <span class="material-icons-round">logout</span>
                </div>
                <h3 class="modal-title">Log Out?</h3>
            </div>
            <div class="modal-body">
                <p class="modal-text">Are you sure you want to log out of your account?</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="logoutCancelBtn">Cancel</button>
                <button class="modal-btn primary" id="logoutConfirmBtn">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="deleteAccountModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon danger">
                    <span class="material-icons-round">warning</span>
                </div>
                <h3 class="modal-title">Delete Account?</h3>
            </div>
            <div class="modal-body">
                <p class="modal-text">This action is permanent and cannot be undone. All your data will be deleted.</p>
                <input type="text" class="modal-input" id="deleteConfirmInput" placeholder="Type DELETE to confirm">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="deleteCancelBtn">Cancel</button>
                <button class="modal-btn danger" id="deleteConfirmBtn" disabled>Delete</button>
            </div>
        </div>
    </div>

    <!-- Schedule Message Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon warning">
                    <span class="material-icons-round">schedule_send</span>
                </div>
                <h3 class="modal-title">Schedule Message</h3>
            </div>
            <div class="modal-body">
                <div class="schedule-datetime">
                    <input type="date" id="scheduleDateInput">
                    <input type="time" id="scheduleTimeInput">
                </div>
                <textarea class="form-input form-textarea" id="scheduleMessageInput" placeholder="Enter your message..." style="min-height: 80px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="scheduleCancelBtn">Cancel</button>
                <button class="modal-btn primary" id="scheduleConfirmBtn">Schedule</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qrModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">My QR Code</h3>
            </div>
            <div class="modal-body">
                <div class="qr-code-container">
                    <div class="qr-code-image" id="qrCodeImage"></div>
                    <div class="qr-username" id="qrUsername">@username</div>
                    <div class="qr-hint">Scan this code to add me</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="qrCloseBtn" style="flex: 1;">Close</button>
                <button class="modal-btn primary" id="qrShareBtn" style="flex: 1;">Share</button>
            </div>
        </div>
    </div>

    <!-- Report Problem Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">
                    <span class="material-icons-round">bug_report</span>
                </div>
                <h3 class="modal-title">Report Problem</h3>
            </div>
            <div class="modal-body">
                <textarea class="form-input form-textarea" id="reportInput" placeholder="Describe the issue..." style="min-height: 100px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="reportCancelBtn">Cancel</button>
                <button class="modal-btn primary" id="reportSubmitBtn">Submit</button>
            </div>
        </div>
    </div>

    <!-- Option Selector Modal -->
    <div class="modal-overlay" id="optionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="optionModalTitle">Select Option</h3>
            </div>
            <div class="modal-body" id="optionModalContent" style="padding: 0;">
                <!-- Options will be rendered here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="optionCancelBtn" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Action Sheets -->
    <!-- Attachment Sheet -->
    <div class="action-sheet-overlay" id="attachmentSheet">
        <div class="action-sheet">
            <div class="action-sheet-handle"></div>
            <div class="action-sheet-title">Share Content</div>
            <div class="action-sheet-item" data-attach="photo">
                <span class="material-icons-round" style="color: #22C55E;">photo</span>
                <span class="action-sheet-item-text">Photo</span>
            </div>
            <div class="action-sheet-item" data-attach="video">
                <span class="material-icons-round" style="color: #EC4899;">videocam</span>
                <span class="action-sheet-item-text">Video</span>
            </div>
            <div class="action-sheet-item" data-attach="document">
                <span class="material-icons-round" style="color: #3B82F6;">description</span>
                <span class="action-sheet-item-text">Document</span>
            </div>
            <div class="action-sheet-item" data-attach="camera">
                <span class="material-icons-round" style="color: #F59E0B;">camera_alt</span>
                <span class="action-sheet-item-text">Camera</span>
            </div>
            <div class="action-sheet-item" data-attach="location">
                <span class="material-icons-round" style="color: #EF4444;">location_on</span>
                <span class="action-sheet-item-text">Location</span>
            </div>
            <button class="action-sheet-cancel" id="attachmentCancelBtn">Cancel</button>
        </div>
    </div>

    <!-- Chat Options Sheet -->
    <div class="action-sheet-overlay" id="chatOptionsSheet">
        <div class="action-sheet">
            <div class="action-sheet-handle"></div>
            <div class="action-sheet-title">Chat Options</div>
            <div class="action-sheet-item" data-chat-action="view-profile">
                <span class="material-icons-round">person</span>
                <span class="action-sheet-item-text">View Profile</span>
            </div>
            <div class="action-sheet-item" data-chat-action="search">
                <span class="material-icons-round">search</span>
                <span class="action-sheet-item-text">Search Messages</span>
            </div>
            <div class="action-sheet-item" data-chat-action="mute">
                <span class="material-icons-round">notifications_off</span>
                <span class="action-sheet-item-text" id="muteOptionText">Mute Notifications</span>
            </div>
            <div class="action-sheet-item" data-chat-action="wallpaper">
                <span class="material-icons-round">wallpaper</span>
                <span class="action-sheet-item-text">Chat Wallpaper</span>
            </div>
            <div class="action-sheet-item" data-chat-action="pin">
                <span class="material-icons-round">push_pin</span>
                <span class="action-sheet-item-text" id="pinOptionText">Pin Chat</span>
            </div>
            <div class="action-sheet-item" data-chat-action="archive">
                <span class="material-icons-round">archive</span>
                <span class="action-sheet-item-text" id="archiveOptionText">Archive Chat</span>
            </div>
            <div class="action-sheet-item" data-chat-action="clear">
                <span class="material-icons-round">delete_sweep</span>
                <span class="action-sheet-item-text">Clear Messages</span>
            </div>
            <div class="action-sheet-item danger" data-chat-action="block">
                <span class="material-icons-round">block</span>
                <span class="action-sheet-item-text" id="blockOptionText">Block User</span>
            </div>
            <button class="action-sheet-cancel" id="chatOptionsCancelBtn">Cancel</button>
        </div>
    </div>

    <!-- Message Context Menu -->
    <div class="context-menu" id="messageContextMenu">
        <div class="context-menu-item" data-msg-action="reply">
            <span class="material-icons-round">reply</span>
            <span>Reply</span>
        </div>
        <div class="context-menu-item" data-msg-action="copy">
            <span class="material-icons-round">content_copy</span>
            <span>Copy</span>
        </div>
        <div class="context-menu-item" data-msg-action="forward">
            <span class="material-icons-round">forward</span>
            <span>Forward</span>
        </div>
        <div class="context-menu-item" data-msg-action="star">
            <span class="material-icons-round">star_outline</span>
            <span>Star</span>
        </div>
        <div class="context-menu-item" data-msg-action="edit">
            <span class="material-icons-round">edit</span>
            <span>Edit</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-msg-action="delete">
            <span class="material-icons-round">delete</span>
            <span>Delete</span>
        </div>
    </div>

    <!-- Quick Reactions -->
    <div class="quick-reactions" id="quickReactions">
        <button class="quick-reaction-btn" data-reaction=""></button>
        <button class="quick-reaction-btn" data-reaction=""></button>
        <button class="quick-reaction-btn" data-reaction=""></button>
        <button class="quick-reaction-btn" data-reaction=""></button>
        <button class="quick-reaction-btn" data-reaction=""></button>
        <button class="quick-reaction-btn" data-reaction=""></button>
    </div>

    <!-- Emoji Picker -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-picker-header">
            <input type="text" class="emoji-search" id="emojiSearch" placeholder="Search emoji...">
        </div>
        <div class="emoji-categories">
            <button class="emoji-category-btn active" data-category="smileys">
                <span class="material-icons-round">emoji_emotions</span>
            </button>
            <button class="emoji-category-btn" data-category="gestures">
                <span class="material-icons-round">waving_hand</span>
            </button>
            <button class="emoji-category-btn" data-category="animals">
                <span class="material-icons-round">pets</span>
            </button>
            <button class="emoji-category-btn" data-category="food">
                <span class="material-icons-round">restaurant</span>
            </button>
            <button class="emoji-category-btn" data-category="activities">
                <span class="material-icons-round">sports_soccer</span>
            </button>
            <button class="emoji-category-btn" data-category="objects">
                <span class="material-icons-round">lightbulb</span>
            </button>
            <button class="emoji-category-btn" data-category="symbols">
                <span class="material-icons-round">favorite</span>
            </button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Emojis will be loaded here -->
        </div>
    </div>

    <!-- Upload Progress -->
    <div class="upload-progress" id="uploadProgress">
        <div class="upload-info">
            <div class="upload-icon">
                <span class="material-icons-round">cloud_upload</span>
            </div>
            <div class="upload-details">
                <div class="upload-filename" id="uploadFilename">Uploading...</div>
                <div class="upload-size" id="uploadSize">0 KB</div>
            </div>
        </div>
        <div class="upload-bar">
            <div class="upload-bar-fill" id="uploadBarFill"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="fileInput" accept="*/*" style="display: none;">
    <input type="file" id="imageInput" accept="image/*" style="display: none;">
    <input type="file" id="videoInput" accept="video/*" style="display: none;">
    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">

    <!-- SVG Gradient Definition -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <linearGradient id="storageGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#F56040"/>
                <stop offset="50%" style="stop-color:#C13584"/>
                <stop offset="100%" style="stop-color:#833AB4"/>
            </linearGradient>
        </defs>
    </svg>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyADpJve2b95BtSKxYFUxoo9MX40ASxvYSY",
                authDomain: "whatsupg6753.firebaseapp.com",
                databaseURL: "https://whatsupg6753-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "whatsupg6753",
                storageBucket: "whatsupg6753.firebasestorage.app",
                messagingSenderId: "622597842742",
                appId: "1:622597842742:web:72642ae955f15c91a6b597"
            },
            cloudinary: {
                cloudName: 'demo', // Replace with your cloudinary cloud name
                uploadPreset: 'ml_default' // Replace with your upload preset
            },
            geminiApiKey: 'AIzaSyBYovgobnIWppXnE0GHRdI5-5OpIAbmtH4',
            storage: {
                maxFileSize: 1 * 1024 * 1024, // 1 MB
                dailyLimit: 5 * 1024 * 1024,   // 5 MB per day
                lifetimeLimit: 100 * 1024 * 1024 // 100 MB lifetime
            }
        };

        // ============================================================
        // EMOJI DATA
        // ============================================================
        const EMOJIS = {
            smileys: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            gestures: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            animals: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            food: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            activities: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            objects: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
            symbols: ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','0','1','2','3','4','5','6','7','8','9','','','#','*','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','']
        };

        // ============================================================
        // INITIALIZE FIREBASE
        // ============================================================
        let app, auth, db, rtdb;

        try {
            app = firebase.initializeApp(CONFIG.firebase);
            auth = firebase.auth();
            db = firebase.firestore();
            rtdb = firebase.database();
            
            db.enablePersistence({ synchronizeTabs: true }).catch(err => {
                console.log('Persistence error:', err.code);
            });
            
            console.log(' Firebase initialized');
        } catch (error) {
            console.error(' Firebase error:', error);
        }

        // ============================================================
        // GLOBAL STATE
        // ============================================================
        const State = {
            currentUser: null,
            userData: null,
            currentChat: null,
            currentChatUser: null,
            selectedMessage: null,
            replyingTo: null,
            editingMessage: null,
            listeners: [],
            scheduledMessages: [],
            settings: {
                theme: 'light',
                fontSize: 'medium',
                enterToSend: true,
                onlineStatus: true,
                readReceipts: true,
                typingIndicator: true,
                lastSeen: 'everyone',
                profilePhoto: 'everyone',
                bio: 'everyone',
                messageNotifications: true,
                groupNotifications: true,
                notificationSound: true,
                vibration: true,
                aiAutoReply: false,
                aiTranslate: false,
                aiSummarize: false,
                aiSpamFilter: true,
                autoDownload: false,
                dataSaver: false
            },
            storage: {
                used: 0,
                daily: 0,
                lastReset: new Date().toDateString()
            }
                };

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        const Utils = {
            // Generate unique ID
            generateId: () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36),
            
            // Generate chat ID from two user IDs
            getChatId: (uid1, uid2) => uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`,
            
            // Generate avatar URL
            getAvatar: (name) => {
                const colors = ['F56040', 'C13584', '833AB4', '5851DB', '3B82F6', '22C55E', 'F59E0B', 'EF4444'];
                const color = colors[Math.abs(Utils.hashCode(name || 'User')) % colors.length];
                return `https://ui-avatars.com/api/?name=${encodeURIComponent(name || 'U')}&background=${color}&color=fff&bold=true&size=200`;
            },
            
            // Hash code for string
            hashCode: (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return hash;
            },
            
            // Format time
            formatTime: (date) => {
                if (!date) return '';
                const d = date instanceof Date ? date : date.toDate();
                const now = new Date();
                const diff = now - d;
                
                if (diff < 60000) return 'now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;
                
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },
            
            // Format message time
            formatMessageTime: (date) => {
                if (!date) return '';
                const d = date instanceof Date ? date : date.toDate();
                return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            },
            
            // Format date for separator
            formatDate: (date) => {
                if (!date) return '';
                const d = date instanceof Date ? date : date.toDate();
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (d.toDateString() === today.toDateString()) return 'Today';
                if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
                return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            },
            
            // Format file size
            formatFileSize: (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            },
            
            // Format last seen
            formatLastSeen: (date) => {
                if (!date) return 'offline';
                const d = date instanceof Date ? date : date.toDate();
                const diff = Date.now() - d.getTime();
                
                if (diff < 60000) return 'last seen just now';
                if (diff < 3600000) return `last seen ${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `last seen ${Math.floor(diff / 3600000)}h ago`;
                return `last seen ${d.toLocaleDateString()}`;
            },
            
            // Escape HTML
            escapeHtml: (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // Format message text with styling
            formatMessageText: (text) => {
                if (!text) return '';
                let formatted = Utils.escapeHtml(text);
                
                // Bold: *text*
                formatted = formatted.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
                // Italic: _text_
                formatted = formatted.replace(/_([^_]+)_/g, '<em>$1</em>');
                // Monospace: `text`
                formatted = formatted.replace(/`([^`]+)`/g, '<code style="background:rgba(0,0,0,0.1);padding:2px 6px;border-radius:4px;font-family:monospace;">$1</code>');
                // Links
                formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">$1</a>');
                // Line breaks
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            },
            
            // Vibrate
            vibrate: (duration = 10) => {
                if (State.settings.vibration && 'vibrate' in navigator) {
                    navigator.vibrate(duration);
                }
            },
            
            // Debounce
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ============================================================
        // UI FUNCTIONS
        // ============================================================
        const UI = {
            // Show screen
            showScreen: (screenId) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('active');
                    Utils.vibrate(3);
                }
            },
            
            // Show loading
            showLoading: (show = true) => {
                document.getElementById('loadingOverlay').classList.toggle('active', show);
            },
            
            // Show toast
            showToast: (message, duration = 2500) => {
                const existing = document.querySelector('.toast');
                if (existing) existing.remove();
                
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'toastOut 0.3s forwards';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            // Show modal
            showModal: (modalId) => {
                document.getElementById(modalId).classList.add('active');
                Utils.vibrate(5);
            },
            
            // Hide modal
            hideModal: (modalId) => {
                document.getElementById(modalId).classList.remove('active');
            },
            
            // Show action sheet
            showActionSheet: (sheetId) => {
                document.getElementById(sheetId).classList.add('active');
                Utils.vibrate(5);
            },
            
            // Hide action sheet
            hideActionSheet: (sheetId) => {
                document.getElementById(sheetId).classList.remove('active');
            },
            
            // Open sidebar
            openSidebar: () => {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').classList.add('active');
                Utils.vibrate(5);
            },
            
            // Close sidebar
            closeSidebar: () => {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            },
            
            // Update sidebar user info
            updateSidebarUser: () => {
                if (!State.userData) return;
                
                document.getElementById('sidebarAvatarImg').src = State.userData.photoURL || Utils.getAvatar(State.userData.username);
                document.getElementById('sidebarDisplayName').textContent = State.userData.displayName || State.userData.username || 'User';
                document.getElementById('sidebarUsername').textContent = '@' + (State.userData.username || 'user');
            },
            
            // Scroll to bottom of messages
            scrollToBottom: () => {
                const container = document.getElementById('messagesContainer');
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            },
            
            // Render empty state
            renderEmptyState: (container, icon, title, text, actionText = null, actionCallback = null) => {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-icons-round">${icon}</span>
                        </div>
                        <div class="empty-title">${title}</div>
                        <div class="empty-text">${text}</div>
                        ${actionText ? `<button class="empty-action" id="emptyActionBtn">${actionText}</button>` : ''}
                    </div>
                `;
                
                if (actionText && actionCallback) {
                    document.getElementById('emptyActionBtn')?.addEventListener('click', actionCallback);
                }
            }
        };

        // ============================================================
        // AUTHENTICATION
        // ============================================================
        const Auth = {
            // Initialize auth state listener
            init: () => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        State.currentUser = user;
                        await Auth.loadUserData();
                    } else {
                        State.currentUser = null;
                        State.userData = null;
                        UI.showScreen('authScreen');
                    }
                });
            },
            
            // Sign in with Google
            signInWithGoogle: async () => {
                try {
                    UI.showLoading(true);
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error('Sign in error:', error);
                    UI.showToast('Sign in failed. Please try again.');
                } finally {
                    UI.showLoading(false);
                }
            },
            
            // Load user data
            loadUserData: async () => {
                try {
                    const doc = await db.collection('users').doc(State.currentUser.uid).get();
                    
                    if (!doc.exists || !doc.data().username) {
                        UI.showScreen('usernameScreen');
                        Auth.generateUsernameSuggestions();
                    } else {
                        State.userData = doc.data();
                        State.settings = { ...State.settings, ...State.userData.settings };
                        State.storage = { ...State.storage, ...State.userData.storage };
                        
                        // Reset daily storage if new day
                        if (State.storage.lastReset !== new Date().toDateString()) {
                            State.storage.daily = 0;
                            State.storage.lastReset = new Date().toDateString();
                            await Auth.saveUserData({ storage: State.storage });
                        }
                        
                        UI.updateSidebarUser();
                        UI.showScreen('homeScreen');
                        
                        // Initialize app
                        Presence.setup();
                        Chats.loadAll();
                        Requests.listen();
                        Scheduled.loadAll();
                        Theme.apply(State.settings.theme);
                    }
                } catch (error) {
                    console.error('Load user data error:', error);
                    UI.showToast('Failed to load user data');
                }
            },
            
            // Save user data
            saveUserData: async (data) => {
                try {
                    await db.collection('users').doc(State.currentUser.uid).update(data);
                } catch (error) {
                    console.error('Save user data error:', error);
                }
            },
            
            // Generate username suggestions
            generateUsernameSuggestions: () => {
                const email = State.currentUser.email?.split('@')[0] || 'user';
                const name = State.currentUser.displayName?.replace(/\s+/g, '_').toLowerCase() || email;
                
                const suggestions = [
                    email,
                    name,
                    `${email}${Math.floor(Math.random() * 100)}`,
                    `${name.split('_')[0]}${Math.floor(Math.random() * 1000)}`,
                    `the_${email}`,
                    `${email}_${new Date().getFullYear() % 100}`
                ];
                
                const unique = [...new Set(suggestions)].slice(0, 6);
                const container = document.getElementById('usernameChips');
                container.innerHTML = unique.map(u => 
                    `<div class="username-chip" data-username="${u}">${u}</div>`
                ).join('');
            },
            
            // Check username availability
            checkUsername: async (username) => {
                if (username.length < 3) return { available: false, reason: 'Too short' };
                if (username.length > 20) return { available: false, reason: 'Too long' };
                if (!/^[a-z0-9_]+$/.test(username)) return { available: false, reason: 'Invalid characters' };
                
                try {
                    const doc = await db.collection('usernames').doc(username).get();
                    return { available: !doc.exists };
                } catch (error) {
                    return { available: false, reason: 'Error checking' };
                }
            },
            
            // Create user account
            createAccount: async (username) => {
                try {
                    UI.showLoading(true);
                    
                    // Reserve username
                    await db.collection('usernames').doc(username).set({
                        uid: State.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create user profile
                    const userData = {
                        uid: State.currentUser.uid,
                        username: username,
                        displayName: State.currentUser.displayName || username,
                        email: State.currentUser.email,
                        photoURL: State.currentUser.photoURL || Utils.getAvatar(username),
                        bio: '',
                        online: true,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        settings: State.settings,
                        storage: State.storage
                    };
                    
                    await db.collection('users').doc(State.currentUser.uid).set(userData);
                    
                    State.userData = userData;
                    UI.updateSidebarUser();
                    UI.showScreen('homeScreen');
                    UI.showToast('Welcome to What\'s Up! ');
                    
                    Presence.setup();
                    Chats.loadAll();
                    Requests.listen();
                    
                } catch (error) {
                    console.error('Create account error:', error);
                    UI.showToast('Failed to create account');
                } finally {
                    UI.showLoading(false);
                }
            },
            
            // Sign out
            signOut: async () => {
                try {
                    UI.showLoading(true);
                    
                    // Update online status
                    if (State.currentUser) {
                        await db.collection('users').doc(State.currentUser.uid).update({
                            online: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Unsubscribe all listeners
                    State.listeners.forEach(unsub => {
                        if (typeof unsub === 'function') unsub();
                    });
                    State.listeners = [];
                    
                    await auth.signOut();
                    UI.showToast('Logged out successfully');
                    
                } catch (error) {
                    console.error('Sign out error:', error);
                    UI.showToast('Failed to sign out');
                } finally {
                    UI.showLoading(false);
                }
            },
            
            // Delete account
            deleteAccount: async () => {
                try {
                    UI.showLoading(true);
                    
                    const uid = State.currentUser.uid;
                    const username = State.userData?.username;
                    
                    // Delete user document
                    await db.collection('users').doc(uid).delete();
                    
                    // Delete username reservation
                    if (username) {
                        await db.collection('usernames').doc(username).delete();
                    }
                    
                    // Delete user from Firebase Auth
                    await State.currentUser.delete();
                    
                    UI.showToast('Account deleted');
                    
                } catch (error) {
                    console.error('Delete account error:', error);
                    UI.showToast('Failed to delete account');
                } finally {
                    UI.showLoading(false);
                }
            }
        };

        // ============================================================
        // PRESENCE SYSTEM
        // ============================================================
        const Presence = {
            setup: () => {
                if (!State.currentUser || !State.settings.onlineStatus) return;
                
                const uid = State.currentUser.uid;
                const userStatusRef = rtdb.ref(`/status/${uid}`);
                
                const isOnline = {
                    state: 'online',
                    lastChanged: firebase.database.ServerValue.TIMESTAMP
                };
                
                const isOffline = {
                    state: 'offline',
                    lastChanged: firebase.database.ServerValue.TIMESTAMP
                };
                
                rtdb.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === false) return;
                    
                    userStatusRef.onDisconnect().set(isOffline).then(() => {
                        userStatusRef.set(isOnline);
                    });
                });
                
                // Update Firestore
                db.collection('users').doc(uid).update({
                    online: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            },
            
            setOffline: async () => {
                if (!State.currentUser) return;
                
                await db.collection('users').doc(State.currentUser.uid).update({
                    online: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        };

        // ============================================================
        // CHATS
        // ============================================================
        const Chats = {
            loadAll: () => {
                const unsub = db.collection('chats')
                    .where('participants', 'array-contains', State.currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .onSnapshot((snapshot) => {
                        Chats.render(snapshot.docs);
                    }, (error) => {
                        console.error('Load chats error:', error);
                    });
                
                State.listeners.push(unsub);
            },
            
            render: async (docs) => {
                const container = document.getElementById('chatList');
                
                if (docs.length === 0) {
                    UI.renderEmptyState(
                        container,
                        'chat_bubble_outline',
                        'No chats yet',
                        'Start a conversation by searching for friends',
                        'Find Friends',
                        () => UI.showScreen('searchScreen')
                    );
                    return;
                }
                
                const pinnedChats = [];
                const regularChats = [];
                const archivedChats = [];
                
                for (const doc of docs) {
                    const chat = { id: doc.id, ...doc.data() };
                    const otherUid = chat.participants.find(p => p !== State.currentUser.uid);
                    
                    // Get other user data
                    const userDoc = await db.collection('users').doc(otherUid).get();
                    if (!userDoc.exists) continue;
                    
                    chat.otherUser = { uid: otherUid, ...userDoc.data() };
                    
                    if (chat.archived?.[State.currentUser.uid]) {
                        archivedChats.push(chat);
                    } else if (chat.pinned?.[State.currentUser.uid]) {
                        pinnedChats.push(chat);
                    } else {
                        regularChats.push(chat);
                    }
                }
                
                // Update sidebar counts
                document.getElementById('sidebarChatsCount').textContent = docs.length;
                document.getElementById('sidebarFriendsCount').textContent = docs.length;
                
                // Build HTML
                let html = '';
                
                if (pinnedChats.length > 0) {
                    html += '<div class="list-section-header"><span class="material-icons-round" style="font-size:16px;">push_pin</span> Pinned</div>';
                    pinnedChats.forEach(chat => {
                        html += Chats.renderItem(chat, true);
                    });
                }
                
                regularChats.forEach(chat => {
                    html += Chats.renderItem(chat, false);
                });
                
                container.innerHTML = html || '<div class="empty-state"><div class="empty-title">No chats</div></div>';
                
                // Add click handlers
                container.querySelectorAll('.chat-item').forEach(item => {
                    const chatId = item.dataset.chatId;
                    item.addEventListener('click', () => Chats.open(chatId));
                    
                    // Long press for options
                    let pressTimer;
                    item.addEventListener('touchstart', () => {
                        pressTimer = setTimeout(() => {
                            Utils.vibrate(15);
                            const chat = [...pinnedChats, ...regularChats].find(c => c.id === chatId);
                            if (chat) {
                                State.currentChat = chat;
                                State.currentChatUser = chat.otherUser;
                                Chats.showOptions();
                            }
                        }, 500);
                    });
                    item.addEventListener('touchend', () => clearTimeout(pressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(pressTimer));
                });
                
                // Update archived count
                document.getElementById('archivedBadge').textContent = archivedChats.length;
                document.getElementById('archivedBadge').classList.toggle('hide', archivedChats.length === 0);
            },
            
            renderItem: (chat, isPinned) => {
                const user = chat.otherUser;
                const unread = chat.unreadCount?.[State.currentUser.uid] || 0;
                const muted = chat.muted?.[State.currentUser.uid];
                const time = chat.lastMessageTime ? Utils.formatTime(chat.lastMessageTime) : '';
                const preview = chat.lastMessage || 'Start chatting';
                
                return `
                    <div class="chat-item ${isPinned ? 'pinned' : ''} ${unread > 0 ? 'unread' : ''}" data-chat-id="${chat.id}">
                        <div class="chat-avatar">
                            <img src="${user.photoURL || Utils.getAvatar(user.username)}" alt="">
                            ${user.online && State.settings.onlineStatus ? '<div class="online-indicator"></div>' : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <div class="chat-name">
                                    ${isPinned ? '<span class="material-icons-round" style="font-size:14px;color:var(--link-blue);">push_pin</span>' : ''}
                                    ${Utils.escapeHtml(user.displayName || user.username)}
                                </div>
                                <div class="chat-time">${time}</div>
                            </div>
                            <div class="chat-preview">
                                <div class="chat-last-message">${Utils.escapeHtml(preview)}</div>
                                ${muted ? '<span class="material-icons-round chat-muted-icon">notifications_off</span>' : ''}
                                ${unread > 0 ? `<div class="chat-unread-badge">${unread}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            open: async (chatId) => {
                try {
                    const chatDoc = await db.collection('chats').doc(chatId).get();
                    if (!chatDoc.exists) {
                        UI.showToast('Chat not found');
                        return;
                    }
                    
                    const chat = { id: chatId, ...chatDoc.data() };
                    const otherUid = chat.participants.find(p => p !== State.currentUser.uid);
                    
                    const userDoc = await db.collection('users').doc(otherUid).get();
                    if (!userDoc.exists) {
                        UI.showToast('User not found');
                        return;
                    }
                    
                    State.currentChat = chat;
                    State.currentChatUser = { uid: otherUid, ...userDoc.data() };
                    
                    // Update UI
                    document.getElementById('chatHeaderAvatar').src = State.currentChatUser.photoURL || Utils.getAvatar(State.currentChatUser.username);
                    document.getElementById('chatHeaderName').textContent = State.currentChatUser.displayName || State.currentChatUser.username;
                    document.getElementById('chatOnlineIndicator').classList.toggle('hide', !State.currentChatUser.online || !State.settings.onlineStatus);
                    
                    Chats.updateStatus();
                    
                    UI.showScreen('chatScreen');
                    Messages.load(chatId);
                    Messages.markAsRead(chatId);
                    
                    // Listen for typing
                    Chats.listenTyping();
                    
                } catch (error) {
                    console.error('Open chat error:', error);
                    UI.showToast('Failed to open chat');
                }
            },
            
            updateStatus: () => {
                const statusEl = document.getElementById('chatHeaderStatus');
                
                if (State.currentChatUser.online && State.settings.onlineStatus) {
                    statusEl.textContent = 'online';
                    statusEl.classList.remove('typing');
                } else {
                    statusEl.textContent = Utils.formatLastSeen(State.currentChatUser.lastSeen);
                    statusEl.classList.remove('typing');
                }
            },
            
            listenTyping: () => {
                if (!State.currentChat || !State.settings.typingIndicator) return;
                
                const typingRef = rtdb.ref(`typing/${State.currentChat.id}/${State.currentChatUser.uid}`);
                typingRef.on('value', (snapshot) => {
                    const statusEl = document.getElementById('chatHeaderStatus');
                    if (snapshot.val()) {
                        statusEl.textContent = 'typing...';
                        statusEl.classList.add('typing');
                    } else {
                        Chats.updateStatus();
                    }
                });
            },
            
            setTyping: (isTyping) => {
                if (!State.currentChat || !State.settings.typingIndicator) return;
                
                const typingRef = rtdb.ref(`typing/${State.currentChat.id}/${State.currentUser.uid}`);
                if (isTyping) {
                    typingRef.set(true);
                } else {
                    typingRef.remove();
                }
            },
            
            showOptions: () => {
                if (!State.currentChat) return;
                
                const isPinned = State.currentChat.pinned?.[State.currentUser.uid];
                const isMuted = State.currentChat.muted?.[State.currentUser.uid];
                const isArchived = State.currentChat.archived?.[State.currentUser.uid];
                
                document.getElementById('pinOptionText').textContent = isPinned ? 'Unpin Chat' : 'Pin Chat';
                document.getElementById('muteOptionText').textContent = isMuted ? 'Unmute Notifications' : 'Mute Notifications';
                document.getElementById('archiveOptionText').textContent = isArchived ? 'Unarchive Chat' : 'Archive Chat';
                
                UI.showActionSheet('chatOptionsSheet');
            },
            
            togglePin: async () => {
                if (!State.currentChat) return;
                
                try {
                    const isPinned = State.currentChat.pinned?.[State.currentUser.uid];
                    await db.collection('chats').doc(State.currentChat.id).update({
                        [`pinned.${State.currentUser.uid}`]: !isPinned
                    });
                    
                    UI.showToast(isPinned ? 'Chat unpinned' : 'Chat pinned');
                } catch (error) {
                    console.error('Toggle pin error:', error);
                }
            },
            
            toggleMute: async () => {
                if (!State.currentChat) return;
                
                try {
                    const isMuted = State.currentChat.muted?.[State.currentUser.uid];
                    await db.collection('chats').doc(State.currentChat.id).update({
                        [`muted.${State.currentUser.uid}`]: !isMuted
                    });
                    
                    UI.showToast(isMuted ? 'Notifications unmuted' : 'Notifications muted');
                } catch (error) {
                    console.error('Toggle mute error:', error);
                }
            },
            
            toggleArchive: async () => {
                if (!State.currentChat) return;
                
                try {
                    const isArchived = State.currentChat.archived?.[State.currentUser.uid];
                    await db.collection('chats').doc(State.currentChat.id).update({
                        [`archived.${State.currentUser.uid}`]: !isArchived
                    });
                    
                    UI.showToast(isArchived ? 'Chat unarchived' : 'Chat archived');
                } catch (error) {
                    console.error('Toggle archive error:', error);
                }
            },
            
            clearMessages: async () => {
                if (!State.currentChat) return;
                if (!confirm('Clear all messages? This cannot be undone.')) return;
                
                try {
                    UI.showLoading(true);
                    
                    const messages = await db.collection('chats').doc(State.currentChat.id)
                        .collection('messages').get();
                    
                    const batch = db.batch();
                    messages.forEach(doc => {
                        batch.update(doc.ref, {
                            deletedFor: firebase.firestore.FieldValue.arrayUnion(State.currentUser.uid)
                        });
                    });
                    
                    await batch.commit();
                    UI.showToast('Messages cleared');
                    
                } catch (error) {
                    console.error('Clear messages error:', error);
                } finally {
                    UI.showLoading(false);
                }
            },
            
            close: () => {
                // Clear typing
                Chats.setTyping(false);
                
                // Unsubscribe from typing listener
                if (State.currentChat) {
                    rtdb.ref(`typing/${State.currentChat.id}/${State.currentChatUser?.uid}`).off();
                }
                
                State.currentChat = null;
                State.currentChatUser = null;
                State.replyingTo = null;
                State.editingMessage = null;
                
                document.getElementById('replyBar').classList.add('hide');
                document.getElementById('messagesContainer').innerHTML = '';
                
                UI.showScreen('homeScreen');
            }
        };

        // ============================================================
        // MESSAGES
        // ============================================================
        const Messages = {
            listener: null,
            lastDate: null,
            
            load: (chatId) => {
                // Unsubscribe previous listener
                if (Messages.listener) {
                    Messages.listener();
                }
                
                Messages.lastDate = null;
                document.getElementById('messagesContainer').innerHTML = '';
                
                Messages.listener = db.collection('chats').doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            const msg = { id: change.doc.id, ...change.doc.data() };
                            
                            // Skip if deleted for current user
                            if (msg.deletedFor?.includes(State.currentUser.uid)) return;
                            
                            if (change.type === 'added') {
                                Messages.render(msg);
                            } else if (change.type === 'modified') {
                                Messages.update(msg);
                            } else if (change.type === 'removed') {
                                Messages.remove(msg.id);
                            }
                        });
                        
                        UI.scrollToBottom();
                    });
                
                State.listeners.push(Messages.listener);
            },
            
            render: (msg) => {
                const container = document.getElementById('messagesContainer');
                const isSent = msg.senderId === State.currentUser.uid;
                
                // Add date separator if needed
                if (msg.timestamp) {
                    const msgDate = msg.timestamp.toDate().toDateString();
                    if (msgDate !== Messages.lastDate) {
                        Messages.lastDate = msgDate;
                        const separator = document.createElement('div');
                        separator.className = 'date-separator';
                        separator.innerHTML = `<span class="date-label">${Utils.formatDate(msg.timestamp)}</span>`;
                        container.appendChild(separator);
                    }
                }
                
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
                wrapper.id = `msg-${msg.id}`;
                wrapper.dataset.msgId = msg.id;
                
                let content = '';
                
                // Scheduled indicator
                if (msg.scheduled) {
                    content += `
                        <div class="scheduled-indicator">
                            <span class="material-icons-round">schedule</span>
                            Scheduled
                        </div>
                    `;
                }
                
                // Reply preview
                if (msg.replyTo) {
                    content += `
                        <div class="message-reply-preview">
                            <div class="message-reply-name">${msg.replyTo.senderName || 'Unknown'}</div>
                            <div class="message-reply-text">${Utils.escapeHtml(msg.replyTo.text || 'Media')}</div>
                        </div>
                    `;
                }
                
                // Message bubble
                content += '<div class="message-bubble">';
                
                // Media
                if (msg.mediaType === 'image' && msg.mediaUrl) {
                    content += `<div class="message-media"><img src="${msg.mediaUrl}" alt="Image" onclick="Messages.viewImage('${msg.mediaUrl}')"></div>`;
                } else if (msg.mediaType === 'video' && msg.mediaUrl) {
                    content += `<div class="message-media"><video src="${msg.mediaUrl}" controls></video></div>`;
                } else if (msg.mediaType === 'document' && msg.mediaUrl) {
                    content += `
                        <div class="message-document">
                            <div class="message-document-icon">
                                <span class="material-icons-round">description</span>
                            </div>
                            <div class="message-document-info">
                                <div class="message-document-name">${Utils.escapeHtml(msg.fileName || 'Document')}</div>
                                <div class="message-document-size">${Utils.formatFileSize(msg.fileSize || 0)}</div>
                            </div>
                            <a href="${msg.mediaUrl}" target="_blank" style="color:inherit;">
                                <span class="material-icons-round">download</span>
                            </a>
                        </div>
                    `;
                } else if (msg.location) {
                    content += `
                        <div class="message-media">
                            <a href="https://www.google.com/maps?q=${msg.location.lat},${msg.location.lng}" target="_blank">
                                <img src="https://maps.googleapis.com/maps/api/staticmap?center=${msg.location.lat},${msg.location.lng}&zoom=15&size=280x150&markers=${msg.location.lat},${msg.location.lng}" alt="Location" style="width:100%;border-radius:8px;">
                            </a>
                        </div>
                    `;
                }
                
                // Text
                if (msg.text) {
                    content += `<div class="message-text">${Utils.formatMessageText(msg.text)}</div>`;
                }
                
                // Footer
                content += '<div class="message-footer">';
                if (msg.edited) {
                    content += '<span class="message-edited">edited</span>';
                }
                content += `<span class="message-time">${Utils.formatMessageTime(msg.timestamp)}</span>`;
                if (isSent) {
                    const statusClass = msg.read ? 'read' : '';
                    const statusIcon = msg.read ? 'done_all' : (msg.delivered ? 'done_all' : 'done');
                    content += `<span class="message-status ${statusClass}"><span class="material-icons-round">${statusIcon}</span></span>`;
                }
                content += '</div>';
                
                content += '</div>'; // Close bubble
                
                // Reactions
                if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                    const reactionCounts = {};
                    Object.values(msg.reactions).forEach(emoji => {
                        reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                    });
                    
                    content += '<div class="message-reactions">';
                    Object.entries(reactionCounts).forEach(([emoji, count]) => {
                        content += `<div class="message-reaction" data-emoji="${emoji}">${emoji}<span class="message-reaction-count">${count}</span></div>`;
                    });
                    content += '</div>';
                }
                
                wrapper.innerHTML = content;
                container.appendChild(wrapper);
                
                // Add event listeners
                Messages.addEventListeners(wrapper, msg);
            },
            
            addEventListeners: (wrapper, msg) => {
                // Long press for context menu
                let pressTimer;
                
                wrapper.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        Utils.vibrate(15);
                        State.selectedMessage = msg;
                        Messages.showContextMenu(e, msg);
                    }, 500);
                });
                
                wrapper.addEventListener('touchend', () => clearTimeout(pressTimer));
                wrapper.addEventListener('touchmove', () => clearTimeout(pressTimer));
                
                // Double tap for quick reaction
                let lastTap = 0;
                wrapper.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTap < 300) {
                        e.preventDefault();
                        State.selectedMessage = msg;
                        Messages.showQuickReactions(e);
                    }
                    lastTap = now;
                });
                
                // Reaction click
                wrapper.querySelectorAll('.message-reaction').forEach(btn => {
                    btn.addEventListener('click', () => {
                        Messages.addReaction(msg.id, btn.dataset.emoji);
                    });
                });
            },
            
            update: (msg) => {
                const wrapper = document.getElementById(`msg-${msg.id}`);
                if (wrapper) {
                    // Update read status
                    const statusEl = wrapper.querySelector('.message-status');
                    if (statusEl && msg.read) {
                        statusEl.classList.add('read');
                        statusEl.innerHTML = '<span class="material-icons-round">done_all</span>';
                    }
                }
            },
            
            remove: (msgId) => {
                const wrapper = document.getElementById(`msg-${msgId}`);
                if (wrapper) {
                    wrapper.style.animation = 'fadeOut 0.3s forwards';
                    setTimeout(() => wrapper.remove(), 300);
                }
            },
            
            send: async (text, options = {}) => {
                if (!State.currentChat || (!text && !options.mediaUrl)) return;
                
                try {
                    const message = {
                        text: text || '',
                        senderId: State.currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        delivered: false,
                        read: false,
                        ...options
                    };
                    
                    // Add reply reference
                    if (State.replyingTo) {
                        message.replyTo = {
                            messageId: State.replyingTo.id,
                            text: State.replyingTo.text,
                            senderName: State.replyingTo.senderId === State.currentUser.uid 
                                ? 'You' 
                                : State.currentChatUser.displayName || State.currentChatUser.username
                        };
                        Messages.cancelReply();
                    }
                    
                    // Add message
                    await db.collection('chats').doc(State.currentChat.id)
                        .collection('messages').add(message);
                    
                    // Update chat
                    await db.collection('chats').doc(State.currentChat.id).update({
                        lastMessage: text || ' Attachment',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount.${State.currentChatUser.uid}`]: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Clear input
                    document.getElementById('messageInput').value = '';
                    document.getElementById('messageInput').style.height = 'auto';
                    document.getElementById('sendBtn').classList.remove('active');
                    
                    // Clear typing
                    Chats.setTyping(false);
                    
                    Utils.vibrate(5);
                    
                } catch (error) {
                    console.error('Send message error:', error);
                    UI.showToast('Failed to send message');
                }
            },
            
            edit: async (msgId, newText) => {
                if (!State.currentChat || !newText) return;
                
                try {
                    await db.collection('chats').doc(State.currentChat.id)
                        .collection('messages').doc(msgId).update({
                            text: newText,
                            edited: true,
                            editedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    State.editingMessage = null;
                    document.getElementById('sendBtn').innerHTML = '<span class="material-icons-round">send</span>';
                    UI.showToast('Message edited');
                    
                } catch (error) {
                    console.error('Edit message error:', error);
                }
            },
            
            delete: async (msgId, forEveryone = false) => {
                if (!State.currentChat) return;
                
                try {
                    if (forEveryone) {
                        await db.collection('chats').doc(State.currentChat.id)
                            .collection('messages').doc(msgId).delete();
                        UI.showToast('Message deleted for everyone');
                    } else {
                        await db.collection('chats').doc(State.currentChat.id)
                            .collection('messages').doc(msgId).update({
                                deletedFor: firebase.firestore.FieldValue.arrayUnion(State.currentUser.uid)
                            });
                        UI.showToast('Message deleted');
                    }
                } catch (error) {
                    console.error('Delete message error:', error);
                }
            },
            
            addReaction: async (msgId, emoji) => {
                if (!State.currentChat) return;
                
                try {
                    await db.collection('chats').doc(State.currentChat.id)
                        .collection('messages').doc(msgId).update({
                            [`reactions.${State.currentUser.uid}`]: emoji
                        });
                    Utils.vibrate(5);
                } catch (error) {
                    console.error('Add reaction error:', error);
                }
            },
            
            star: async (msgId) => {
                try {
                    const msg = State.selectedMessage;
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('starred').doc(msgId).set({
                            chatId: State.currentChat.id,
                            messageId: msgId,
                            text: msg.text,
                            timestamp: msg.timestamp,
                            starredAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    UI.showToast('Message starred ');
                } catch (error) {
                    console.error('Star message error:', error);
                }
            },
            
            copy: () => {
                if (!State.selectedMessage?.text) return;
                navigator.clipboard.writeText(State.selectedMessage.text);
                UI.showToast('Copied to clipboard');
                Utils.vibrate(5);
            },
            
            reply: () => {
                if (!State.selectedMessage) return;
                
                State.replyingTo = State.selectedMessage;
                
                const replyBar = document.getElementById('replyBar');
                document.getElementById('replyBarName').textContent = 
                    State.selectedMessage.senderId === State.currentUser.uid 
                        ? 'You' 
                        : State.currentChatUser.displayName || State.currentChatUser.username;
                document.getElementById('replyBarText').textContent = State.selectedMessage.text || 'Media';
                replyBar.classList.remove('hide');
                
                document.getElementById('messageInput').focus();
                Messages.hideContextMenu();
            },
            
            cancelReply: () => {
                State.replyingTo = null;
                document.getElementById('replyBar').classList.add('hide');
            },
            
            startEdit: () => {
                if (!State.selectedMessage || State.selectedMessage.senderId !== State.currentUser.uid) return;
                
                State.editingMessage = State.selectedMessage;
                document.getElementById('messageInput').value = State.selectedMessage.text || '';
                document.getElementById('messageInput').focus();
                document.getElementById('sendBtn').innerHTML = '<span class="material-icons-round">check</span>';
                document.getElementById('sendBtn').classList.add('active');
                
                Messages.hideContextMenu();
            },
            
            markAsRead: async (chatId) => {
                if (!State.settings.readReceipts) return;
                
                try {
                    // Mark messages as read
                    const unreadMessages = await db.collection('chats').doc(chatId)
                        .collection('messages')
                        .where('senderId', '!=', State.currentUser.uid)
                        .where('read', '==', false)
                        .get();
                    
                    const batch = db.batch();
                    unreadMessages.forEach(doc => {
                        batch.update(doc.ref, { read: true, delivered: true });
                    });
                    await batch.commit();
                    
                    // Reset unread count
                    await db.collection('chats').doc(chatId).update({
                        [`unreadCount.${State.currentUser.uid}`]: 0
                    });
                } catch (error) {
                    console.error('Mark as read error:', error);
                }
            },
            
            showContextMenu: (e, msg) => {
                const menu = document.getElementById('messageContextMenu');
                const rect = e.target.getBoundingClientRect();
                
                // Position menu
                let top = rect.top - 10;
                let left = rect.left;
                
                // Adjust if near edges
                if (top + 250 > window.innerHeight) top = window.innerHeight - 260;
                if (left + 200 > window.innerWidth) left = window.innerWidth - 210;
                if (top < 10) top = 10;
                if (left < 10) left = 10;
                
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                
                // Show/hide edit option
                const editOption = menu.querySelector('[data-msg-action="edit"]');
                editOption.style.display = msg.senderId === State.currentUser.uid ? 'flex' : 'none';
                
                menu.classList.add('active');
                
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', Messages.hideContextMenu, { once: true });
                }, 10);
            },
            
            hideContextMenu: () => {
                document.getElementById('messageContextMenu').classList.remove('active');
                document.getElementById('quickReactions').classList.remove('active');
            },
            
            showQuickReactions: (e) => {
                const reactions = document.getElementById('quickReactions');
                const rect = e.target.getBoundingClientRect();
                
                reactions.style.top = `${rect.top - 60}px`;
                reactions.style.left = `${Math.max(10, Math.min(rect.left - 100, window.innerWidth - 290))}px`;
                reactions.classList.add('active');
                
                setTimeout(() => {
                    document.addEventListener('click', Messages.hideContextMenu, { once: true });
                }, 10);
            },
            
            viewImage: (url) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.95); z-index: 3000;
                    display: flex; align-items: center; justify-content: center;
                    animation: fadeIn 0.3s;
                `;
                overlay.innerHTML = `
                    <img src="${url}" style="max-width:95%;max-height:95%;object-fit:contain;border-radius:8px;">
                    <button style="position:absolute;top:20px;right:20px;width:44px;height:44px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;">
                        <span class="material-icons-round" style="color:white;font-size:28px;">close</span>
                    </button>
                `;
                overlay.addEventListener('click', () => overlay.remove());
                document.body.appendChild(overlay);
            }
        };

        // Make viewImage accessible globally
        window.Messages = Messages;

        // ============================================================
        // SCHEDULED MESSAGES
        // ============================================================
        const Scheduled = {
            list: [],
            interval: null,
            
            loadAll: async () => {
                try {
                    const snapshot = await db.collection('users').doc(State.currentUser.uid)
                        .collection('scheduled').orderBy('sendAt', 'asc').get();
                    
                    Scheduled.list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update badge
                    document.getElementById('scheduledBadge').textContent = Scheduled.list.length;
                    document.getElementById('scheduledBadge').classList.toggle('hide', Scheduled.list.length === 0);
                    
                    // Start checking
                    Scheduled.startChecker();
                    
                } catch (error) {
                    console.error('Load scheduled error:', error);
                }
            },
            
            add: async (chatId, chatUser, text, sendAt) => {
                try {
                    const scheduled = {
                        chatId,
                        chatUserId: chatUser.uid,
                        chatUserName: chatUser.displayName || chatUser.username,
                        text,
                        sendAt: firebase.firestore.Timestamp.fromDate(sendAt),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('scheduled').add(scheduled);
                    
                    await Scheduled.loadAll();
                    UI.showToast('Message scheduled ');
                    
                } catch (error) {
                    console.error('Schedule message error:', error);
                    UI.showToast('Failed to schedule message');
                }
            },
            
            remove: async (id) => {
                try {
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('scheduled').doc(id).delete();
                    
                    await Scheduled.loadAll();
                    UI.showToast('Scheduled message removed');
                    
                } catch (error) {
                    console.error('Remove scheduled error:', error);
                }
            },
            
            send: async (scheduled) => {
                try {
                    // Send the message
                    const message = {
                        text: scheduled.text,
                        senderId: State.currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        delivered: false,
                        read: false,
                        scheduled: true
                    };
                    
                    await db.collection('chats').doc(scheduled.chatId)
                        .collection('messages').add(message);
                    
                    // Update chat
                    await db.collection('chats').doc(scheduled.chatId).update({
                        lastMessage: scheduled.text,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount.${scheduled.chatUserId}`]: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Remove from scheduled
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('scheduled').doc(scheduled.id).delete();
                    
                    await Scheduled.loadAll();
                    
                    console.log('Scheduled message sent:', scheduled.text);
                    
                } catch (error) {
                    console.error('Send scheduled error:', error);
                }
            },
            
            startChecker: () => {
                if (Scheduled.interval) {
                    clearInterval(Scheduled.interval);
                }
                
                Scheduled.interval = setInterval(() => {
                    const now = Date.now();
                    
                    Scheduled.list.forEach(scheduled => {
                        const sendTime = scheduled.sendAt.toDate().getTime();
                        if (sendTime <= now) {
                            Scheduled.send(scheduled);
                        }
                    });
                }, 10000); // Check every 10 seconds
            },
            
            render: () => {
                const container = document.getElementById('scheduledList');
                
                if (Scheduled.list.length === 0) {
                    UI.renderEmptyState(
                        container,
                        'schedule_send',
                        'No scheduled messages',
                        'Schedule messages to be sent later'
                    );
                    return;
                }
                
                container.innerHTML = Scheduled.list.map(s => `
                    <div class="request-item">
                        <div class="user-avatar">
                            <img src="${Utils.getAvatar(s.chatUserName)}" alt="">
                        </div>
                        <div class="request-info">
                            <div class="user-name">${Utils.escapeHtml(s.chatUserName)}</div>
                            <div class="request-text">${Utils.escapeHtml(s.text)}</div>
                            <div class="request-time">
                                <span class="material-icons-round" style="font-size:14px;vertical-align:middle;">schedule</span>
                                ${s.sendAt.toDate().toLocaleString()}
                            </div>
                        </div>
                        <button class="request-btn decline" onclick="Scheduled.remove('${s.id}')">Cancel</button>
                    </div>
                `).join('');
            }
        };

        // Make Scheduled accessible globally
        window.Scheduled = Scheduled;

        // ============================================================
        // SEARCH & REQUESTS
        // ============================================================
        const Search = {
            searchUsers: async (query) => {
                if (!query || query.length < 2) {
                    Search.showRecommended();
                    return;
                }
                
                try {
                    const snapshot = await db.collection('users')
                        .where('username', '>=', query.toLowerCase())
                        .where('username', '<=', query.toLowerCase() + '\uf8ff')
                        .limit(20)
                        .get();
                    
                    Search.renderResults(snapshot.docs.filter(doc => doc.id !== State.currentUser.uid));
                    
                } catch (error) {
                    console.error('Search error:', error);
                }
            },
            
            showRecommended: async () => {
                try {
                    const snapshot = await db.collection('users').limit(15).get();
                    const docs = snapshot.docs.filter(doc => doc.id !== State.currentUser.uid);
                    
                    const container = document.getElementById('searchContent');
                    container.innerHTML = `
                        <div class="search-section">
                            <div class="search-section-title">Suggested Users</div>
                            <div id="searchResults"></div>
                        </div>
                    `;
                    
                    Search.renderResults(docs);
                    
                } catch (error) {
                    console.error('Load recommended error:', error);
                }
            },
            
            renderResults: async (docs) => {
                const container = document.getElementById('searchResults') || document.getElementById('searchContent');
                
                if (docs.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-text">No users found</div></div>';
                    return;
                }
                
                // Check existing relationships
                const html = await Promise.all(docs.map(async (doc) => {
                    const user = doc.data();
                    const uid = doc.id;
                    
                    // Check if already friends
                    const chatId = Utils.getChatId(State.currentUser.uid, uid);
                    const chatDoc = await db.collection('chats').doc(chatId).get();
                    
                    // Check if request pending
                    const reqId1 = `${State.currentUser.uid}_${uid}`;
                    const reqId2 = `${uid}_${State.currentUser.uid}`;
                    const [req1, req2] = await Promise.all([
                        db.collection('friendRequests').doc(reqId1).get(),
                        db.collection('friendRequests').doc(reqId2).get()
                    ]);
                    
                    let btnText = 'Add';
                    let btnClass = '';
                    
                    if (chatDoc.exists) {
                        btnText = 'Message';
                        btnClass = 'friends';
                    } else if (req1.exists || req2.exists) {
                        btnText = 'Pending';
                        btnClass = 'pending';
                    }
                    
                    return `
                        <div class="user-item" data-uid="${uid}">
                            <div class="user-avatar">
                                <img src="${user.photoURL || Utils.getAvatar(user.username)}" alt="">
                            </div>
                            <div class="user-info">
                                <div class="user-name">${Utils.escapeHtml(user.displayName || user.username)}</div>
                                <div class="user-username">@${user.username}</div>
                            </div>
                            <button class="user-action-btn ${btnClass}" data-uid="${uid}" data-action="${chatDoc.exists ? 'message' : 'add'}">
                                ${btnText}
                            </button>
                        </div>
                    `;
                }));
                
                container.innerHTML = html.join('');
                
                // Add click handlers
                container.querySelectorAll('.user-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const uid = btn.dataset.uid;
                        const action = btn.dataset.action;
                        
                        if (action === 'message') {
                            const chatId = Utils.getChatId(State.currentUser.uid, uid);
                            UI.showScreen('homeScreen');
                            Chats.open(chatId);
                        } else if (action === 'add') {
                            await Requests.send(uid, btn);
                        }
                    });
                });
                
                container.querySelectorAll('.user-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const uid = item.dataset.uid;
                        Profile.viewUser(uid);
                    });
                });
            }
        };

        const Requests = {
            listen: () => {
                const unsub = db.collection('friendRequests')
                    .where('toUid', '==', State.currentUser.uid)
                    .where('status', '==', 'pending')
                    .onSnapshot((snapshot) => {
                        const count = snapshot.size;
                        const badge = document.getElementById('requestsBadge');
                        badge.textContent = count;
                        badge.classList.toggle('hide', count === 0);
                    });
                
                State.listeners.push(unsub);
            },
            
            load: async () => {
                try {
                    const snapshot = await db.collection('friendRequests')
                        .where('toUid', '==', State.currentUser.uid)
                        .where('status', '==', 'pending')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    Requests.render(snapshot.docs);
                    
                } catch (error) {
                    console.error('Load requests error:', error);
                }
            },
            
            render: (docs) => {
                const container = document.getElementById('requestsList');
                
                if (docs.length === 0) {
                    UI.renderEmptyState(
                        container,
                        'person_add',
                        'No friend requests',
                        'Friend requests will appear here'
                    );
                    return;
                }
                
                container.innerHTML = docs.map(doc => {
                    const req = doc.data();
                    return `
                        <div class="request-item" data-req-id="${doc.id}">
                            <div class="user-avatar">
                                <img src="${req.fromPhotoURL || Utils.getAvatar(req.fromUsername)}" alt="">
                            </div>
                            <div class="request-info">
                                <div class="user-name">${Utils.escapeHtml(req.fromDisplayName || req.fromUsername)}</div>
                                <div class="request-text">wants to connect with you</div>
                                <div class="request-time">${Utils.formatTime(req.createdAt)}</div>
                            </div>
                            <div class="request-actions">
                                <button class="request-btn accept" data-action="accept" data-req-id="${doc.id}" data-from-uid="${req.fromUid}">Accept</button>
                                <button class="request-btn decline" data-action="decline" data-req-id="${doc.id}">Decline</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers
                container.querySelectorAll('.request-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const action = btn.dataset.action;
                        const reqId = btn.dataset.reqId;
                        const fromUid = btn.dataset.fromUid;
                        
                        if (action === 'accept') {
                            await Requests.accept(reqId, fromUid);
                        } else {
                            await Requests.decline(reqId);
                        }
                    });
                });
            },
            
            send: async (toUid, btn) => {
                try {
                    btn.disabled = true;
                    btn.textContent = '...';
                    
                    // Get target user data
                    const userDoc = await db.collection('users').doc(toUid).get();
                    if (!userDoc.exists) {
                        UI.showToast('User not found');
                        return;
                    }
                    const toUser = userDoc.data();
                    
                    const requestId = `${State.currentUser.uid}_${toUid}`;
                    
                    await db.collection('friendRequests').doc(requestId).set({
                        fromUid: State.currentUser.uid,
                        fromUsername: State.userData.username,
                        fromDisplayName: State.userData.displayName || State.userData.username,
                        fromPhotoURL: State.userData.photoURL || '',
                        toUid: toUid,
                        toUsername: toUser.username,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    btn.textContent = 'Sent';
                    btn.classList.add('pending');
                    UI.showToast('Request sent! ');
                    Utils.vibrate(5);
                    
                } catch (error) {
                    console.error('Send request error:', error);
                    btn.disabled = false;
                    btn.textContent = 'Add';
                    UI.showToast('Failed to send request');
                }
            },
            
            accept: async (reqId, fromUid) => {
                try {
                    UI.showLoading(true);
                    
                    // Create chat
                    const chatId = Utils.getChatId(State.currentUser.uid, fromUid);
                    await db.collection('chats').doc(chatId).set({
                        participants: [State.currentUser.uid, fromUid],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        unreadCount: {
                            [State.currentUser.uid]: 0,
                            [fromUid]: 0
                        }
                    });
                    
                    // Update request
                    await db.collection('friendRequests').doc(reqId).update({
                        status: 'accepted'
                    });
                    
                    UI.showToast('Request accepted! ');
                    await Requests.load();
                    
                } catch (error) {
                    console.error('Accept request error:', error);
                    UI.showToast('Failed to accept request');
                } finally {
                    UI.showLoading(false);
                }
            },
            
            decline: async (reqId) => {
                try {
                    await db.collection('friendRequests').doc(reqId).update({
                        status: 'declined'
                    });
                    
                    UI.showToast('Request declined');
                    await Requests.load();
                    
                } catch (error) {
                    console.error('Decline request error:', error);
                }
            }
        };

        // ============================================================
        // PROFILE
        // ============================================================
        const Profile = {
            load: () => {
                if (!State.userData) return;
                
                const avatar = State.userData.photoURL || Utils.getAvatar(State.userData.username);
                
                document.getElementById('profileAvatarImg').src = avatar;
                document.getElementById('profileNameDisplay').textContent = State.userData.displayName || State.userData.username;
                document.getElementById('profileUsernameDisplay').textContent = '@' + State.userData.username;
                document.getElementById('profileBioDisplay').textContent = State.userData.bio || 'No bio yet';
            },
            
            loadEdit: () => {
                if (!State.userData) return;
                
                document.getElementById('editProfileAvatarImg').src = State.userData.photoURL || Utils.getAvatar(State.userData.username);
                document.getElementById('editDisplayName').value = State.userData.displayName || '';
                document.getElementById('editUsername').value = '@' + State.userData.username;
                document.getElementById('editBio').value = State.userData.bio || '';
                document.getElementById('editEmail').value = State.currentUser.email || '';
                
                Profile.updateCounters();
            },
            
            updateCounters: () => {
                const name = document.getElementById('editDisplayName').value;
                const bio = document.getElementById('editBio').value;
                
                document.getElementById('nameCounter').textContent = name.length;
                document.getElementById('bioCounter').textContent = bio.length;
            },
            
            save: async () => {
                try {
                    UI.showLoading(true);
                    
                    const displayName = document.getElementById('editDisplayName').value.trim();
                    const bio = document.getElementById('editBio').value.trim();
                    const photoURL = document.getElementById('editProfileAvatarImg').src;
                    
                    await db.collection('users').doc(State.currentUser.uid).update({
                        displayName,
                        bio,
                        photoURL
                    });
                    
                    State.userData = { ...State.userData, displayName, bio, photoURL };
                    UI.updateSidebarUser();
                    Profile.load();
                    
                    UI.showToast('Profile saved! ');
                    UI.showScreen('profileScreen');
                    
                } catch (error) {
                    console.error('Save profile error:', error);
                    UI.showToast('Failed to save profile');
                } finally {
                    UI.showLoading(false);
                }
            },
            
            viewUser: async (uid) => {
                try {
                    const doc = await db.collection('users').doc(uid).get();
                    if (!doc.exists) {
                        UI.showToast('User not found');
                        return;
                    }
                    
                    const user = doc.data();
                    
                    document.getElementById('userProfileAvatarImg').src = user.photoURL || Utils.getAvatar(user.username);
                    document.getElementById('userProfileName').textContent = user.displayName || user.username;
                    document.getElementById('userProfileUsername').textContent = '@' + user.username;
                    document.getElementById('userProfileBio').textContent = user.bio || 'No bio';
                    
                    // Check if blocked
                    const blockedDoc = await db.collection('users').doc(State.currentUser.uid)
                        .collection('blocked').doc(uid).get();
                    
                    document.getElementById('userProfileBlockText').textContent = blockedDoc.exists ? 'Unblock User' : 'Block User';
                    
                    // Store uid for actions
                    document.getElementById('userProfileScreen').dataset.uid = uid;
                    
                    UI.showScreen('userProfileScreen');
                    
                } catch (error) {
                    console.error('View user error:', error);
                }
            },
            
            block: async (uid) => {
                try {
                    const blockedDoc = await db.collection('users').doc(State.currentUser.uid)
                        .collection('blocked').doc(uid).get();
                    
                    if (blockedDoc.exists) {
                        // Unblock
                        await db.collection('users').doc(State.currentUser.uid)
                            .collection('blocked').doc(uid).delete();
                        UI.showToast('User unblocked');
                        document.getElementById('userProfileBlockText').textContent = 'Block User';
                    } else {
                        // Block
                        const userDoc = await db.collection('users').doc(uid).get();
                        await db.collection('users').doc(State.currentUser.uid)
                            .collection('blocked').doc(uid).set({
                                username: userDoc.data()?.username || 'Unknown',
                                blockedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        UI.showToast('User blocked');
                        document.getElementById('userProfileBlockText').textContent = 'Unblock User';
                    }
                } catch (error) {
                    console.error('Block error:', error);
                }
            },
            
            showQR: () => {
                const username = State.userData?.username || 'user';
                document.getElementById('qrUsername').textContent = '@' + username;
                
                // Generate QR code
                const qrContainer = document.getElementById('qrCodeImage');
                qrContainer.innerHTML = '';
                
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.createElement('canvas'), `whatsup://user/${username}`, {
                        width: 168,
                        margin: 0,
                        color: {
                            dark: '#262626',
                            light: '#ffffff'
                        }
                    }, (error, canvas) => {
                        if (!error) {
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            qrContainer.appendChild(canvas);
                        }
                    });
                } else {
                    qrContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--secondary-text);">QR Code</div>';
                }
                
                UI.showModal('qrModal');
            }
        };

        // ============================================================
        // FILE UPLOAD
        // ============================================================
        const Upload = {
            upload: async (file, type = 'auto') => {
                // Check file size
                if (file.size > CONFIG.storage.maxFileSize) {
                    UI.showToast(`File too large! Max ${Utils.formatFileSize(CONFIG.storage.maxFileSize)}`);
                    return null;
                }
                
                // Check daily limit
                if (State.storage.daily + file.size > CONFIG.storage.dailyLimit) {
                    UI.showToast('Daily upload limit reached (5MB)');
                    return null;
                }
                
                // Check lifetime limit
                if (State.storage.used + file.size > CONFIG.storage.lifetimeLimit) {
                    UI.showToast('Storage limit reached (100MB)');
                    return null;
                }
                
                // Show progress
                const progress = document.getElementById('uploadProgress');
                const filename = document.getElementById('uploadFilename');
                const size = document.getElementById('uploadSize');
                const bar = document.getElementById('uploadBarFill');
                
                filename.textContent = file.name;
                size.textContent = Utils.formatFileSize(file.size);
                bar.style.width = '0%';
                progress.classList.add('active');
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CONFIG.cloudinary.uploadPreset);
                    formData.append('cloud_name', CONFIG.cloudinary.cloudName);
                    
                    return new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = (e.loaded / e.total) * 100;
                                bar.style.width = `${percent}%`;
                            }
                        });
                        
                        xhr.onload = async () => {
                            progress.classList.remove('active');
                            
                            if (xhr.status === 200) {
                                const response = JSON.parse(xhr.responseText);
                                
                                // Update storage
                                State.storage.daily += file.size;
                                State.storage.used += file.size;
                                await Auth.saveUserData({ storage: State.storage });
                                
                                resolve({
                                    url: response.secure_url,
                                    type: file.type.startsWith('image/') ? 'image' : 
                                          file.type.startsWith('video/') ? 'video' : 'document',
                                    name: file.name,
                                    size: file.size
                                });
                            } else {
                                reject(new Error('Upload failed'));
                            }
                        };
                        
                        xhr.onerror = () => {
                            progress.classList.remove('active');
                            reject(new Error('Upload failed'));
                        };
                        
                        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/auto/upload`);
                                        xhr.send(formData);
                    });
                    
                } catch (error) {
                    document.getElementById('uploadProgress').classList.remove('active');
                    console.error('Upload error:', error);
                    UI.showToast('Upload failed');
                    return null;
                }
            },
            
            sendMedia: async (file) => {
                const result = await Upload.upload(file);
                if (!result) return;
                
                await Messages.send('', {
                    mediaType: result.type,
                    mediaUrl: result.url,
                    fileName: result.name,
                    fileSize: result.size
                });
            },
            
            uploadAvatar: async (file) => {
                if (!file.type.startsWith('image/')) {
                    UI.showToast('Please select an image');
                    return null;
                }
                
                const result = await Upload.upload(file);
                if (!result) return null;
                
                return result.url;
            }
        };

        // ============================================================
        // SETTINGS
        // ============================================================
        const Settings = {
            render: (screenId, content) => {
                document.getElementById(screenId).innerHTML = content;
                Settings.bindToggleEvents(screenId);
            },
            
            bindToggleEvents: (containerId) => {
                document.querySelectorAll(`#${containerId} .toggle-switch`).forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        const setting = toggle.dataset.setting;
                        if (setting) {
                            State.settings[setting] = toggle.classList.contains('active');
                            Auth.saveUserData({ settings: State.settings });
                            Utils.vibrate(5);
                        }
                    });
                });
            },
            
            renderPrivacy: () => {
                const content = `
                    <div class="settings-section">
                        <div class="settings-section-title">Who can see my info</div>
                        
                        <div class="settings-item" data-privacy="lastSeen">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">schedule</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Last Seen</div>
                                <div class="settings-item-subtitle">${Settings.getPrivacyLabel(State.settings.lastSeen)}</div>
                            </div>
                            <div class="settings-item-arrow">
                                <span class="material-icons-round">chevron_right</span>
                            </div>
                        </div>
                        
                        <div class="settings-item" data-privacy="profilePhoto">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">account_circle</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Profile Photo</div>
                                <div class="settings-item-subtitle">${Settings.getPrivacyLabel(State.settings.profilePhoto)}</div>
                            </div>
                            <div class="settings-item-arrow">
                                <span class="material-icons-round">chevron_right</span>
                            </div>
                        </div>
                        
                        <div class="settings-item" data-privacy="bio">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">info</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Bio</div>
                                <div class="settings-item-subtitle">${Settings.getPrivacyLabel(State.settings.bio)}</div>
                            </div>
                            <div class="settings-item-arrow">
                                <span class="material-icons-round">chevron_right</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Messaging</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">visibility</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Online Status</div>
                                <div class="settings-item-subtitle">Show when you're online</div>
                            </div>
                            <div class="toggle-switch ${State.settings.onlineStatus ? 'active' : ''}" data-setting="onlineStatus"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">done_all</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Read Receipts</div>
                                <div class="settings-item-subtitle">Show when you've read messages</div>
                            </div>
                            <div class="toggle-switch ${State.settings.readReceipts ? 'active' : ''}" data-setting="readReceipts"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">edit</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Typing Indicator</div>
                                <div class="settings-item-subtitle">Show when you're typing</div>
                            </div>
                            <div class="toggle-switch ${State.settings.typingIndicator ? 'active' : ''}" data-setting="typingIndicator"></div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Blocked</div>
                        
                        <div class="settings-item" id="blockedUsersItem">
                            <div class="settings-item-icon" style="background:rgba(239,68,68,0.1);">
                                <span class="material-icons-round" style="color:var(--error-red);">block</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Blocked Users</div>
                                <div class="settings-item-subtitle" id="blockedCountDisplay">0 users</div>
                            </div>
                            <div class="settings-item-arrow">
                                <span class="material-icons-round">chevron_right</span>
                            </div>
                        </div>
                    </div>
                `;
                
                Settings.render('privacyContent', content);
                
                // Bind privacy option clicks
                document.querySelectorAll('[data-privacy]').forEach(item => {
                    item.addEventListener('click', () => {
                        const setting = item.dataset.privacy;
                        Settings.showPrivacyOptions(setting);
                    });
                });
                
                // Blocked users click
                document.getElementById('blockedUsersItem').addEventListener('click', () => {
                    Settings.loadBlockedUsers();
                    UI.showScreen('blockedScreen');
                });
                
                // Load blocked count
                Settings.loadBlockedCount();
            },
            
            renderNotifications: () => {
                const content = `
                    <div class="settings-section">
                        <div class="settings-section-title">Messages</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:rgba(34,197,94,0.1);">
                                <span class="material-icons-round" style="color:var(--online-green);">chat</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Message Notifications</div>
                                <div class="settings-item-subtitle">Show notifications for new messages</div>
                            </div>
                            <div class="toggle-switch ${State.settings.messageNotifications ? 'active' : ''}" data-setting="messageNotifications"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">group</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Group Notifications</div>
                                <div class="settings-item-subtitle">Show notifications for groups</div>
                            </div>
                            <div class="toggle-switch ${State.settings.groupNotifications ? 'active' : ''}" data-setting="groupNotifications"></div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Sound & Vibration</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">volume_up</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Notification Sound</div>
                                <div class="settings-item-subtitle">Play sound for notifications</div>
                            </div>
                            <div class="toggle-switch ${State.settings.notificationSound ? 'active' : ''}" data-setting="notificationSound"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">vibration</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Vibration</div>
                                <div class="settings-item-subtitle">Vibrate on notifications</div>
                            </div>
                            <div class="toggle-switch ${State.settings.vibration ? 'active' : ''}" data-setting="vibration"></div>
                        </div>
                    </div>
                `;
                
                Settings.render('notificationsContent', content);
            },
            
            renderStorage: () => {
                const usedPercent = (State.storage.used / CONFIG.storage.lifetimeLimit) * 100;
                const usedMB = (State.storage.used / (1024 * 1024)).toFixed(2);
                const dailyMB = (State.storage.daily / (1024 * 1024)).toFixed(2);
                const maxMB = (CONFIG.storage.lifetimeLimit / (1024 * 1024)).toFixed(0);
                const dailyMaxMB = (CONFIG.storage.dailyLimit / (1024 * 1024)).toFixed(0);
                
                const content = `
                    <div class="storage-overview">
                        <div class="storage-circle-container">
                            <div class="storage-circle">
                                <svg width="160" height="160">
                                    <circle class="storage-circle-bg" cx="80" cy="80" r="70"></circle>
                                    <circle class="storage-circle-fill" cx="80" cy="80" r="70" 
                                        style="stroke-dashoffset: ${440 - (440 * usedPercent / 100)}"></circle>
                                </svg>
                                <div class="storage-circle-text">
                                    <div class="storage-used">${usedMB}</div>
                                    <div class="storage-total">of ${maxMB} MB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="storage-stats">
                            <div class="storage-stat">
                                <div class="storage-stat-value">${dailyMB} MB</div>
                                <div class="storage-stat-label">Today (${dailyMaxMB} MB limit)</div>
                            </div>
                            <div class="storage-stat">
                                <div class="storage-stat-value">${usedPercent.toFixed(1)}%</div>
                                <div class="storage-stat-label ${usedPercent > 80 ? 'warning' : ''}">Used</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Data Usage</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">download</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Auto-Download Media</div>
                                <div class="settings-item-subtitle">Download photos & videos automatically</div>
                            </div>
                            <div class="toggle-switch ${State.settings.autoDownload ? 'active' : ''}" data-setting="autoDownload"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">data_saver_on</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Data Saver</div>
                                <div class="settings-item-subtitle">Reduce data usage</div>
                            </div>
                            <div class="toggle-switch ${State.settings.dataSaver ? 'active' : ''}" data-setting="dataSaver"></div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Manage</div>
                        
                        <div class="settings-item" id="clearCacheBtn">
                            <div class="settings-item-icon" style="background:rgba(239,68,68,0.1);">
                                <span class="material-icons-round" style="color:var(--error-red);">delete_sweep</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Clear Cache</div>
                                <div class="settings-item-subtitle">Free up storage space</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding:20px;text-align:center;">
                        <p style="font-size:13px;color:var(--secondary-text);line-height:1.5;">
                            <strong>Storage Limits:</strong><br>
                             Max file size: 1 MB<br>
                             Daily limit: 5 MB<br>
                             Lifetime limit: 100 MB
                        </p>
                    </div>
                `;
                
                Settings.render('storageContent', content);
                
                document.getElementById('clearCacheBtn')?.addEventListener('click', async () => {
                    if (confirm('Clear all cached data?')) {
                        localStorage.clear();
                        UI.showToast('Cache cleared');
                    }
                });
            },
            
            renderAppearance: () => {
                const content = `
                    <div class="settings-section">
                        <div class="settings-section-title">Theme</div>
                        
                        <div class="settings-item" data-theme="light">
                            <div class="settings-item-icon" style="background:rgba(245,158,11,0.1);">
                                <span class="material-icons-round" style="color:var(--warning-yellow);">light_mode</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Light</div>
                            </div>
                            <span class="material-icons-round" style="color:${State.settings.theme === 'light' ? 'var(--online-green)' : 'transparent'};">check_circle</span>
                        </div>
                        
                        <div class="settings-item" data-theme="dark">
                            <div class="settings-item-icon" style="background:rgba(59,130,246,0.1);">
                                <span class="material-icons-round" style="color:var(--link-blue);">dark_mode</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Dark</div>
                            </div>
                            <span class="material-icons-round" style="color:${State.settings.theme === 'dark' ? 'var(--online-green)' : 'transparent'};">check_circle</span>
                        </div>
                        
                        <div class="settings-item" data-theme="system">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">settings_suggest</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">System Default</div>
                            </div>
                            <span class="material-icons-round" style="color:${State.settings.theme === 'system' ? 'var(--online-green)' : 'transparent'};">check_circle</span>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Chat</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:var(--background-light);">
                                <span class="material-icons-round" style="color:var(--secondary-text);">keyboard_return</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Enter to Send</div>
                                <div class="settings-item-subtitle">Press Enter to send messages</div>
                            </div>
                            <div class="toggle-switch ${State.settings.enterToSend ? 'active' : ''}" data-setting="enterToSend"></div>
                        </div>
                    </div>
                `;
                
                Settings.render('appearanceContent', content);
                
                // Theme selection
                document.querySelectorAll('[data-theme]').forEach(item => {
                    item.addEventListener('click', () => {
                        const theme = item.dataset.theme;
                        State.settings.theme = theme;
                        Auth.saveUserData({ settings: State.settings });
                        Theme.apply(theme);
                        Settings.renderAppearance();
                        Utils.vibrate(5);
                    });
                });
            },
            
            renderAI: () => {
                const content = `
                    <div class="settings-section">
                        <div class="settings-section-title">AI Assistant</div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));">
                                <span class="material-icons-round" style="color:#8B5CF6;">smart_toy</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">AI Auto-Reply</div>
                                <div class="settings-item-subtitle">Generate smart reply suggestions</div>
                            </div>
                            <div class="toggle-switch ${State.settings.aiAutoReply ? 'active' : ''}" data-setting="aiAutoReply"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));">
                                <span class="material-icons-round" style="color:#8B5CF6;">translate</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Auto-Translate</div>
                                <div class="settings-item-subtitle">Translate messages automatically</div>
                            </div>
                            <div class="toggle-switch ${State.settings.aiTranslate ? 'active' : ''}" data-setting="aiTranslate"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));">
                                <span class="material-icons-round" style="color:#8B5CF6;">summarize</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Message Summary</div>
                                <div class="settings-item-subtitle">Summarize long conversations</div>
                            </div>
                            <div class="toggle-switch ${State.settings.aiSummarize ? 'active' : ''}" data-setting="aiSummarize"></div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));">
                                <span class="material-icons-round" style="color:#8B5CF6;">security</span>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">Spam Filter</div>
                                <div class="settings-item-subtitle">Detect and filter spam messages</div>
                            </div>
                            <div class="toggle-switch ${State.settings.aiSpamFilter ? 'active' : ''}" data-setting="aiSpamFilter"></div>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <p style="font-size:13px;color:var(--secondary-text);text-align:center;line-height:1.5;">
                            AI features are powered by Google Gemini and help enhance your messaging experience.
                        </p>
                    </div>
                `;
                
                Settings.render('aiSettingsContent', content);
            },
            
            getPrivacyLabel: (value) => {
                const labels = {
                    'everyone': 'Everyone',
                    'contacts': 'My Contacts',
                    'nobody': 'Nobody'
                };
                return labels[value] || 'Everyone';
            },
            
            showPrivacyOptions: (setting) => {
                const titles = {
                    'lastSeen': 'Last Seen',
                    'profilePhoto': 'Profile Photo',
                    'bio': 'Bio'
                };
                
                document.getElementById('optionModalTitle').textContent = titles[setting] || 'Select';
                
                const options = ['everyone', 'contacts', 'nobody'];
                const content = options.map(opt => `
                    <div class="settings-item" data-value="${opt}">
                        <span class="material-icons-round" style="color:${State.settings[setting] === opt ? 'var(--online-green)' : 'transparent'};">check_circle</span>
                        <div class="settings-item-content">
                            <div class="settings-item-title">${Settings.getPrivacyLabel(opt)}</div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('optionModalContent').innerHTML = content;
                
                // Bind clicks
                document.querySelectorAll('#optionModalContent .settings-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const value = item.dataset.value;
                        State.settings[setting] = value;
                        Auth.saveUserData({ settings: State.settings });
                        UI.hideModal('optionModal');
                        Settings.renderPrivacy();
                        Utils.vibrate(5);
                    });
                });
                
                UI.showModal('optionModal');
            },
            
            loadBlockedCount: async () => {
                try {
                    const snapshot = await db.collection('users').doc(State.currentUser.uid)
                        .collection('blocked').get();
                    
                    const count = snapshot.size;
                    document.getElementById('blockedCountDisplay').textContent = `${count} user${count !== 1 ? 's' : ''}`;
                    document.getElementById('blockedCountText').textContent = `${count} blocked`;
                } catch (error) {
                    console.error('Load blocked count error:', error);
                }
            },
            
            loadBlockedUsers: async () => {
                const container = document.getElementById('blockedList');
                
                try {
                    const snapshot = await db.collection('users').doc(State.currentUser.uid)
                        .collection('blocked').get();
                    
                    if (snapshot.empty) {
                        UI.renderEmptyState(container, 'block', 'No blocked users', 'Users you block will appear here');
                        return;
                    }
                    
                    container.innerHTML = await Promise.all(snapshot.docs.map(async doc => {
                        const blocked = doc.data();
                        const userDoc = await db.collection('users').doc(doc.id).get();
                        const user = userDoc.exists ? userDoc.data() : { username: blocked.username };
                        
                        return `
                            <div class="request-item">
                                <div class="user-avatar">
                                    <img src="${user.photoURL || Utils.getAvatar(user.username)}" alt="">
                                </div>
                                <div class="request-info">
                                    <div class="user-name">${Utils.escapeHtml(user.displayName || user.username)}</div>
                                    <div class="request-text">@${user.username}</div>
                                </div>
                                <button class="request-btn decline" onclick="Settings.unblockUser('${doc.id}')">Unblock</button>
                            </div>
                        `;
                    })).then(items => items.join(''));
                    
                } catch (error) {
                    console.error('Load blocked users error:', error);
                }
            },
            
            unblockUser: async (uid) => {
                try {
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('blocked').doc(uid).delete();
                    
                    UI.showToast('User unblocked');
                    Settings.loadBlockedUsers();
                    Settings.loadBlockedCount();
                } catch (error) {
                    console.error('Unblock error:', error);
                }
            }
        };

        // Make Settings accessible globally
        window.Settings = Settings;

        // ============================================================
        // THEME
        // ============================================================
        const Theme = {
            apply: (theme) => {
                let actualTheme = theme;
                
                if (theme === 'system') {
                    actualTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                
                document.documentElement.setAttribute('data-theme', actualTheme);
            }
        };

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (State.settings.theme === 'system') {
                Theme.apply('system');
            }
        });

        // ============================================================
        // AI FEATURES
        // ============================================================
        const AI = {
            call: async (prompt) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${CONFIG.geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
                } catch (error) {
                    console.error('AI call error:', error);
                    return null;
                }
            },
            
            generateReply: async (message) => {
                if (!State.settings.aiAutoReply) return null;
                const prompt = `Generate a short, friendly reply to: "${message}". Keep it under 30 words.`;
                return await AI.call(prompt);
            },
            
            translate: async (text, targetLang = 'English') => {
                if (!State.settings.aiTranslate) return null;
                const prompt = `Translate to ${targetLang}: "${text}". Only return the translation.`;
                return await AI.call(prompt);
            },
            
            summarize: async (messages) => {
                if (!State.settings.aiSummarize) return null;
                const prompt = `Summarize this conversation in 2-3 sentences: ${messages.join('\n')}`;
                return await AI.call(prompt);
            },
            
            checkSpam: async (text) => {
                if (!State.settings.aiSpamFilter) return false;
                const prompt = `Is this spam? Answer only "yes" or "no": "${text}"`;
                const result = await AI.call(prompt);
                return result?.toLowerCase().includes('yes');
            }
        };

        // ============================================================
        // EMOJI PICKER
        // ============================================================
        const EmojiPicker = {
            currentCategory: 'smileys',
            
            init: () => {
                EmojiPicker.loadCategory('smileys');
            },
            
            loadCategory: (category) => {
                EmojiPicker.currentCategory = category;
                const grid = document.getElementById('emojiGrid');
                const emojis = EMOJIS[category] || [];
                
                grid.innerHTML = emojis.map(emoji => 
                    `<button class="emoji-item" data-emoji="${emoji}">${emoji}</button>`
                ).join('');
                
                // Update active category
                document.querySelectorAll('.emoji-category-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.category === category);
                });
            },
            
            search: (query) => {
                if (!query) {
                    EmojiPicker.loadCategory(EmojiPicker.currentCategory);
                    return;
                }
                
                const grid = document.getElementById('emojiGrid');
                const allEmojis = Object.values(EMOJIS).flat();
                
                // Simple search - just show all emojis for now
                grid.innerHTML = allEmojis.slice(0, 64).map(emoji => 
                    `<button class="emoji-item" data-emoji="${emoji}">${emoji}</button>`
                ).join('');
            },
            
            insert: (emoji) => {
                const input = document.getElementById('messageInput');
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                
                input.value = text.substring(0, start) + emoji + text.substring(end);
                input.selectionStart = input.selectionEnd = start + emoji.length;
                input.focus();
                
                document.getElementById('sendBtn').classList.add('active');
                Utils.vibrate(3);
            },
            
            show: () => {
                document.getElementById('emojiPicker').classList.add('active');
            },
            
            hide: () => {
                document.getElementById('emojiPicker').classList.remove('active');
            },
            
            toggle: () => {
                document.getElementById('emojiPicker').classList.toggle('active');
            }
        };

        // ============================================================
        // STARRED MESSAGES
        // ============================================================
        const Starred = {
            load: async () => {
                const container = document.getElementById('starredList');
                
                try {
                    const snapshot = await db.collection('users').doc(State.currentUser.uid)
                        .collection('starred').orderBy('starredAt', 'desc').get();
                    
                    if (snapshot.empty) {
                        UI.renderEmptyState(container, 'star', 'No starred messages', 'Star important messages to find them here');
                        return;
                    }
                    
                    container.innerHTML = snapshot.docs.map(doc => {
                        const starred = doc.data();
                        return `
                            <div class="request-item">
                                <div style="flex:1;">
                                    <div class="user-name" style="font-size:14px;margin-bottom:4px;">${Utils.escapeHtml(starred.text || 'Media')}</div>
                                    <div class="request-time">${Utils.formatTime(starred.starredAt)}</div>
                                </div>
                                <button class="request-btn decline" onclick="Starred.remove('${doc.id}')">
                                    <span class="material-icons-round" style="font-size:18px;">star</span>
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Load starred error:', error);
                }
            },
            
            remove: async (id) => {
                try {
                    await db.collection('users').doc(State.currentUser.uid)
                        .collection('starred').doc(id).delete();
                    UI.showToast('Removed from starred');
                    Starred.load();
                } catch (error) {
                    console.error('Remove starred error:', error);
                }
            }
        };

        window.Starred = Starred;

        // ============================================================
        // ARCHIVED CHATS
        // ============================================================
        const Archived = {
            load: async () => {
                const container = document.getElementById('archivedList');
                
                try {
                    const snapshot = await db.collection('chats')
                        .where('participants', 'array-contains', State.currentUser.uid)
                        .get();
                    
                    const archivedChats = [];
                    
                    for (const doc of snapshot.docs) {
                        const chat = doc.data();
                        if (chat.archived?.[State.currentUser.uid]) {
                            const otherUid = chat.participants.find(p => p !== State.currentUser.uid);
                            const userDoc = await db.collection('users').doc(otherUid).get();
                            if (userDoc.exists) {
                                archivedChats.push({
                                    id: doc.id,
                                    ...chat,
                                    otherUser: userDoc.data()
                                });
                            }
                        }
                    }
                    
                    if (archivedChats.length === 0) {
                        UI.renderEmptyState(container, 'archive', 'No archived chats', 'Archive chats to hide them from your main list');
                        return;
                    }
                    
                    container.innerHTML = archivedChats.map(chat => `
                        <div class="chat-item archived" data-chat-id="${chat.id}">
                            <div class="chat-avatar">
                                <img src="${chat.otherUser.photoURL || Utils.getAvatar(chat.otherUser.username)}" alt="">
                            </div>
                            <div class="chat-info">
                                <div class="chat-header">
                                    <div class="chat-name">${Utils.escapeHtml(chat.otherUser.displayName || chat.otherUser.username)}</div>
                                </div>
                                <div class="chat-preview">
                                    <div class="chat-last-message">${Utils.escapeHtml(chat.lastMessage || 'No messages')}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add click handlers
                    container.querySelectorAll('.chat-item').forEach(item => {
                        item.addEventListener('click', () => {
                            Chats.open(item.dataset.chatId);
                        });
                    });
                    
                } catch (error) {
                    console.error('Load archived error:', error);
                }
            }
        };

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        function initEventListeners() {
            // Auth
            document.getElementById('googleSignInBtn').addEventListener('click', Auth.signInWithGoogle);
            
            // Sidebar
            document.getElementById('menuBtn').addEventListener('click', UI.openSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', UI.closeSidebar);
            
            // Sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    UI.closeSidebar();
                    
                    setTimeout(() => {
                        switch(action) {
                            case 'home':
                                UI.showScreen('homeScreen');
                                break;
                            case 'profile':
                                Profile.load();
                                UI.showScreen('profileScreen');
                                break;
                            case 'qrcode':
                                Profile.showQR();
                                break;
                            case 'settings':
                                UI.showScreen('settingsScreen');
                                break;
                            case 'privacy':
                                Settings.renderPrivacy();
                                UI.showScreen('privacyScreen');
                                break;
                            case 'notifications':
                                Settings.renderNotifications();
                                UI.showScreen('notificationsScreen');
                                break;
                            case 'storage':
                                Settings.renderStorage();
                                UI.showScreen('storageScreen');
                                break;
                            case 'appearance':
                                Settings.renderAppearance();
                                UI.showScreen('appearanceScreen');
                                break;
                            case 'archived':
                                Archived.load();
                                UI.showScreen('archivedScreen');
                                break;
                            case 'starred':
                                Starred.load();
                                UI.showScreen('starredScreen');
                                break;
                            case 'scheduled':
                                Scheduled.render();
                                UI.showScreen('scheduledScreen');
                                break;
                            case 'help':
                                UI.showScreen('helpScreen');
                                break;
                            case 'about':
                                UI.showScreen('aboutScreen');
                                break;
                            case 'report':
                                UI.showModal('reportModal');
                                break;
                            case 'logout':
                                UI.showModal('logoutModal');
                                break;
                            case 'delete-account':
                                UI.showModal('deleteAccountModal');
                                break;
                        }
                    }, 300);
                    
                    Utils.vibrate(5);
                });
            });
            
            // Username screen
            document.getElementById('usernameInput').addEventListener('input', Utils.debounce(async (e) => {
                const username = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
                e.target.value = username;
                
                const statusEl = document.getElementById('usernameStatus');
                const continueBtn = document.getElementById('usernameContinueBtn');
                
                if (username.length < 3) {
                    statusEl.innerHTML = '';
                    continueBtn.classList.remove('enabled');
                    return;
                }
                
                statusEl.innerHTML = '<span class="material-icons-round" style="animation:spin 1s linear infinite;">sync</span>';
                statusEl.className = 'username-status checking';
                
                const result = await Auth.checkUsername(username);
                
                if (result.available) {
                    statusEl.innerHTML = '<span class="material-icons-round">check_circle</span>';
                    statusEl.className = 'username-status available';
                    continueBtn.classList.add('enabled');
                } else {
                    statusEl.innerHTML = '<span class="material-icons-round">cancel</span>';
                    statusEl.className = 'username-status taken';
                    continueBtn.classList.remove('enabled');
                }
            }, 300));
            
            document.getElementById('usernameChips').addEventListener('click', (e) => {
                if (e.target.classList.contains('username-chip')) {
                    const username = e.target.dataset.username;
                    document.getElementById('usernameInput').value = username;
                    document.getElementById('usernameInput').dispatchEvent(new Event('input'));
                    Utils.vibrate(3);
                }
            });
            
            document.getElementById('usernameContinueBtn').addEventListener('click', () => {
                const username = document.getElementById('usernameInput').value;
                if (username.length >= 3) {
                    Auth.createAccount(username);
                }
            });
            
            // Home screen
            document.getElementById('searchBtn').addEventListener('click', () => {
                UI.showScreen('searchScreen');
                Search.showRecommended();
            });
            
            document.getElementById('requestsBtn').addEventListener('click', () => {
                UI.showScreen('requestsScreen');
                Requests.load();
            });
            
            document.getElementById('profileFab').addEventListener('click', () => {
                Profile.load();
                Profile.loadEdit();
                UI.showScreen('editProfileScreen');
            });
            
            document.getElementById('newChatFab').addEventListener('click', () => {
                UI.showScreen('searchScreen');
                Search.showRecommended();
            });
            
            // Search screen
            document.getElementById('searchBackBtn').addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('searchInput').addEventListener('input', Utils.debounce((e) => {
                Search.searchUsers(e.target.value.trim());
            }, 300));
            
            // Requests screen
            document.getElementById('requestsBackBtn').addEventListener('click', () => UI.showScreen('homeScreen'));
            
            // Chat screen
            document.getElementById('chatBackBtn').addEventListener('click', Chats.close);
            document.getElementById('chatMenuBtn').addEventListener('click', Chats.showOptions);
            document.getElementById('chatHeaderInfo').addEventListener('click', () => {
                if (State.currentChatUser) {
                    Profile.viewUser(State.currentChatUser.uid);
                }
            });
            
            // Message input
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                
                sendBtn.classList.toggle('active', messageInput.value.trim().length > 0);
                
                Chats.setTyping(messageInput.value.length > 0);
            });
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && State.settings.enterToSend) {
                    e.preventDefault();
                    if (State.editingMessage) {
                        Messages.edit(State.editingMessage.id, messageInput.value.trim());
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                        sendBtn.classList.remove('active');
                    } else {
                        Messages.send(messageInput.value.trim());
                    }
                }
            });
            
            sendBtn.addEventListener('click', () => {
                if (State.editingMessage) {
                    Messages.edit(State.editingMessage.id, messageInput.value.trim());
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    sendBtn.classList.remove('active');
                    sendBtn.innerHTML = '<span class="material-icons-round">send</span>';
                } else {
                    Messages.send(messageInput.value.trim());
                }
            });
            
            // Reply bar
            document.getElementById('replyBarClose').addEventListener('click', Messages.cancelReply);
            
            // Emoji button
            document.getElementById('emojiBtn').addEventListener('click', EmojiPicker.toggle);
            
            // Emoji picker
            document.querySelectorAll('.emoji-category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    EmojiPicker.loadCategory(btn.dataset.category);
                });
            });
            
            document.getElementById('emojiGrid').addEventListener('click', (e) => {
                if (e.target.classList.contains('emoji-item')) {
                    EmojiPicker.insert(e.target.dataset.emoji);
                }
            });
            
            document.getElementById('emojiSearch').addEventListener('input', (e) => {
                EmojiPicker.search(e.target.value);
            });
            
            // Attachment button
            document.getElementById('attachBtn').addEventListener('click', () => UI.showActionSheet('attachmentSheet'));
            document.getElementById('attachmentCancelBtn').addEventListener('click', () => UI.hideActionSheet('attachmentSheet'));
            
            document.querySelectorAll('[data-attach]').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.attach;
                    UI.hideActionSheet('attachmentSheet');
                    
                    switch(type) {
                        case 'photo':
                            document.getElementById('imageInput').click();
                            break;
                        case 'video':
                            document.getElementById('videoInput').click();
                            break;
                        case 'document':
                            document.getElementById('fileInput').click();
                            break;
                        case 'camera':
                            document.getElementById('cameraInput').click();
                            break;
                        case 'location':
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(async (pos) => {
                                    await Messages.send(' Shared location', {
                                        location: { lat: pos.coords.latitude, lng: pos.coords.longitude }
                                    });
                                }, () => UI.showToast('Could not get location'));
                            }
                            break;
                    }
                });
            });
            
            // File inputs
            document.getElementById('imageInput').addEventListener('change', (e) => {
                if (e.target.files[0]) Upload.sendMedia(e.target.files[0]);
                e.target.value = '';
            });
            
            document.getElementById('videoInput').addEventListener('change', (e) => {
                if (e.target.files[0]) Upload.sendMedia(e.target.files[0]);
                e.target.value = '';
            });
            
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files[0]) Upload.sendMedia(e.target.files[0]);
                e.target.value = '';
            });
            
            document.getElementById('cameraInput').addEventListener('change', (e) => {
                if (e.target.files[0]) Upload.sendMedia(e.target.files[0]);
                e.target.value = '';
            });
            
            // Avatar upload
            document.getElementById('avatarInput').addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    const url = await Upload.uploadAvatar(e.target.files[0]);
                    if (url) {
                        document.getElementById('editProfileAvatarImg').src = url;
                    }
                }
                e.target.value = '';
            });
            
            document.getElementById('editProfileAvatarBtn')?.addEventListener('click', () => {
                document.getElementById('avatarInput').click();
            });
            
            document.getElementById('profileAvatarEdit')?.addEventListener('click', () => {
                document.getElementById('avatarInput').click();
            });
            
            // Schedule message
            document.getElementById('scheduleBtn').addEventListener('click', () => {
                if (!State.currentChat) return;
                
                // Set default date/time
                const now = new Date();
                now.setMinutes(now.getMinutes() + 30);
                document.getElementById('scheduleDateInput').value = now.toISOString().split('T')[0];
                document.getElementById('scheduleTimeInput').value = now.toTimeString().slice(0, 5);
                document.getElementById('scheduleMessageInput').value = messageInput.value;
                
                UI.showModal('scheduleModal');
            });
            
            document.getElementById('scheduleCancelBtn').addEventListener('click', () => UI.hideModal('scheduleModal'));
            
            document.getElementById('scheduleConfirmBtn').addEventListener('click', async () => {
                const date = document.getElementById('scheduleDateInput').value;
                const time = document.getElementById('scheduleTimeInput').value;
                const text = document.getElementById('scheduleMessageInput').value.trim();
                
                if (!date || !time || !text) {
                    UI.showToast('Please fill all fields');
                    return;
                }
                
                const sendAt = new Date(`${date}T${time}`);
                if (sendAt <= new Date()) {
                    UI.showToast('Please select a future time');
                    return;
                }
                
                await Scheduled.add(State.currentChat.id, State.currentChatUser, text, sendAt);
                UI.hideModal('scheduleModal');
                messageInput.value = '';
                messageInput.style.height = 'auto';
                sendBtn.classList.remove('active');
            });
            
            // Chat options
            document.getElementById('chatOptionsCancelBtn').addEventListener('click', () => UI.hideActionSheet('chatOptionsSheet'));
            
            document.querySelectorAll('[data-chat-action]').forEach(item => {
                item.addEventListener('click', async () => {
                    const action = item.dataset.chatAction;
                    UI.hideActionSheet('chatOptionsSheet');
                    
                    switch(action) {
                        case 'view-profile':
                            if (State.currentChatUser) Profile.viewUser(State.currentChatUser.uid);
                            break;
                        case 'search':
                            UI.showToast('Search messages coming soon');
                            break;
                        case 'mute':
                            await Chats.toggleMute();
                            break;
                        case 'pin':
                            await Chats.togglePin();
                            break;
                        case 'archive':
                            await Chats.toggleArchive();
                            break;
                        case 'wallpaper':
                            UI.showToast('Wallpaper coming soon');
                            break;
                        case 'clear':
                            await Chats.clearMessages();
                            break;
                        case 'block':
                            if (State.currentChatUser) await Profile.block(State.currentChatUser.uid);
                            break;
                    }
                });
            });
            
            // Message context menu
            document.querySelectorAll('[data-msg-action]').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.msgAction;
                    Messages.hideContextMenu();
                    
                    switch(action) {
                        case 'reply':
                            Messages.reply();
                            break;
                        case 'copy':
                            Messages.copy();
                            break;
                        case 'forward':
                            UI.showToast('Forward coming soon');
                            break;
                        case 'star':
                            Messages.star(State.selectedMessage?.id);
                            break;
                        case 'edit':
                            Messages.startEdit();
                            break;
                        case 'delete':
                            if (State.selectedMessage) {
                                const isMine = State.selectedMessage.senderId === State.currentUser.uid;
                                if (isMine && confirm('Delete for everyone?')) {
                                    Messages.delete(State.selectedMessage.id, true);
                                } else {
                                    Messages.delete(State.selectedMessage.id, false);
                                }
                            }
                            break;
                    }
                });
            });
            
            // Quick reactions
            document.querySelectorAll('.quick-reaction-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (State.selectedMessage) {
                        Messages.addReaction(State.selectedMessage.id, btn.dataset.reaction);
                    }
                    Messages.hideContextMenu();
                });
            });
            
            // Profile screens
            document.getElementById('profileBackBtn').addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('editProfileBackBtn').addEventListener('click', () => UI.showScreen('profileScreen'));
            
            document.getElementById('editDisplayName').addEventListener('input', Profile.updateCounters);
            document.getElementById('editBio').addEventListener('input', Profile.updateCounters);
            document.getElementById('saveProfileBtn').addEventListener('click', Profile.save);
            
            document.querySelectorAll('.profile-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    
                    switch(action) {
                        case 'edit-profile':
                            Profile.loadEdit();
                            UI.showScreen('editProfileScreen');
                            break;
                        case 'qrcode':
                            Profile.showQR();
                            break;
                        case 'privacy':
                            Settings.renderPrivacy();
                            UI.showScreen('privacyScreen');
                            break;
                        case 'notifications':
                            Settings.renderNotifications();
                            UI.showScreen('notificationsScreen');
                            break;
                        case 'storage':
                            Settings.renderStorage();
                            UI.showScreen('storageScreen');
                            break;
                        case 'appearance':
                            Settings.renderAppearance();
                            UI.showScreen('appearanceScreen');
                            break;
                        case 'ai-settings':
                            Settings.renderAI();
                            UI.showScreen('aiSettingsScreen');
                            break;
                        case 'blocked':
                            Settings.loadBlockedUsers();
                            UI.showScreen('blockedScreen');
                            break;
                    }
                });
            });
            
            // User profile screen
            document.getElementById('userProfileBackBtn').addEventListener('click', () => UI.showScreen('chatScreen'));
            document.getElementById('userProfileMessageBtn').addEventListener('click', () => {
                const uid = document.getElementById('userProfileScreen').dataset.uid;
                if (uid) {
                    const chatId = Utils.getChatId(State.currentUser.uid, uid);
                    Chats.open(chatId);
                }
            });
            document.getElementById('userProfileBlockBtn').addEventListener('click', () => {
                const uid = document.getElementById('userProfileScreen').dataset.uid;
                if (uid) Profile.block(uid);
            });
            
            // Settings screens back buttons
            document.getElementById('settingsBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('privacyBackBtn')?.addEventListener('click', () => UI.showScreen('profileScreen'));
            document.getElementById('storageBackBtn')?.addEventListener('click', () => UI.showScreen('profileScreen'));
            document.getElementById('appearanceBackBtn')?.addEventListener('click', () => UI.showScreen('profileScreen'));
            document.getElementById('notificationsBackBtn')?.addEventListener('click', () => UI.showScreen('profileScreen'));
            document.getElementById('aiSettingsBackBtn')?.addEventListener('click', () => UI.showScreen('profileScreen'));
            document.getElementById('starredBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('archivedBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('scheduledBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('blockedBackBtn')?.addEventListener('click', () => UI.showScreen('privacyScreen'));
            document.getElementById('helpBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            document.getElementById('aboutBackBtn')?.addEventListener('click', () => UI.showScreen('homeScreen'));
            
            // Modals
            document.getElementById('logoutCancelBtn').addEventListener('click', () => UI.hideModal('logoutModal'));
            document.getElementById('logoutConfirmBtn').addEventListener('click', () => {
                UI.hideModal('logoutModal');
                Auth.signOut();
            });
            
            document.getElementById('deleteCancelBtn').addEventListener('click', () => {
                UI.hideModal('deleteAccountModal');
                document.getElementById('deleteConfirmInput').value = '';
            });
            
            document.getElementById('deleteConfirmInput').addEventListener('input', (e) => {
                document.getElementById('deleteConfirmBtn').disabled = e.target.value !== 'DELETE';
            });
            
            document.getElementById('deleteConfirmBtn').addEventListener('click', () => {
                UI.hideModal('deleteAccountModal');
                Auth.deleteAccount();
            });
            
            document.getElementById('qrCloseBtn').addEventListener('click', () => UI.hideModal('qrModal'));
            document.getElementById('qrShareBtn').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: 'What\'s Up Profile',
                        text: `Add me on What's Up: @${State.userData?.username}`
                    });
                } else {
                    navigator.clipboard.writeText(`@${State.userData?.username}`);
                    UI.showToast('Username copied!');
                }
            });
            
            document.getElementById('optionCancelBtn').addEventListener('click', () => UI.hideModal('optionModal'));
            
            document.getElementById('reportCancelBtn').addEventListener('click', () => UI.hideModal('reportModal'));
            document.getElementById('reportSubmitBtn').addEventListener('click', () => {
                const text = document.getElementById('reportInput').value.trim();
                if (text) {
                    UI.hideModal('reportModal');
                    UI.showToast('Report submitted. Thank you!');
                    document.getElementById('reportInput').value = '';
                }
            });
            
            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // Close action sheets on overlay click
            document.querySelectorAll('.action-sheet-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // Handle online/offline
            window.addEventListener('online', () => {
                UI.showToast('Back online');
                if (State.currentUser) Presence.setup();
            });
            
            window.addEventListener('offline', () => {
                UI.showToast('You\'re offline');
            });
            
            // Handle visibility change
            document.addEventListener('visibilitychange', () => {
                if (State.currentUser) {
                    if (document.hidden) {
                        Presence.setOffline();
                    } else {
                        Presence.setup();
                    }
                }
            });
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
        }

        // ============================================================
        // INITIALIZE APP
        // ============================================================
        function init() {
            console.log(' Initializing What\'s Up...');
            
            initEventListeners();
            EmojiPicker.init();
            Auth.init();
            
            console.log(' App initialized successfully!');
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
